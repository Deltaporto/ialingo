<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Busca de Minutas - STJ</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f7fa;
            color: #333;
            line-height: 1.6;
        }

        .container { max-width: 1400px; margin: 0 auto; padding: 20px; }

        header {
            background: linear-gradient(135deg, #1a365d 0%, #2c5282 100%);
            color: white;
            padding: 20px 0;
            margin-bottom: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        header h1 { text-align: center; font-size: 1.8em; font-weight: 600; }
        header p { text-align: center; opacity: 0.9; margin-top: 5px; }

        .stats-bar { display: flex; gap: 20px; margin-bottom: 25px; flex-wrap: wrap; }

        .stat-card {
            background: white;
            padding: 15px 25px;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            flex: 1;
            min-width: 120px;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .stat-card:hover { transform: translateY(-2px); }
        .stat-card h3 { font-size: 1.8em; color: #2c5282; margin-bottom: 5px; }
        .stat-card p { color: #666; font-size: 0.85em; }

        .main-content { display: grid; grid-template-columns: 1fr 380px; gap: 25px; }

        @media (max-width: 1100px) { .main-content { grid-template-columns: 1fr; } }

        .search-section {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }

        .search-tabs { display: flex; gap: 8px; margin-bottom: 20px; flex-wrap: wrap; }

        .tab-btn {
            padding: 10px 16px;
            border: 2px solid #e2e8f0;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.2s;
        }

        .tab-btn:hover { border-color: #2c5282; color: #2c5282; }
        .tab-btn.active { background: #2c5282; color: white; border-color: #2c5282; }

        .search-box { display: flex; gap: 10px; margin-bottom: 20px; }

        .search-box input {
            flex: 1;
            padding: 14px 18px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            font-size: 1em;
            transition: border-color 0.2s;
        }

        .search-box input:focus { outline: none; border-color: #2c5282; }

        .search-box button {
            padding: 14px 30px;
            background: #2c5282;
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 500;
            transition: background 0.2s;
        }

        .search-box button:hover { background: #1a365d; }

        .search-hints {
            background: #f7fafc;
            padding: 12px 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 0.85em;
            color: #666;
        }

        .search-hints strong { color: #2c5282; }

        /* Categorias Grid */
        .categorias-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 12px;
            margin-bottom: 20px;
        }

        .categoria-card {
            background: #f7fafc;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
        }

        .categoria-card:hover {
            border-color: #2c5282;
            background: white;
            transform: translateY(-2px);
        }

        .categoria-card.selected {
            border-color: #2c5282;
            background: #ebf8ff;
        }

        .categoria-card h4 { font-size: 0.9em; color: #2c5282; margin-bottom: 5px; }
        .categoria-card .count { font-size: 1.5em; font-weight: bold; color: #333; }

        .results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #e2e8f0;
        }

        .results-header h2 { font-size: 1.1em; color: #333; }
        .results-count { color: #666; font-size: 0.9em; }

        .result-card {
            background: #f7fafc;
            border: 1px solid #e2e8f0;
            border-radius: 10px;
            padding: 18px;
            margin-bottom: 12px;
            transition: all 0.2s;
        }

        .result-card:hover {
            border-color: #2c5282;
            box-shadow: 0 3px 12px rgba(44, 82, 130, 0.1);
        }

        .result-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 10px;
        }

        .result-title { font-weight: 600; color: #2c5282; font-size: 1em; }

        .result-type {
            background: #e2e8f0;
            padding: 3px 10px;
            border-radius: 15px;
            font-size: 0.8em;
            color: #555;
        }

        .result-meta { display: flex; gap: 15px; margin-bottom: 10px; flex-wrap: wrap; }
        .result-meta span { font-size: 0.85em; color: #666; }

        .tags { display: flex; gap: 6px; flex-wrap: wrap; margin-top: 10px; }

        .tag {
            background: #2c5282;
            color: white;
            padding: 3px 10px;
            border-radius: 15px;
            font-size: 0.75em;
        }

        .tag.tema { background: #38a169; }
        .tag.categoria { background: #805ad5; }
        .tag.obice { background: #dd6b20; }

        .result-trecho {
            font-size: 0.85em;
            color: #555;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px dashed #e2e8f0;
            max-height: 80px;
            overflow: hidden;
        }

        .sidebar { display: flex; flex-direction: column; gap: 20px; }

        .sidebar-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }

        .sidebar-card h3 {
            font-size: 1em;
            margin-bottom: 15px;
            color: #333;
            padding-bottom: 10px;
            border-bottom: 2px solid #e2e8f0;
        }

        .sumula-list, .precedente-list, .obice-list { list-style: none; }

        .sumula-list li, .precedente-list li, .obice-list li {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #f0f0f0;
            font-size: 0.9em;
            cursor: pointer;
            transition: background 0.2s;
        }

        .sumula-list li:hover, .precedente-list li:hover, .obice-list li:hover {
            background: #f7fafc;
            margin: 0 -10px;
            padding: 8px 10px;
            border-radius: 5px;
        }

        .sumula-list li span:last-child,
        .precedente-list li span:last-child,
        .obice-list li span:last-child {
            background: #e2e8f0;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.8em;
        }

        .btn-indexar {
            width: 100%;
            padding: 12px;
            background: #38a169;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.95em;
            transition: background 0.2s;
        }

        .btn-indexar:hover { background: #2f855a; }
        .btn-indexar:disabled { background: #a0aec0; cursor: not-allowed; }

        .btn-reindexar {
            width: 100%;
            padding: 10px;
            background: #e53e3e;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.85em;
            margin-top: 10px;
            transition: background 0.2s;
        }

        .btn-reindexar:hover { background: #c53030; }

        .loading { text-align: center; padding: 40px; color: #666; }

        .loading::after {
            content: '';
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid #e2e8f0;
            border-top-color: #2c5282;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-left: 10px;
            vertical-align: middle;
        }

        @keyframes spin { to { transform: rotate(360deg); } }

        /* === Indicador de Carregamento Avancado === */
        .loading-avancado {
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            border-radius: 12px;
            padding: 30px;
            margin: 20px 0;
        }

        .loading-header {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            margin-bottom: 25px;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid #e2e8f0;
            border-top-color: #2c5282;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        .loading-titulo {
            font-size: 1.2em;
            font-weight: 600;
            color: #1e3a5f;
        }

        .loading-etapas {
            max-width: 500px;
            margin: 0 auto;
        }

        .loading-etapa {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 15px;
            margin: 8px 0;
            border-radius: 8px;
            transition: all 0.3s ease;
            background: white;
            border: 1px solid #e2e8f0;
        }

        .loading-etapa.ativa {
            background: #ebf5ff;
            border-color: #2c5282;
            box-shadow: 0 2px 8px rgba(44, 82, 130, 0.15);
        }

        .loading-etapa.concluida {
            background: #ecfdf5;
            border-color: #10b981;
        }

        .loading-etapa.pendente {
            opacity: 0.5;
        }

        .etapa-icone {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            flex-shrink: 0;
        }

        .etapa-icone.pendente {
            background: #e2e8f0;
            color: #64748b;
        }

        .etapa-icone.ativa {
            background: #2c5282;
            color: white;
            animation: pulse 1.5s ease-in-out infinite;
        }

        .etapa-icone.concluida {
            background: #10b981;
            color: white;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        @keyframes slideInRight {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideOutRight {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(400px);
                opacity: 0;
            }
        }

        .etapa-texto {
            flex: 1;
            font-size: 0.95em;
        }

        .etapa-texto.ativa {
            color: #1e3a5f;
            font-weight: 500;
        }

        .etapa-texto.concluida {
            color: #065f46;
        }

        .etapa-texto.pendente {
            color: #64748b;
        }

        .loading-tempo {
            text-align: center;
            margin-top: 20px;
            font-size: 0.85em;
            color: #64748b;
        }

        .loading-dica {
            text-align: center;
            margin-top: 15px;
            padding: 10px 20px;
            background: #fffbeb;
            border-radius: 8px;
            font-size: 0.9em;
            color: #92400e;
        }

        /* === Edição de Questões === */
        .questoes-editaveis {
            background: #f8fafc;
            border-radius: 8px;
            padding: 15px;
        }

        .questao-editavel {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            padding: 12px;
            margin: 8px 0;
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            transition: all 0.2s;
        }

        .questao-editavel:hover {
            border-color: #2c5282;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .questao-editavel .questao-num {
            background: #2c5282;
            color: white;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8em;
            font-weight: 600;
            flex-shrink: 0;
        }

        .questao-editavel .questao-content {
            flex: 1;
            min-width: 0;
        }

        .questao-editavel input[type="text"] {
            width: 100%;
            padding: 8px 10px;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            font-size: 0.95em;
            margin-bottom: 6px;
        }

        .questao-editavel input[type="text"]:focus {
            outline: none;
            border-color: #2c5282;
            box-shadow: 0 0 0 2px rgba(44, 82, 130, 0.1);
        }

        .questao-editavel .questao-obice {
            font-size: 0.85em;
            color: #666;
        }

        .questao-editavel .btn-remover {
            background: none;
            border: none;
            color: #e53e3e;
            cursor: pointer;
            padding: 5px;
            opacity: 0.6;
            transition: opacity 0.2s;
        }

        .questao-editavel .btn-remover:hover {
            opacity: 1;
        }

        .btn-adicionar-questao {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            width: 100%;
            padding: 12px;
            margin-top: 10px;
            background: transparent;
            border: 2px dashed #cbd5e0;
            border-radius: 8px;
            color: #64748b;
            font-size: 0.9em;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-adicionar-questao:hover {
            border-color: #2c5282;
            color: #2c5282;
            background: #f0f7ff;
        }

        .questoes-acoes {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            justify-content: flex-end;
        }

        .btn-rebuscar {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 20px;
            background: #2c5282;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 0.9em;
            cursor: pointer;
            transition: background 0.2s;
        }

        .btn-rebuscar:hover {
            background: #1e3a5f;
        }

        .btn-rebuscar:disabled {
            background: #94a3b8;
            cursor: not-allowed;
        }

        .questoes-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .questoes-header h4 {
            margin: 0;
        }

        .btn-toggle-edicao {
            background: none;
            border: 1px solid #cbd5e0;
            padding: 5px 12px;
            border-radius: 4px;
            font-size: 0.85em;
            color: #64748b;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .btn-toggle-edicao:hover {
            border-color: #2c5282;
            color: #2c5282;
        }

        .btn-toggle-edicao.ativo {
            background: #2c5282;
            border-color: #2c5282;
            color: white;
        }

        /* === Indicador de Confiança === */
        .confianca-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.75em;
            font-weight: 500;
            margin-left: 8px;
        }

        .confianca-alta {
            background: #dcfce7;
            color: #166534;
        }

        .confianca-media {
            background: #fef9c3;
            color: #854d0e;
        }

        .confianca-baixa {
            background: #fee2e2;
            color: #991b1b;
        }

        .confianca-bar {
            width: 40px;
            height: 4px;
            background: #e2e8f0;
            border-radius: 2px;
            overflow: hidden;
        }

        .confianca-bar-fill {
            height: 100%;
            border-radius: 2px;
            transition: width 0.3s;
        }

        .confianca-bar-fill.alta {
            background: #22c55e;
        }

        .confianca-bar-fill.media {
            background: #eab308;
        }

        .confianca-bar-fill.baixa {
            background: #ef4444;
        }

        .questao-badge .confianca-badge {
            margin-left: auto;
            flex-shrink: 0;
        }

        /* === Banco de Precedentes === */
        .banco-prec-container {
            padding: 10px 0;
        }

        .banco-prec-tabs {
            display: flex;
            gap: 10px;
            margin: 15px 0;
            border-bottom: 2px solid #e2e8f0;
            padding-bottom: 10px;
        }

        .banco-tab-btn {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 8px 16px;
            border: none;
            background: #f1f5f9;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9em;
            color: #64748b;
            transition: all 0.2s;
        }

        .banco-tab-btn:hover {
            background: #e2e8f0;
            color: #334155;
        }

        .banco-tab-btn.active {
            background: #805ad5;
            color: white;
        }

        .banco-subtab {
            margin-top: 15px;
        }

        .banco-acoes {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .prec-preview {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
        }

        .prec-preview h4 {
            color: #805ad5;
            margin-bottom: 12px;
            font-size: 0.95em;
        }

        .prec-dados-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }

        .prec-campo {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .prec-campo label {
            font-size: 0.8em;
            color: #64748b;
            font-weight: 500;
        }

        .prec-campo span {
            font-size: 0.95em;
            color: #1e293b;
        }

        .prec-input-edit {
            padding: 8px 10px;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            font-size: 0.9em;
            width: 100%;
        }

        .prec-input-edit:focus {
            outline: none;
            border-color: #805ad5;
        }

        .prec-filtros {
            display: flex;
            gap: 10px;
            margin: 15px 0;
        }

        .prec-filtros select {
            padding: 8px 12px;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            font-size: 0.9em;
            min-width: 150px;
        }

        .prec-lista {
            margin-top: 15px;
        }

        .prec-card {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .prec-card:hover {
            border-color: #805ad5;
            box-shadow: 0 2px 8px rgba(128, 90, 213, 0.1);
        }

        .prec-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 10px;
        }

        .prec-card-numero {
            font-weight: 600;
            color: #1e293b;
        }

        .prec-card-data {
            font-size: 0.8em;
            color: #64748b;
        }

        .prec-card-tema {
            display: inline-block;
            background: #f3e8ff;
            color: #7c3aed;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 0.8em;
            margin-bottom: 8px;
        }

        .prec-card-ementa {
            font-size: 0.9em;
            color: #475569;
            line-height: 1.5;
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .prec-card-footer {
            display: flex;
            gap: 8px;
            margin-top: 10px;
            flex-wrap: wrap;
        }

        .prec-card-obice {
            background: #fef3c7;
            color: #92400e;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.75em;
        }

        .prec-card-similaridade {
            background: #dcfce7;
            color: #166534;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.75em;
        }

        .stats-prec-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .stats-prec-card {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 10px;
            padding: 15px;
        }

        .stats-prec-card h5 {
            color: #64748b;
            font-size: 0.85em;
            margin-bottom: 10px;
        }

        .stats-prec-card .stat-value {
            font-size: 2em;
            font-weight: 600;
            color: #805ad5;
        }

        .stats-prec-lista {
            margin-top: 8px;
        }

        .stats-prec-item {
            display: flex;
            justify-content: space-between;
            padding: 4px 0;
            font-size: 0.85em;
            border-bottom: 1px solid #f1f5f9;
        }

        .stats-prec-item:last-child {
            border-bottom: none;
        }

        .empty-state { text-align: center; padding: 40px; color: #666; }

        .precedente-detail {
            background: #f7fafc;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
        }

        .precedente-detail h4 { color: #2c5282; margin-bottom: 10px; }
        .precedente-detail ul { list-style: none; font-size: 0.9em; }
        .precedente-detail ul li { padding: 5px 0; border-bottom: 1px solid #e2e8f0; }

        /* Cores das categorias */
        .cat-responsabilidade { border-left: 4px solid #e53e3e; }
        .cat-contratos { border-left: 4px solid #38a169; }
        .cat-imobiliario { border-left: 4px solid #3182ce; }
        .cat-bancario { border-left: 4px solid #d69e2e; }
        .cat-consumidor { border-left: 4px solid #805ad5; }
        .cat-societario { border-left: 4px solid #319795; }
        .cat-familia { border-left: 4px solid #d53f8c; }
        .cat-execucao { border-left: 4px solid #dd6b20; }

        /* Modal de visualização */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.6);
            z-index: 1000;
            overflow-y: auto;
        }

        .modal-overlay.active { display: flex; justify-content: center; padding: 20px; }

        .modal-content {
            background: white;
            border-radius: 12px;
            max-width: 1000px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 25px;
            border-bottom: 1px solid #e2e8f0;
            background: #f7fafc;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .modal-header h2 { font-size: 1.2em; color: #2c5282; margin: 0; }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.8em;
            cursor: pointer;
            color: #666;
            padding: 0 10px;
        }

        .modal-close:hover { color: #e53e3e; }

        .modal-body { padding: 25px; }

        .modal-section {
            margin-bottom: 25px;
            padding-bottom: 20px;
            border-bottom: 1px solid #e2e8f0;
        }

        .modal-section:last-child { border-bottom: none; }

        .modal-section h3 {
            font-size: 1em;
            color: #2c5282;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .modal-section h3::before {
            content: '';
            width: 4px;
            height: 18px;
            background: #2c5282;
            border-radius: 2px;
        }

        .modal-meta {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .modal-meta-item {
            background: #f7fafc;
            padding: 12px 15px;
            border-radius: 8px;
        }

        .modal-meta-item label { font-size: 0.8em; color: #666; display: block; margin-bottom: 4px; }
        .modal-meta-item span { font-weight: 600; color: #333; }

        .conteudo-texto {
            background: #f7fafc;
            padding: 20px;
            border-radius: 8px;
            font-size: 0.9em;
            line-height: 1.8;
            max-height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
        }

        .conteudo-texto mark {
            background: #fef3c7;
            padding: 1px 3px;
            border-radius: 2px;
        }

        /* Seção de Relevância no Modal */
        .modal-relevancia {
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            border-left: 4px solid #0ea5e9;
            padding: 15px 20px;
            margin-bottom: 20px;
            border-radius: 0 8px 8px 0;
        }

        .modal-relevancia h4 {
            color: #0369a1;
            margin: 0 0 12px 0;
            font-size: 0.95em;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .modal-relevancia ul {
            margin: 0;
            padding-left: 0;
            list-style: none;
        }

        .modal-relevancia li {
            color: #334155;
            margin-bottom: 6px;
            padding-left: 22px;
            position: relative;
            font-size: 0.9em;
        }

        .modal-relevancia li::before {
            content: "\2713";
            color: #10b981;
            font-weight: bold;
            position: absolute;
            left: 0;
        }

        /* Trechos relevantes */
        .trechos-relevantes {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .trechos-relevantes h5 {
            color: #475569;
            margin: 0 0 12px 0;
            font-size: 0.85em;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .trecho-item {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            padding: 12px;
            margin-bottom: 10px;
        }

        .trecho-item:last-child {
            margin-bottom: 0;
        }

        .trecho-secao {
            font-size: 0.75em;
            color: #64748b;
            text-transform: uppercase;
            margin-bottom: 6px;
            display: inline-block;
            background: #e2e8f0;
            padding: 2px 8px;
            border-radius: 4px;
        }

        .trecho-texto {
            font-size: 0.9em;
            color: #334155;
            line-height: 1.5;
        }

        .trecho-texto mark {
            background: #fef08a;
            padding: 1px 4px;
            border-radius: 2px;
            font-weight: 500;
        }

        .modal-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .btn-action {
            padding: 10px 18px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .btn-primary { background: #2c5282; color: white; }
        .btn-primary:hover { background: #1a365d; }

        .btn-secondary { background: #e2e8f0; color: #333; }
        .btn-secondary:hover { background: #cbd5e0; }

        .btn-success { background: #38a169; color: white; }
        .btn-success:hover { background: #2f855a; }

        /* Tabs de conteúdo do modal */
        .content-tabs {
            display: flex;
            gap: 5px;
            margin-bottom: 15px;
            border-bottom: 2px solid #e2e8f0;
            padding-bottom: 10px;
        }

        .content-tab {
            padding: 8px 16px;
            border: none;
            background: none;
            cursor: pointer;
            font-size: 0.9em;
            color: #666;
            border-radius: 6px 6px 0 0;
            transition: all 0.2s;
        }

        .content-tab:hover { background: #f7fafc; color: #2c5282; }
        .content-tab.active { background: #2c5282; color: white; }

        .content-panel { display: none; }
        .content-panel.active { display: block; }

        /* Minutas similares */
        .similares-list { list-style: none; }

        .similares-list li {
            padding: 10px;
            background: #f7fafc;
            border-radius: 6px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .similares-list li:hover { background: #e2e8f0; }

        .similares-list li .score {
            float: right;
            background: #2c5282;
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.8em;
        }

        /* Exportação */
        .export-buttons {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-top: 10px;
        }

        .btn-export {
            padding: 8px 14px;
            border: 1px solid #e2e8f0;
            background: white;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85em;
            transition: all 0.2s;
        }

        .btn-export:hover { border-color: #2c5282; color: #2c5282; }

        /* Modo de busca */
        .search-mode {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            align-items: center;
        }

        .search-mode label { font-size: 0.85em; color: #666; }

        .search-mode select {
            padding: 6px 12px;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            font-size: 0.9em;
        }

        .embeddings-status {
            font-size: 0.8em;
            padding: 4px 10px;
            border-radius: 15px;
        }

        .embeddings-status.active { background: #c6f6d5; color: #22543d; }
        .embeddings-status.inactive { background: #fed7d7; color: #742a2a; }

        /* Clicável */
        .result-card.clickable { cursor: pointer; }
        .result-card.clickable:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(44, 82, 130, 0.15); }

        /* Filtros combinados */
        .filtros-combinados {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .filtro-grupo {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .filtro-grupo label {
            font-size: 0.85em;
            font-weight: 600;
            color: #333;
        }

        .filtro-grupo select, .filtro-grupo input {
            padding: 10px 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 0.9em;
            background: white;
            transition: border-color 0.2s;
        }

        .filtro-grupo select:focus, .filtro-grupo input:focus {
            outline: none;
            border-color: #2c5282;
        }

        .filtro-texto { grid-column: span 2; }

        @media (max-width: 600px) {
            .filtro-texto { grid-column: span 1; }
        }

        .filtros-acoes {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .filtros-ativos {
            background: #ebf8ff;
            padding: 10px 15px;
            border-radius: 8px;
            font-size: 0.85em;
            margin-bottom: 15px;
        }

        .filtros-ativos strong { color: #2c5282; }

        .filtros-ativos .tag-filtro {
            display: inline-block;
            background: #2c5282;
            color: white;
            padding: 2px 10px;
            border-radius: 15px;
            margin: 2px 4px;
            font-size: 0.85em;
        }

        /* Resultado badge */
        .resultado-badge {
            display: inline-block;
            padding: 3px 10px;
            border-radius: 15px;
            font-size: 0.75em;
            font-weight: 600;
        }

        .resultado-badge.nao-conhecido { background: #fed7d7; color: #742a2a; }
        .resultado-badge.desprovido { background: #feebc8; color: #744210; }
        .resultado-badge.provido { background: #c6f6d5; color: #22543d; }
        .resultado-badge.parcial { background: #e9d8fd; color: #44337a; }

        /* Óbice detalhado */
        .obice-detalhe {
            background: #f7fafc;
            border-left: 3px solid #dd6b20;
            padding: 8px 12px;
            margin: 5px 0;
            border-radius: 0 6px 6px 0;
            font-size: 0.85em;
        }

        .obice-detalhe .obice-nome { font-weight: 600; color: #2c5282; }
        .obice-detalhe .obice-cat { color: #666; font-size: 0.9em; }

        /* Cards expandidos */
        .result-card-expandido {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            margin-bottom: 20px;
            overflow: hidden;
            transition: all 0.2s;
        }

        .result-card-expandido:hover {
            border-color: #2c5282;
            box-shadow: 0 4px 15px rgba(44, 82, 130, 0.12);
        }

        .result-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            padding: 15px 20px;
            background: #f7fafc;
            border-bottom: 1px solid #e2e8f0;
            cursor: pointer;
        }

        .result-card-header:hover { background: #edf2f7; }

        .result-card-info { flex: 1; }
        .result-card-info h4 { color: #2c5282; font-size: 1em; margin-bottom: 5px; }
        .result-card-info .meta { font-size: 0.85em; color: #666; }

        .result-card-badges { display: flex; gap: 8px; align-items: center; }

        .result-card-body { padding: 20px; }

        .result-section {
            margin-bottom: 18px;
            padding-bottom: 15px;
            border-bottom: 1px dashed #e2e8f0;
        }

        .result-section:last-child { border-bottom: none; margin-bottom: 0; padding-bottom: 0; }

        .result-section-title {
            font-size: 0.75em;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: #718096;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .result-section-content {
            font-size: 0.9em;
            line-height: 1.7;
            color: #333;
        }

        .result-section-content.ementa {
            background: #fffbeb;
            padding: 12px 15px;
            border-radius: 8px;
            border-left: 4px solid #d69e2e;
        }

        .result-section-content.trecho {
            background: #f7fafc;
            padding: 12px 15px;
            border-radius: 8px;
            max-height: 200px;
            overflow-y: auto;
        }

        .result-section-content.dispositivo {
            background: #f0fff4;
            padding: 12px 15px;
            border-radius: 8px;
            border-left: 4px solid #38a169;
            font-weight: 500;
        }

        .result-section-content mark {
            background: #fef3c7;
            padding: 1px 4px;
            border-radius: 3px;
            font-weight: 500;
        }

        .result-obices-row {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .result-card-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 20px;
            background: #f7fafc;
            border-top: 1px solid #e2e8f0;
        }

        .result-card-footer .tags { margin: 0; }

        .btn-ver-completo {
            padding: 8px 16px;
            background: #2c5282;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85em;
            transition: background 0.2s;
        }

        .btn-ver-completo:hover { background: #1a365d; }

        /* Toggle de visualização */
        .view-toggle {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
            padding: 10px 15px;
            background: #f7fafc;
            border-radius: 8px;
        }

        .view-toggle label { font-size: 0.85em; color: #666; }

        .toggle-switch {
            position: relative;
            width: 50px;
            height: 26px;
        }

        .toggle-switch input { opacity: 0; width: 0; height: 0; }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0; left: 0; right: 0; bottom: 0;
            background: #cbd5e0;
            transition: 0.3s;
            border-radius: 26px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 3px;
            bottom: 3px;
            background: white;
            transition: 0.3s;
            border-radius: 50%;
        }

        .toggle-switch input:checked + .toggle-slider { background: #2c5282; }
        .toggle-switch input:checked + .toggle-slider:before { transform: translateX(24px); }

        .view-toggle .toggle-label {
            font-size: 0.85em;
            color: #333;
            font-weight: 500;
        }

        /* Visualização compacta */
        .result-card-compacto .result-card-body { display: none; }
        .result-card-compacto .result-card-footer { border-top: none; }

        /* ============================================
           SUGESTOR DE PARADIGMAS
           ============================================ */

        .paradigmas-container {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .texto-input-area {
            width: 100%;
            min-height: 250px;
            padding: 15px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            font-family: inherit;
            font-size: 0.9em;
            line-height: 1.6;
            resize: vertical;
            transition: border-color 0.2s;
        }

        .texto-input-area:focus {
            outline: none;
            border-color: #2c5282;
        }

        .texto-input-area::placeholder {
            color: #a0aec0;
        }

        .btn-analisar {
            padding: 14px 30px;
            background: linear-gradient(135deg, #2c5282 0%, #1a365d 100%);
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .btn-analisar:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(44, 82, 130, 0.3);
        }

        .btn-analisar:disabled {
            background: #a0aec0;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        /* Análise do documento */
        .analise-resultado {
            background: white;
            border-radius: 12px;
            padding: 20px;
            border: 1px solid #e2e8f0;
        }

        .analise-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e2e8f0;
        }

        .analise-header h3 {
            margin: 0;
            color: #2c5282;
            font-size: 1.1em;
        }

        .analise-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
        }

        .analise-section {
            background: #f7fafc;
            border-radius: 10px;
            padding: 15px;
        }

        .analise-section h4 {
            font-size: 0.85em;
            color: #666;
            margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .analise-section h4::before {
            content: '';
            width: 4px;
            height: 16px;
            border-radius: 2px;
        }

        .analise-section.temas h4::before { background: #805ad5; }
        .analise-section.questoes h4::before { background: #38a169; }
        .analise-section.obices h4::before { background: #dd6b20; }

        .analise-items {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .analise-item {
            background: white;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            border: 1px solid #e2e8f0;
        }

        .analise-item.tema { border-color: #805ad5; color: #553c9a; }
        .analise-item.questao { border-color: #38a169; color: #276749; }

        .obice-sugerido {
            background: white;
            padding: 10px 15px;
            border-radius: 8px;
            margin-bottom: 8px;
            border-left: 4px solid #dd6b20;
        }

        .obice-sugerido .obice-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
        }

        .obice-sugerido .obice-nome {
            font-weight: 600;
            color: #2c5282;
        }

        .obice-sugerido .obice-prob {
            background: #dd6b20;
            color: white;
            padding: 2px 10px;
            border-radius: 15px;
            font-size: 0.8em;
            font-weight: 600;
        }

        .obice-sugerido .obice-desc {
            font-size: 0.85em;
            color: #666;
        }

        .obice-sugerido .obice-indicadores {
            font-size: 0.75em;
            color: #888;
            margin-top: 5px;
            font-style: italic;
        }

        /* Paradigmas sugeridos */
        .paradigmas-lista {
            margin-top: 25px;
        }

        .paradigmas-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e2e8f0;
        }

        .paradigmas-header h3 {
            margin: 0;
            color: #2c5282;
            font-size: 1.1em;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* === Estilos para Painel de Historico (Fase 4) === */
        .historico-sugestoes-painel {
            background: linear-gradient(135deg, #059669 0%, #10b981 100%);
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
            color: white;
        }

        .historico-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
        }

        .historico-header h3 {
            margin: 0;
            font-size: 1.2em;
            display: flex;
            align-items: center;
        }

        .historico-meta {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .historico-badge {
            background: rgba(255,255,255,0.2);
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85em;
        }

        .historico-desc {
            color: rgba(255,255,255,0.8);
            font-size: 0.9em;
            margin: 10px 0 15px 0;
        }

        .historico-lista {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .historico-card {
            background: white;
            border-radius: 8px;
            padding: 15px;
            color: #333;
            border-left: 4px solid #10b981;
        }

        .historico-card.historico-destaque {
            border-left-color: #059669;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .historico-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .historico-score {
            background: linear-gradient(135deg, #059669, #10b981);
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 600;
        }

        .historico-arquivo {
            color: #666;
            font-size: 0.9em;
            font-family: monospace;
        }

        .historico-tese {
            margin-bottom: 12px;
            line-height: 1.5;
            color: #1f2937;
        }

        .historico-obices, .historico-docbase, .historico-dispositivo, .historico-termos {
            margin: 8px 0;
            font-size: 0.9em;
            color: #4b5563;
        }

        .obice-tag {
            display: inline-block;
            background: #fee2e2;
            color: #991b1b;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.85em;
            margin: 2px 4px 2px 0;
        }

        .termo-tag {
            display: inline-block;
            background: #dbeafe;
            color: #1e40af;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.85em;
            margin: 2px 4px 2px 0;
        }

        .historico-acoes {
            display: flex;
            gap: 10px;
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid #e5e7eb;
        }

        .btn-historico {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.2s;
            background: #f3f4f6;
            color: #374151;
        }

        .btn-historico:hover {
            background: #e5e7eb;
        }

        .btn-historico.btn-copiar-tese {
            background: #10b981;
            color: white;
        }

        .btn-historico.btn-copiar-tese:hover {
            background: #059669;
        }

        /* === Estilos para Painel de Busca STJ === */
        .stj-busca-painel {
            background: linear-gradient(135deg, #1e3a5f 0%, #2c5282 100%);
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
            color: white;
        }

        .stj-busca-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
        }

        .stj-busca-header h3 {
            margin: 0;
            font-size: 1.2em;
            display: flex;
            align-items: center;
        }

        .stj-busca-meta {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .stj-badge {
            background: rgba(255,255,255,0.2);
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85em;
        }

        .stj-busca-desc {
            color: rgba(255,255,255,0.8);
            font-size: 0.9em;
            margin: 10px 0 15px 0;
        }

        .stj-estrategias {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .stj-estrategia-card {
            background: white;
            border-radius: 8px;
            padding: 15px;
            color: #333;
        }

        .stj-estrategia-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
        }

        .stj-tipo-badge {
            padding: 3px 10px;
            border-radius: 4px;
            font-size: 0.75em;
            font-weight: 600;
            text-transform: uppercase;
        }

        .stj-tipo-badge.stj-tipo-sumula {
            background: #fef3c7;
            color: #92400e;
        }

        .stj-tipo-badge.stj-tipo-legislacao {
            background: #dbeafe;
            color: #1e40af;
        }

        .stj-tipo-badge.stj-tipo-obice {
            background: #fee2e2;
            color: #991b1b;
        }

        .stj-tipo-badge.stj-tipo-tema {
            background: #d1fae5;
            color: #065f46;
        }

        .stj-tipo-badge.stj-tipo-tese {
            background: #ede9fe;
            color: #5b21b6;
        }

        .stj-estrategia-titulo {
            font-weight: 600;
            color: #1e3a5f;
        }

        .stj-estrategia-desc {
            font-size: 0.85em;
            color: #666;
            margin: 0 0 10px 0;
        }

        .stj-string-busca {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            padding: 10px 12px;
            margin-bottom: 12px;
            overflow-x: auto;
        }

        .stj-string-busca code {
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 0.9em;
            color: #1e3a5f;
            word-break: break-all;
        }

        .stj-acoes {
            display: flex;
            gap: 10px;
        }

        .stj-btn {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 0.85em;
            font-weight: 500;
            cursor: pointer;
            border: none;
            transition: all 0.2s;
        }

        .stj-btn-copiar {
            background: #e2e8f0;
            color: #475569;
        }

        .stj-btn-copiar:hover {
            background: #cbd5e1;
        }

        .stj-btn-pesquisar {
            background: linear-gradient(135deg, #2c5282 0%, #1e3a5f 100%);
            color: white;
        }

        .stj-btn-pesquisar:hover {
            background: linear-gradient(135deg, #1e3a5f 0%, #1a365d 100%);
            transform: translateY(-1px);
        }

        /* Estilos para organização por questão */
        .stj-questao-section {
            background: rgba(255,255,255,0.05);
            border-radius: 10px;
            margin-bottom: 15px;
            overflow: hidden;
        }

        .stj-questao-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 15px;
            background: rgba(255,255,255,0.1);
            cursor: pointer;
            transition: background 0.2s;
        }

        .stj-questao-header:hover {
            background: rgba(255,255,255,0.15);
        }

        .stj-questao-info {
            display: flex;
            align-items: center;
            gap: 10px;
            flex: 1;
        }

        .stj-questao-num {
            background: #38a169;
            color: white;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.8em;
            font-weight: 600;
        }

        .stj-questao-titulo {
            font-weight: 500;
            font-size: 0.95em;
            color: white;
        }

        .stj-questao-meta {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .stj-questao-count {
            font-size: 0.85em;
            color: rgba(255,255,255,0.7);
        }

        .stj-questao-estrategias {
            padding: 15px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        /* Novos tipos de estratégia */
        .stj-tipo-badge.stj-tipo-especifica {
            background: #fef3c7;
            color: #92400e;
        }

        .stj-tipo-badge.stj-tipo-moderada {
            background: #dbeafe;
            color: #1e40af;
        }

        .stj-tipo-badge.stj-tipo-ampla {
            background: #d1fae5;
            color: #065f46;
        }

        .stj-tipo-badge.stj-tipo-variacao {
            background: #e5e7eb;
            color: #374151;
        }

        /* === Fim estilos STJ === */

        .paradigma-card {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            margin-bottom: 15px;
            overflow: hidden;
            transition: all 0.2s;
        }

        .paradigma-card:hover {
            border-color: #2c5282;
            box-shadow: 0 4px 15px rgba(44, 82, 130, 0.1);
        }

        .paradigma-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            padding: 15px 20px;
            background: linear-gradient(to right, #f7fafc, #edf2f7);
            border-bottom: 1px solid #e2e8f0;
        }

        .paradigma-info h4 {
            color: #2c5282;
            margin: 0 0 5px 0;
            font-size: 1em;
        }

        .paradigma-info .meta {
            font-size: 0.85em;
            color: #666;
        }

        .paradigma-aderencia {
            text-align: right;
        }

        .aderencia-valor {
            font-size: 1.8em;
            font-weight: 700;
            color: #2c5282;
            line-height: 1;
        }

        .aderencia-label {
            font-size: 0.75em;
            color: #666;
            text-transform: uppercase;
        }

        .paradigma-motivos {
            padding: 15px 20px;
            background: #fffbeb;
            border-bottom: 1px solid #e2e8f0;
        }

        .paradigma-motivos h5 {
            font-size: 0.75em;
            color: #92400e;
            margin: 0 0 10px 0;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .motivo-item {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            background: white;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            margin: 3px;
            border: 1px solid #fcd34d;
        }

        .motivo-item::before {
            content: '✓';
            color: #059669;
            font-weight: bold;
        }

        .paradigma-body {
            padding: 20px;
        }

        .paradigma-ementa {
            background: #f7fafc;
            padding: 15px;
            border-radius: 8px;
            font-size: 0.9em;
            line-height: 1.7;
            color: #333;
            max-height: 150px;
            overflow-y: auto;
            border-left: 4px solid #2c5282;
        }

        .paradigma-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            background: #f7fafc;
            border-top: 1px solid #e2e8f0;
        }

        .paradigma-tags {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
        }

        .paradigma-acoes {
            display: flex;
            gap: 8px;
        }

        .btn-paradigma {
            padding: 8px 16px;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            font-size: 0.85em;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .btn-paradigma.primary {
            background: #2c5282;
            color: white;
        }

        .btn-paradigma.primary:hover {
            background: #1a365d;
        }

        .btn-paradigma.secondary {
            background: #e2e8f0;
            color: #333;
        }

        .btn-paradigma.secondary:hover {
            background: #cbd5e0;
        }

        .btn-paradigma.comparar {
            background: #38a169;
            color: white;
        }

        .btn-paradigma.comparar:hover {
            background: #2f855a;
        }

        /* Modal de comparação lado a lado */
        .modal-comparacao {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 2000;
            overflow-y: auto;
        }

        .modal-comparacao.active {
            display: flex;
            justify-content: center;
            padding: 20px;
        }

        .comparacao-content {
            background: white;
            border-radius: 12px;
            width: 100%;
            max-width: 1600px;
            max-height: 95vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .comparacao-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 25px;
            background: linear-gradient(135deg, #1a365d 0%, #2c5282 100%);
            color: white;
        }

        .comparacao-header h2 {
            margin: 0;
            font-size: 1.2em;
        }

        .comparacao-close {
            background: none;
            border: none;
            color: white;
            font-size: 1.8em;
            cursor: pointer;
            padding: 0 10px;
        }

        .comparacao-close:hover {
            color: #fcd34d;
        }

        .comparacao-body {
            display: grid;
            grid-template-columns: 1fr 1fr;
            flex: 1;
            overflow: hidden;
        }

        @media (max-width: 1000px) {
            .comparacao-body {
                grid-template-columns: 1fr;
            }
        }

        .comparacao-lado {
            display: flex;
            flex-direction: column;
            overflow: hidden;
            border-right: 1px solid #e2e8f0;
        }

        .comparacao-lado:last-child {
            border-right: none;
        }

        .lado-header {
            padding: 12px 20px;
            background: #f7fafc;
            border-bottom: 1px solid #e2e8f0;
            font-weight: 600;
            color: #2c5282;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .lado-header .badge {
            background: #2c5282;
            color: white;
            padding: 3px 10px;
            border-radius: 15px;
            font-size: 0.75em;
            font-weight: normal;
        }

        .lado-content {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }

        .lado-content .conteudo-texto {
            white-space: pre-wrap;
            font-size: 0.9em;
            line-height: 1.8;
        }

        .lado-tabs {
            display: flex;
            gap: 5px;
            padding: 10px 20px;
            background: #edf2f7;
            border-bottom: 1px solid #e2e8f0;
        }

        .lado-tab {
            padding: 6px 14px;
            border: none;
            background: white;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85em;
            color: #666;
            transition: all 0.2s;
        }

        .lado-tab:hover {
            background: #e2e8f0;
        }

        .lado-tab.active {
            background: #2c5282;
            color: white;
        }

        .termos-destaque {
            padding: 10px 20px;
            background: #fffbeb;
            border-bottom: 1px solid #fcd34d;
            font-size: 0.85em;
        }

        .termos-destaque strong {
            color: #92400e;
        }

        .termos-destaque .termo {
            background: #fef3c7;
            padding: 2px 8px;
            border-radius: 4px;
            margin: 0 3px;
        }

        /* Scores detalhados */
        .scores-detalhe {
            display: flex;
            gap: 15px;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px dashed #e2e8f0;
        }

        .score-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            font-size: 0.75em;
        }

        .score-item .valor {
            font-weight: 600;
            color: #2c5282;
        }

        .score-item .label {
            color: #888;
        }

        /* Progress bar para aderência */
        .aderencia-bar {
            width: 100%;
            height: 6px;
            background: #e2e8f0;
            border-radius: 3px;
            margin-top: 5px;
            overflow: hidden;
        }

        .aderencia-bar-fill {
            height: 100%;
            border-radius: 3px;
            transition: width 0.3s ease;
        }

        .aderencia-alta .aderencia-bar-fill { background: #38a169; }
        .aderencia-media .aderencia-bar-fill { background: #d69e2e; }
        .aderencia-baixa .aderencia-bar-fill { background: #e53e3e; }

        /* Texto da auditoria */
        .auditoria-texto {
            margin-top: 6px;
            font-size: 0.85em;
            color: #4a5568;
        }

        /* ============================================
           PARADIGMAS POR QUESTAO - NOVOS ESTILOS
           ============================================ */

        .questoes-identificadas {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
        }

        .questao-badge {
            display: flex;
            align-items: center;
            gap: 10px;
            background: white;
            border: 2px solid #2c5282;
            border-radius: 10px;
            padding: 10px 15px;
            flex: 1;
            min-width: 280px;
        }

        .questao-badge .questao-num {
            background: #2c5282;
            color: white;
            padding: 4px 10px;
            border-radius: 6px;
            font-weight: bold;
            font-size: 0.85em;
        }

        .questao-badge .questao-titulo {
            font-weight: 600;
            color: #2c5282;
        }

        .questao-badge .questao-desc {
            font-size: 0.8em;
            color: #666;
            margin-left: auto;
        }

        /* Secoes de questao */
        .paradigmas-por-questao {
            margin-top: 25px;
        }

        .questao-section {
            margin-bottom: 20px;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            overflow: hidden;
        }

        .questao-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            background: linear-gradient(to right, #2c5282, #1a365d);
            color: white;
            cursor: pointer;
            transition: background 0.2s;
        }

        .questao-header:hover {
            background: linear-gradient(to right, #1a365d, #2c5282);
        }

        .questao-titulo-header {
            display: flex;
            align-items: center;
            gap: 12px;
            flex-wrap: wrap;
        }

        .questao-numero {
            background: rgba(255,255,255,0.2);
            padding: 4px 12px;
            border-radius: 6px;
            font-size: 0.85em;
            font-weight: 600;
        }

        .questao-titulo-header h4 {
            margin: 0;
            font-size: 1em;
        }

        .questao-subtitulo {
            font-size: 0.85em;
            opacity: 0.85;
        }

        .questao-meta {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .paradigmas-count {
            background: rgba(255,255,255,0.2);
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 0.85em;
        }

        .toggle-icon {
            font-size: 0.9em;
            transition: transform 0.2s;
        }

        .questao-paradigmas {
            padding: 15px;
            background: #f7fafc;
        }

        /* Paradigma simples (dentro de questao) */
        .paradigma-simples {
            margin-bottom: 12px;
        }

        .paradigma-simples:last-child {
            margin-bottom: 0;
        }

        .paradigma-simples .paradigma-header {
            padding: 12px 15px;
        }

        .paradigma-simples .paradigma-motivos {
            padding: 10px 15px;
        }

        .paradigma-simples .paradigma-body {
            padding: 15px;
        }

        .paradigma-simples .paradigma-ementa {
            max-height: 100px;
        }

        .paradigma-simples .paradigma-footer {
            padding: 10px 15px;
        }

        /* Paradigma completo */
        .paradigmas-completos {
            margin-bottom: 30px;
        }

        .paradigma-completo .motivo-item {
            background: #fef3c7;
            border-color: #f59e0b;
        }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <h1>Sistema de Busca de Minutas</h1>
            <p>Quarta Turma - STJ</p>
        </div>
    </header>

    <div class="container">
        <div class="stats-bar">
            <div class="stat-card" onclick="mostrarTodasMinutas()">
                <h3 id="stat-minutas">-</h3>
                <p>Minutas</p>
            </div>
            <div class="stat-card">
                <h3 id="stat-precedentes">-</h3>
                <p>Precedentes</p>
            </div>
            <div class="stat-card">
                <h3 id="stat-categorias">-</h3>
                <p>Categorias</p>
            </div>
            <div class="stat-card">
                <h3 id="stat-sumulas">-</h3>
                <p>Súmulas</p>
            </div>
            <div class="stat-card" onclick="abrirPainelSheets()" style="background: linear-gradient(135deg, #34a853 0%, #0f9d58 100%); color: white;">
                <h3 id="stat-sheets" style="font-size: 1.2em;">Google Sheets</h3>
                <p style="color: rgba(255,255,255,0.9);">Sincronizar</p>
            </div>
        </div>

        <div class="main-content">
            <div class="search-section">
                <div class="search-tabs">
                    <button class="tab-btn active" data-tab="categorias">Por Categoria</button>
                    <button class="tab-btn" data-tab="paradigmas" style="background: linear-gradient(135deg, #38a169 0%, #276749 100%); color: white; border-color: #38a169;">Sugerir Paradigmas</button>
                    <button class="tab-btn" data-tab="banco-precedentes" style="background: linear-gradient(135deg, #805ad5 0%, #553c9a 100%); color: white; border-color: #805ad5;">Banco de Precedentes</button>
                    <button class="tab-btn" data-tab="config-ia" style="background: linear-gradient(135deg, #4299e1 0%, #2b6cb0 100%); color: white; border-color: #4299e1;">⚙️ Configuração de IA</button>
                    <button class="tab-btn" data-tab="combinado">Busca Combinada</button>
                    <button class="tab-btn" data-tab="texto">Busca Livre</button>
                    <button class="tab-btn" data-tab="sumula">Por Sumula</button>
                    <button class="tab-btn" data-tab="tema">Por Tema</button>
                    <button class="tab-btn" data-tab="precedente">Precedente</button>
                </div>

                <!-- Busca por Categorias -->
                <div id="search-categorias" class="search-panel">
                    <div class="search-hints">
                        <strong>Clique em uma categoria</strong> para ver todas as minutas relacionadas
                    </div>
                    <div class="categorias-grid" id="categorias-grid">
                        <div class="loading">Carregando categorias</div>
                    </div>
                </div>

                <!-- SUGERIR PARADIGMAS -->
                <div id="search-paradigmas" class="search-panel" style="display:none">
                    <div class="paradigmas-container">
                        <div class="search-hints" style="background: linear-gradient(to right, #f0fff4, #c6f6d5); border-left: 4px solid #38a169;">
                            <strong>Cole o texto do Recurso Especial</strong> e o sistema ira analisar e sugerir minutas paradigmas da sua base, explicando o motivo de cada sugestao.
                        </div>

                        <textarea
                            id="texto-recurso"
                            class="texto-input-area"
                            placeholder="Cole aqui o texto do Recurso Especial...

O sistema ira:
- Identificar os temas juridicos do recurso
- Detectar questoes debatidas
- Sugerir obices potencialmente aplicaveis
- Encontrar minutas similares para usar como modelo

Quanto mais texto voce colar, melhor sera a analise."></textarea>

                        <div style="display: flex; gap: 15px; align-items: center;">
                            <button class="btn-analisar" onclick="analisarRecurso()" id="btn-analisar">
                                Analisar e Sugerir Paradigmas
                            </button>
                            <button class="btn-action btn-secondary" onclick="limparAnalise()">
                                Limpar
                            </button>
                            <span id="status-analise" style="color: #666; font-size: 0.9em;"></span>
                        </div>

                        <!-- Resultado da analise -->
                        <div id="resultado-paradigmas"></div>
                    </div>
                </div>

                <!-- Busca Combinada (Tema + Óbice) -->
                <div id="search-combinado" class="search-panel" style="display:none">
                    <div class="search-hints">
                        <strong>Busca avancada:</strong> Combine tema + obice + resultado para encontrar minutas especificas.
                        Ex: "Responsabilidade Civil + Sumula 7 + Nao conhecido"
                    </div>

                    <div class="filtros-combinados">
                        <div class="filtro-grupo">
                            <label>Tema/Categoria de Merito:</label>
                            <select id="filtro-tema">
                                <option value="">-- Todos --</option>
                            </select>
                        </div>

                        <div class="filtro-grupo">
                            <label>Categoria de Obice:</label>
                            <select id="filtro-obice-cat">
                                <option value="">-- Todas --</option>
                                <option value="Reexame Vedado">Reexame Vedado (Sum. 5/7)</option>
                                <option value="Prequestionamento">Prequestionamento</option>
                                <option value="Admissibilidade">Admissibilidade</option>
                                <option value="Jurisprudencia Pacifica">Jurisprudencia Pacifica</option>
                                <option value="Dissidio">Dissidio</option>
                                <option value="Outros">Outros Obices</option>
                            </select>
                        </div>

                        <div class="filtro-grupo">
                            <label>Obice Especifico:</label>
                            <select id="filtro-obice">
                                <option value="">-- Todos --</option>
                            </select>
                        </div>

                        <div class="filtro-grupo">
                            <label>Resultado:</label>
                            <select id="filtro-resultado">
                                <option value="">-- Todos --</option>
                                <option value="Nao conhecido">Nao conhecido</option>
                                <option value="Desprovido">Desprovido</option>
                                <option value="Provido">Provido</option>
                                <option value="Parcialmente Provido">Parcialmente Provido</option>
                            </select>
                        </div>

                        <div class="filtro-grupo filtro-texto">
                            <label>Texto adicional (opcional):</label>
                            <input type="text" id="filtro-texto" placeholder="Ex: dano moral, prescricao...">
                        </div>
                    </div>

                    <div class="filtros-acoes">
                        <button class="btn-action btn-primary" onclick="buscarCombinado()">Buscar</button>
                        <button class="btn-action btn-secondary" onclick="limparFiltros()">Limpar Filtros</button>
                    </div>

                    <div class="filtros-ativos" id="filtros-ativos" style="display:none">
                        <strong>Filtros ativos:</strong>
                        <span id="filtros-ativos-lista"></span>
                    </div>
                </div>

                <!-- Busca por Texto -->
                <div id="search-texto" class="search-panel" style="display:none">
                    <div class="search-mode">
                        <label>Modo de busca:</label>
                        <select id="modo-busca">
                            <option value="hibrido">Hibrido (recomendado)</option>
                            <option value="semantico">Semantico (conceitos similares)</option>
                            <option value="palavras">Palavras-chave</option>
                        </select>
                        <span id="embeddings-status" class="embeddings-status">Verificando...</span>
                    </div>
                    <div class="search-box">
                        <input type="text" id="input-texto" placeholder="Digite termos de busca (ex: vicios construtivos, fraude execucao...)">
                        <button onclick="buscarTexto()">Buscar</button>
                    </div>
                    <div class="search-hints">
                        <strong>Dica:</strong> No modo semantico, "erro medico" encontra tambem "impericia hospitalar"
                    </div>
                </div>

                <!-- Busca por Sumula -->
                <div id="search-sumula" class="search-panel" style="display:none">
                    <div class="search-box">
                        <input type="text" id="input-sumula" placeholder="Numero da sumula (ex: 7, 83, 115...)">
                        <button onclick="buscarSumula()">Buscar</button>
                    </div>
                </div>

                <!-- Busca por Tema -->
                <div id="search-tema" class="search-panel" style="display:none">
                    <div class="search-box">
                        <input type="text" id="input-tema" placeholder="Numero do tema repetitivo (ex: 1051, 872...)">
                        <button onclick="buscarTema()">Buscar</button>
                    </div>
                </div>

                <!-- Busca por Precedente -->
                <div id="search-precedente" class="search-panel" style="display:none">
                    <div class="search-box">
                        <input type="text" id="input-precedente" placeholder="Numero do precedente (ex: 2756519...)">
                        <button onclick="buscarPrecedente()">Buscar</button>
                    </div>
                </div>

                <!-- BANCO DE PRECEDENTES -->
                <div id="search-banco-precedentes" class="search-panel" style="display:none">
                    <div class="banco-prec-container">
                        <div class="search-hints" style="background: linear-gradient(to right, #f5f0ff, #e9d5ff); border-left: 4px solid #805ad5; display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <strong>Banco de Precedentes Pessoal</strong> - Cadastre e organize precedentes importantes para consulta rapida.
                            </div>
                            <div id="contador-precedentes" style="background: white; padding: 8px 16px; border-radius: 20px; font-weight: 600; color: #805ad5; font-size: 0.9em; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                                📊 <span id="total-precedentes">...</span> precedentes
                            </div>
                        </div>

                        <!-- Sub-abas do banco -->
                        <div class="banco-prec-tabs">
                            <button class="banco-tab-btn active" data-subtab="adicionar" onclick="trocarSubabaPrec('adicionar')">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <line x1="12" y1="5" x2="12" y2="19"></line>
                                    <line x1="5" y1="12" x2="19" y2="12"></line>
                                </svg>
                                Adicionar
                            </button>
                            <button class="banco-tab-btn" data-subtab="consultar" onclick="trocarSubabaPrec('consultar')">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <circle cx="11" cy="11" r="8"></circle>
                                    <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                                </svg>
                                Consultar
                            </button>
                            <button class="banco-tab-btn" data-subtab="estatisticas" onclick="trocarSubabaPrec('estatisticas')">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <line x1="18" y1="20" x2="18" y2="10"></line>
                                    <line x1="12" y1="20" x2="12" y2="4"></line>
                                    <line x1="6" y1="20" x2="6" y2="14"></line>
                                </svg>
                                Estatisticas
                            </button>
                        </div>

                        <!-- Painel: Adicionar Precedente -->
                        <div id="subtab-adicionar" class="banco-subtab">
                            <div style="position: relative;">
                                <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #805ad5; font-size: 0.95em;">
                                    📋 Cole uma ou mais ementas do STJ
                                </label>
                                <textarea
                                    id="ementa-input"
                                    class="texto-input-area"
                                    placeholder="Cole aqui a ementa do STJ...

Exemplo:
DIREITO PROCESSUAL CIVIL. AGRAVO INTERNO NO AGRAVO EM RECURSO ESPECIAL...

(AgInt no AREsp n. 2.849.270/MG, relator Ministro Antonio Carlos Ferreira, Quarta Turma, julgado em 17/11/2025, DJEN de 25/11/2025.)"
                                    style="min-height: 200px; border: 2px dashed #cbd5e0; transition: border-color 0.2s;"
                                    oninput="atualizarContadorEmentas()"
                                    onfocus="this.style.borderColor='#805ad5'; this.style.borderStyle='solid';"
                                    onblur="this.style.borderColor='#cbd5e0'; this.style.borderStyle='dashed';"></textarea>
                                <div id="contador-ementas" style="margin-top: 8px; font-size: 0.85em; color: #666; font-weight: 500;">
                                    📊 <span id="num-ementas">0</span> ementa(s) detectada(s)
                                </div>
                            </div>

                            <div class="banco-acoes">
                                <button class="btn-analisar" onclick="processarEmenta()" id="btn-processar-ementa">
                                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                                        <polyline points="14 2 14 8 20 8"></polyline>
                                        <line x1="12" y1="18" x2="12" y2="12"></line>
                                        <line x1="9" y1="15" x2="15" y2="15"></line>
                                    </svg>
                                    Processar 1 Ementa
                                </button>
                                <button class="btn-analisar" onclick="processarLote()" id="btn-processar-lote" style="background: linear-gradient(135deg, #805ad5 0%, #553c9a 100%);">
                                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <rect x="3" y="3" width="7" height="7"></rect>
                                        <rect x="14" y="3" width="7" height="7"></rect>
                                        <rect x="14" y="14" width="7" height="7"></rect>
                                        <rect x="3" y="14" width="7" height="7"></rect>
                                    </svg>
                                    Processar em Lote
                                </button>
                                <button class="btn-action btn-secondary" onclick="limparFormPrec()">
                                    Limpar
                                </button>
                            </div>

                            <div class="search-hints" style="margin-top: 10px; background: #f5f0ff; border-left: 4px solid #805ad5; font-size: 0.85em;">
                                <strong>💡 Dica:</strong> Cole várias ementas de uma vez e clique em "Processar em Lote". O sistema separa e classifica automaticamente cada uma.
                            </div>

                            <!-- Painel de erro de API / Troca de chave -->
                            <div id="erro-api-prec" style="display:none; margin-top: 15px;">
                                <div style="background: #fef2f2; border: 1px solid #fecaca; border-radius: 8px; padding: 15px; position: relative;">
                                    <div style="display: flex; align-items: flex-start; gap: 12px;">
                                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#dc2626" stroke-width="2" style="flex-shrink: 0; margin-top: 2px;">
                                            <circle cx="12" cy="12" r="10"></circle>
                                            <line x1="12" y1="8" x2="12" y2="12"></line>
                                            <line x1="12" y1="16" x2="12.01" y2="16"></line>
                                        </svg>
                                        <div style="flex: 1;">
                                            <h4 style="color: #dc2626; margin: 0 0 8px 0; font-size: 1em;">Erro na Classificação com IA</h4>
                                            <p id="erro-api-msg" style="color: #7f1d1d; margin: 0 0 12px 0; font-size: 0.9em;"></p>

                                            <div id="form-trocar-chave" style="display:none; margin-top: 12px; padding-top: 12px; border-top: 1px solid #fecaca;">
                                                <p style="color: #7f1d1d; margin: 0 0 10px 0; font-size: 0.85em;">
                                                    Você pode inserir uma nova chave API do Google Gemini para continuar:
                                                </p>
                                                <div style="display: flex; gap: 8px;">
                                                    <input type="password" id="nova-api-key" placeholder="Cole a nova API key aqui..."
                                                           style="flex: 1; padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 0.9em;">
                                                    <button onclick="trocarApiKeyGemini()" class="btn-action" style="background: #059669; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 0.9em;">
                                                        Atualizar Chave
                                                    </button>
                                                </div>
                                                <p style="color: #6b7280; margin: 8px 0 0 0; font-size: 0.75em;">
                                                    Obtenha uma chave em: <a href="https://aistudio.google.com/apikey" target="_blank" style="color: #805ad5;">aistudio.google.com/apikey</a>
                                                </p>
                                            </div>
                                        </div>
                                    </div>
                                    <button onclick="fecharErroApi()" style="position: absolute; top: 10px; right: 10px; background: none; border: none; cursor: pointer; color: #9ca3af; font-size: 1.2em;">&times;</button>
                                </div>
                            </div>

                            <!-- Resultado do lote -->
                            <div id="resultado-lote" style="display:none;">
                                <div class="prec-preview" style="border-color: #805ad5;">
                                    <h4 style="color: #805ad5;">Resultado do Processamento em Lote</h4>
                                    <div id="lote-detalhes"></div>
                                </div>
                            </div>

                            <!-- Resultado do processamento -->
                            <div id="resultado-processamento" style="display:none;">
                                <div class="prec-preview">
                                    <h4>Dados Extraidos</h4>
                                    <div class="prec-dados-grid">
                                        <div class="prec-campo">
                                            <label>Processo:</label>
                                            <span id="prev-processo">-</span>
                                        </div>
                                        <div class="prec-campo">
                                            <label>Relator:</label>
                                            <span id="prev-relator">-</span>
                                        </div>
                                        <div class="prec-campo">
                                            <label>Orgao:</label>
                                            <span id="prev-orgao">-</span>
                                        </div>
                                        <div class="prec-campo">
                                            <label>Julgamento:</label>
                                            <span id="prev-data">-</span>
                                        </div>
                                    </div>

                                    <h4 style="margin-top: 15px;">Classificacao IA</h4>
                                    <div class="prec-dados-grid">
                                        <div class="prec-campo">
                                            <label>Tema:</label>
                                            <input type="text" id="prev-tema" class="prec-input-edit">
                                        </div>
                                        <div class="prec-campo">
                                            <label>Area:</label>
                                            <input type="text" id="prev-area" class="prec-input-edit">
                                        </div>
                                        <div class="prec-campo">
                                            <label>Obices:</label>
                                            <input type="text" id="prev-obices" class="prec-input-edit" placeholder="Separados por virgula">
                                        </div>
                                        <div class="prec-campo">
                                            <label>Resultado:</label>
                                            <input type="text" id="prev-resultado" class="prec-input-edit">
                                        </div>
                                    </div>

                                    <div class="prec-campo" style="margin-top: 10px;">
                                        <label>Anotacoes Pessoais:</label>
                                        <textarea id="prev-anotacoes" class="prec-input-edit" rows="2" placeholder="Suas observacoes sobre este precedente..."></textarea>
                                    </div>

                                    <div class="banco-acoes" style="margin-top: 15px;">
                                        <button class="btn-analisar" onclick="salvarPrecedente()" style="background: #38a169;">
                                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path>
                                                <polyline points="17 21 17 13 7 13 7 21"></polyline>
                                                <polyline points="7 3 7 8 15 8"></polyline>
                                            </svg>
                                            Salvar no Banco
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Painel: Consultar Precedentes -->
                        <div id="subtab-consultar" class="banco-subtab" style="display:none;">
                            <div class="search-box">
                                <input type="text" id="busca-prec-input" placeholder="Buscar precedentes (ex: cerceamento de defesa, sumula 7...)" onkeypress="if(event.key==='Enter') buscarPrecedentesBanco()">
                                <button onclick="buscarPrecedentesBanco()">🔍 Buscar</button>
                            </div>

                            <div class="prec-filtros">
                                <select id="filtro-tema" onchange="buscarPrecedentesBanco()">
                                    <option value="">🏷️ Todos os temas</option>
                                </select>
                                <select id="filtro-area" onchange="buscarPrecedentesBanco()">
                                    <option value="">⚖️ Todas as áreas</option>
                                </select>
                                <button onclick="limparFiltros()" style="padding: 8px 16px; background: #718096; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 0.9em;">
                                    ✖️ Limpar Filtros
                                </button>
                            </div>

                            <!-- Painel de Precedentes Recentes (visível no estado inicial) -->
                            <div id="precedentes-recentes" style="margin-bottom: 20px;">
                                <h3 style="color: #805ad5; margin-bottom: 15px; font-size: 1.1em;">🕒 Recentemente Adicionados</h3>
                                <div id="lista-recentes" style="display: grid; gap: 10px;">
                                    <div class="empty-state" style="padding: 20px;">
                                        <p style="color: #666;">Carregando precedentes recentes...</p>
                                    </div>
                                </div>
                            </div>

                            <div id="lista-precedentes" class="prec-lista">
                                <div class="empty-state">
                                    <p>Faça uma busca ou clique em "Listar Todos"</p>
                                    <button class="btn-action" onclick="listarTodosPrecedentes()">📋 Listar Todos</button>
                                </div>
                            </div>
                        </div>

                        <!-- Painel: Estatisticas -->
                        <div id="subtab-estatisticas" class="banco-subtab" style="display:none;">
                            <div id="stats-precedentes" class="stats-prec-container">
                                <div class="empty-state">Carregando estatisticas...</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- CONFIGURAÇÃO DE IA -->
                <div id="search-config-ia" class="search-panel" style="display:none">
                    <div class="info-box" style="margin-bottom: 20px;">
                        <strong>Configuração de IA para Classificação de Ementas</strong> - Sistema inteligente que aprende com suas classificações manuais.
                    </div>

                    <!-- Sub-tabs -->
                    <div style="display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap;">
                        <button class="subtab-btn" onclick="abrirSubTabIA('prompt')" id="subtab-ia-prompt" style="font-size: 0.9em; padding: 8px 16px; background: #4299e1; color: white; border: 2px solid #4299e1; border-radius: 8px; cursor: pointer; font-weight: 500; transition: all 0.2s;">
                            Prompt Atual
                        </button>
                        <button class="subtab-btn" onclick="abrirSubTabIA('config')" id="subtab-ia-config" style="font-size: 0.9em; padding: 8px 16px; border: 2px solid #e2e8f0; border-radius: 8px; cursor: pointer; font-weight: 500; transition: all 0.2s;">
                            Configuração
                        </button>
                        <button class="subtab-btn" onclick="abrirSubTabIA('versoes')" id="subtab-ia-versoes" style="font-size: 0.9em; padding: 8px 16px; border: 2px solid #e2e8f0; border-radius: 8px; cursor: pointer; font-weight: 500; transition: all 0.2s;">
                            Versões
                        </button>
                        <button class="subtab-btn" onclick="abrirSubTabIA('exemplos')" id="subtab-ia-exemplos" style="font-size: 0.9em; padding: 8px 16px; border: 2px solid #e2e8f0; border-radius: 8px; cursor: pointer; font-weight: 500; transition: all 0.2s;">
                            Aprendizado
                        </button>
                    </div>

                    <!-- Painel: Prompt Atual -->
                    <div id="painel-ia-prompt" class="painel-subtab-ia">
                        <div style="background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                <h3 style="margin: 0; color: #2c5282;">Prompt Atual</h3>
                                <button onclick="carregarPromptAtual()" style="padding: 8px 16px; background: #4299e1; color: white; border: none; border-radius: 6px; cursor: pointer;">
                                    🔄 Recarregar
                                </button>
                            </div>

                            <div id="info-prompt" style="background: #e6f2ff; padding: 12px; border-radius: 6px; margin-bottom: 15px; font-size: 0.9em; color: #2c5282;">
                                Este é o prompt que está sendo usado para classificar ementas. Inclui few-shot learning com exemplos do seu histórico.
                            </div>

                            <textarea id="editor-prompt" rows="25" style="width: 100%; padding: 15px; border: 2px solid #e2e8f0; border-radius: 8px; font-family: 'Consolas', 'Monaco', monospace; font-size: 0.9em; resize: vertical;"></textarea>

                            <div style="display: flex; gap: 10px; margin-top: 15px;">
                                <button onclick="salvarNovaVersaoPrompt()" style="padding: 12px 24px; background: #48bb78; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 1em; font-weight: 500;">
                                    💾 Salvar Como Nova Versão
                                </button>
                                <button onclick="copiarPrompt()" style="padding: 12px 24px; background: #718096; color: white; border: none; border-radius: 6px; cursor: pointer;">
                                    📋 Copiar para Área de Transferência
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Painel: Configuração -->
                    <div id="painel-ia-config" class="painel-subtab-ia" style="display: none;">
                        <div style="background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
                            <h3 style="margin-bottom: 20px; color: #2c5282;">Configuração do Sistema</h3>

                            <div id="estatisticas-ia" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 25px;">
                                <!-- Estatísticas carregadas dinamicamente -->
                            </div>

                            <div style="display: grid; gap: 20px;">
                                <div>
                                    <label style="font-weight: 600; color: #666; display: block; margin-bottom: 8px;">
                                        Temperatura (Criatividade da IA)
                                        <span style="font-weight: normal; color: #999; font-size: 0.9em;">- Menor = mais determinístico</span>
                                    </label>
                                    <input type="range" id="config-temperatura" min="0" max="1" step="0.1" value="0.3" style="width: 100%;" oninput="atualizarLabelTemperatura(this.value)">
                                    <div style="display: flex; justify-content: space-between; font-size: 0.85em; color: #666; margin-top: 5px;">
                                        <span>0.0 (Determinístico)</span>
                                        <span id="label-temperatura" style="font-weight: 600; color: #4299e1;">0.3</span>
                                        <span>1.0 (Criativo)</span>
                                    </div>
                                </div>

                                <div>
                                    <label style="font-weight: 600; color: #666; display: block; margin-bottom: 8px;">
                                        Máximo de Exemplos Few-Shot
                                    </label>
                                    <input type="number" id="config-max-exemplos" min="0" max="10" value="3" style="width: 100%; padding: 10px; border: 2px solid #e2e8f0; border-radius: 6px; font-size: 0.95em;">
                                </div>

                                <div>
                                    <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                                        <input type="checkbox" id="config-usar-fewshot" checked style="width: 20px; height: 20px; cursor: pointer;">
                                        <span style="font-weight: 600; color: #666;">Usar Few-Shot Learning (exemplos no prompt)</span>
                                    </label>
                                </div>

                                <div>
                                    <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                                        <input type="checkbox" id="config-aprendizado-ativo" checked style="width: 20px; height: 20px; cursor: pointer;">
                                        <span style="font-weight: 600; color: #666;">Aprendizado Automático (adicionar classificações manuais aos exemplos)</span>
                                    </label>
                                </div>
                            </div>

                            <div style="margin-top: 25px; padding-top: 20px; border-top: 2px solid #e2e8f0;">
                                <button onclick="salvarConfigIA()" style="padding: 12px 24px; background: #48bb78; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 1em; font-weight: 500;">
                                    💾 Salvar Configuração
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Painel: Versões -->
                    <div id="painel-ia-versoes" class="painel-subtab-ia" style="display: none;">
                        <div style="background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                                <h3 style="margin: 0; color: #2c5282;">Versões de Prompts Salvas</h3>
                                <button onclick="carregarVersoesPrompt()" style="padding: 8px 16px; background: #4299e1; color: white; border: none; border-radius: 6px; cursor: pointer;">
                                    🔄 Recarregar
                                </button>
                            </div>

                            <div id="lista-versoes" style="display: grid; gap: 15px;">
                                <!-- Versões carregadas dinamicamente -->
                            </div>
                        </div>
                    </div>

                    <!-- Painel: Aprendizado -->
                    <div id="painel-ia-exemplos" class="painel-subtab-ia" style="display: none;">
                        <div style="background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                                <h3 style="margin: 0; color: #2c5282;">Exemplos de Aprendizado</h3>
                                <button onclick="carregarExemplosAprendizado()" style="padding: 8px 16px; background: #4299e1; color: white; border: none; border-radius: 6px; cursor: pointer;">
                                    🔄 Recarregar
                                </button>
                            </div>

                            <div id="info-aprendizado" style="background: #e6f2ff; padding: 12px; border-radius: 6px; margin-bottom: 15px; font-size: 0.9em; color: #2c5282;">
                                Estes são os exemplos coletados das suas classificações manuais. O sistema usa estes exemplos para melhorar as próximas classificações.
                            </div>

                            <div id="lista-exemplos" style="display: grid; gap: 15px;">
                                <!-- Exemplos carregados dinamicamente -->
                            </div>
                        </div>
                    </div>
                </div>

                <div id="resultados">
                    <div class="empty-state">
                        <p>Selecione uma categoria ou faca uma busca</p>
                    </div>
                </div>
            </div>

            <div class="sidebar">
                <div class="sidebar-card">
                    <h3>Obices Mais Usados</h3>
                    <ul class="obice-list" id="obices-top">
                        <li><span>Carregando...</span></li>
                    </ul>
                </div>

                <div class="sidebar-card">
                    <h3>Sumulas Mais Usadas</h3>
                    <ul class="sumula-list" id="sumulas-top">
                        <li><span>Carregando...</span></li>
                    </ul>
                </div>

                <div class="sidebar-card">
                    <h3>Precedentes Top</h3>
                    <ul class="precedente-list" id="precedentes-top">
                        <li><span>Carregando...</span></li>
                    </ul>
                </div>

                <div class="sidebar-card">
                    <h3>Exportar Dados</h3>
                    <div class="export-buttons">
                        <button class="btn-export" onclick="window.location.href='/api/exportar/csv'">CSV Completo</button>
                        <button class="btn-export" onclick="window.location.href='/api/exportar/precedentes'">Precedentes</button>
                        <button class="btn-export" onclick="window.location.href='/api/exportar/relatorio'">Relatorio JSON</button>
                    </div>
                </div>

                <div class="sidebar-card">
                    <h3>Gerenciar Base</h3>
                    <button class="btn-indexar" onclick="indexar(false)" id="btn-indexar">
                        Atualizar Indice
                    </button>
                    <button class="btn-reindexar" onclick="indexar(true)" id="btn-reindexar">
                        Reindexar Tudo (com embeddings)
                    </button>
                    <p style="font-size: 0.75em; color: #666; margin-top: 10px;">
                        Reindexar aplica categorizacao e gera embeddings para busca semantica
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Visualização -->
    <div class="modal-overlay" id="modal-minuta" onclick="fecharModal(event)">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h2 id="modal-titulo">Carregando...</h2>
                <button class="modal-close" onclick="fecharModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="modal-meta" id="modal-meta">
                    <!-- Metadados dinâmicos -->
                </div>

                <!-- Seção de Relevância (exibida quando há contexto de busca) -->
                <div class="modal-relevancia" id="modal-relevancia" style="display:none;">
                    <h4>Por que esta minuta é relevante?</h4>
                    <ul id="relevancia-motivos">
                        <!-- Motivos dinâmicos -->
                    </ul>
                </div>

                <!-- Trechos Relevantes (exibidos quando há termos de busca) -->
                <div class="trechos-relevantes" id="trechos-relevantes" style="display:none;">
                    <h5>Trechos Relevantes</h5>
                    <div id="trechos-lista">
                        <!-- Trechos dinâmicos -->
                    </div>
                </div>

                <div class="modal-section">
                    <div class="content-tabs">
                        <button class="content-tab active" data-panel="completo">Completo</button>
                        <button class="content-tab" data-panel="ementa">Ementa</button>
                        <button class="content-tab" data-panel="relatorio">Relatorio</button>
                        <button class="content-tab" data-panel="voto">Voto</button>
                        <button class="content-tab" data-panel="similares">Similares</button>
                    </div>

                    <div class="content-panel active" id="panel-completo">
                        <div class="conteudo-texto" id="modal-conteudo">Carregando...</div>
                    </div>

                    <div class="content-panel" id="panel-ementa">
                        <div class="conteudo-texto" id="modal-ementa">-</div>
                    </div>

                    <div class="content-panel" id="panel-relatorio">
                        <div class="conteudo-texto" id="modal-relatorio">-</div>
                    </div>

                    <div class="content-panel" id="panel-voto">
                        <div class="conteudo-texto" id="modal-voto">-</div>
                    </div>

                    <div class="content-panel" id="panel-similares">
                        <p style="margin-bottom: 15px; color: #666;">Minutas com temas e conteudos similares:</p>
                        <ul class="similares-list" id="modal-similares">
                            <li>Carregando...</li>
                        </ul>
                    </div>
                </div>

                <div class="modal-section">
                    <h3>Precedentes Citados</h3>
                    <div class="tags" id="modal-precedentes">
                        <!-- Precedentes dinâmicos -->
                    </div>
                </div>

                <div class="modal-actions">
                    <button class="btn-action btn-primary" onclick="copiarConteudo()">Copiar Conteudo</button>
                    <button class="btn-action btn-secondary" onclick="copiarEmenta()">Copiar Ementa</button>
                    <button class="btn-action btn-success" id="btn-abrir-arquivo">Abrir Arquivo</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Comparacao Lado a Lado -->
    <div class="modal-comparacao" id="modal-comparacao" onclick="fecharComparacao(event)">
        <div class="comparacao-content" onclick="event.stopPropagation()">
            <div class="comparacao-header">
                <h2>Comparacao: Recurso x Minuta Paradigma</h2>
                <button class="comparacao-close" onclick="fecharComparacao()">&times;</button>
            </div>
            <div id="termos-comuns-bar" class="termos-destaque" style="display:none;">
                <strong>Termos em comum:</strong>
                <span id="termos-comuns-lista"></span>
            </div>
            <div class="comparacao-body">
                <!-- Lado esquerdo: Recurso -->
                <div class="comparacao-lado">
                    <div class="lado-header">
                        Recurso Especial
                        <span class="badge">Documento analisado</span>
                    </div>
                    <div class="lado-content">
                        <div class="conteudo-texto" id="comparacao-recurso">Carregando...</div>
                    </div>
                </div>

                <!-- Lado direito: Minuta -->
                <div class="comparacao-lado">
                    <div class="lado-header">
                        Minuta Paradigma
                        <span class="badge" id="comparacao-minuta-nome">-</span>
                    </div>
                    <div class="lado-tabs">
                        <button class="lado-tab active" onclick="trocarAbaComparacao('completo')">Completo</button>
                        <button class="lado-tab" onclick="trocarAbaComparacao('ementa')">Ementa</button>
                        <button class="lado-tab" onclick="trocarAbaComparacao('voto')">Voto</button>
                    </div>
                    <div class="lado-content">
                        <div class="conteudo-texto" id="comparacao-minuta">Carregando...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Google Sheets -->
    <div class="modal-overlay" id="modal-sheets" onclick="fecharPainelSheets(event)">
        <div class="modal-content" onclick="event.stopPropagation()" style="max-width: 600px;">
            <div class="modal-header" style="background: linear-gradient(135deg, #34a853 0%, #0f9d58 100%);">
                <h2 style="color: white;">Google Sheets - Sincronizacao</h2>
                <button class="modal-close" onclick="fecharPainelSheets()" style="color: white;">&times;</button>
            </div>
            <div class="modal-body">
                <div id="sheets-status" style="padding: 15px; background: #f8f9fa; border-radius: 8px; margin-bottom: 20px;">
                    <p style="color: #666;">Verificando conexao...</p>
                </div>

                <div style="margin-bottom: 20px;">
                    <h3 style="margin-bottom: 10px; color: #333;">O que a sincronizacao faz?</h3>
                    <ul style="margin-left: 20px; color: #555; line-height: 1.8;">
                        <li>Le os dados da sua planilha de controle</li>
                        <li>Atualiza as minutas com: <strong>Tese/Resumo</strong>, <strong>Obices</strong>, <strong>Detalhamento</strong></li>
                        <li>Melhora a precisao do Sugestor de Paradigmas</li>
                    </ul>
                </div>

                <div id="sheets-resultado" style="display: none; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                </div>

                <div style="display: flex; gap: 10px;">
                    <button onclick="sincronizarSheets()" id="btn-sincronizar" style="flex: 1; padding: 14px; background: #34a853; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 1em; font-weight: 500;">
                        Sincronizar Agora
                    </button>
                    <button onclick="fecharPainelSheets()" style="padding: 14px 20px; background: #e2e8f0; color: #333; border: none; border-radius: 8px; cursor: pointer;">
                        Fechar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal: Visualizar/Editar Precedente -->
    <div class="modal-overlay" id="modal-precedente" onclick="fecharModalPrecedente(event)">
        <div class="modal-content" onclick="event.stopPropagation()" style="max-width: 900px; max-height: 90vh; overflow-y: auto;">
            <div class="modal-header" style="background: linear-gradient(135deg, #805ad5 0%, #553c9a 100%); position: sticky; top: 0; z-index: 10;">
                <h2 style="color: white;" id="prec-titulo">Detalhes do Precedente</h2>
                <button class="modal-close" onclick="fecharModalPrecedente()" style="color: white;">&times;</button>
            </div>
            <div class="modal-body">
                <!-- Dados do Processo -->
                <div class="modal-section">
                    <h3 style="color: #805ad5; margin-bottom: 15px;">Dados do Processo</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                        <div>
                            <label style="font-weight: 600; color: #666; font-size: 0.85em;">Número</label>
                            <p id="prec-numero" style="margin-top: 5px; color: #333;"></p>
                        </div>
                        <div>
                            <label style="font-weight: 600; color: #666; font-size: 0.85em;">Tipo</label>
                            <p id="prec-tipo" style="margin-top: 5px; color: #333;"></p>
                        </div>
                        <div>
                            <label style="font-weight: 600; color: #666; font-size: 0.85em;">UF</label>
                            <p id="prec-uf" style="margin-top: 5px; color: #333;"></p>
                        </div>
                        <div>
                            <label style="font-weight: 600; color: #666; font-size: 0.85em;">Relator</label>
                            <p id="prec-relator" style="margin-top: 5px; color: #333;"></p>
                        </div>
                        <div>
                            <label style="font-weight: 600; color: #666; font-size: 0.85em;">Órgão</label>
                            <p id="prec-orgao" style="margin-top: 5px; color: #333;"></p>
                        </div>
                        <div>
                            <label style="font-weight: 600; color: #666; font-size: 0.85em;">Data Julgamento</label>
                            <p id="prec-data-julg" style="margin-top: 5px; color: #333;"></p>
                        </div>
                    </div>
                </div>

                <!-- Ementa -->
                <div class="modal-section">
                    <h3 style="color: #805ad5; margin-bottom: 10px;">Ementa</h3>
                    <div id="prec-ementa" style="background: #f8f9fa; padding: 15px; border-radius: 8px; white-space: pre-wrap; line-height: 1.6; color: #333; font-size: 0.95em;"></div>
                </div>

                <!-- Tese -->
                <div class="modal-section" id="section-tese" style="display: none;">
                    <h3 style="color: #805ad5; margin-bottom: 10px;">Tese Jurídica</h3>
                    <div id="prec-tese" style="background: #fff3cd; padding: 15px; border-radius: 8px; border-left: 4px solid #ffc107; line-height: 1.6; color: #333;"></div>
                </div>

                <!-- Classificação (Modo Visualização) -->
                <div class="modal-section" id="section-classificacao-view">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h3 style="color: #805ad5; margin: 0;">Classificação</h3>
                        <button onclick="ativarEdicaoClassificacao()" style="padding: 8px 16px; background: #805ad5; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 0.9em;">
                            ✏️ Editar Classificação
                        </button>
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
                        <div>
                            <label style="font-weight: 600; color: #666; font-size: 0.85em;">Tema Principal</label>
                            <p id="prec-tema-view" style="margin-top: 5px; color: #333; font-weight: 500;"></p>
                        </div>
                        <div>
                            <label style="font-weight: 600; color: #666; font-size: 0.85em;">Área do Direito</label>
                            <p id="prec-area-view" style="margin-top: 5px; color: #333;"></p>
                        </div>
                        <div>
                            <label style="font-weight: 600; color: #666; font-size: 0.85em;">Resultado</label>
                            <p id="prec-resultado-view" style="margin-top: 5px; color: #333;"></p>
                        </div>
                        <div>
                            <label style="font-weight: 600; color: #666; font-size: 0.85em;">Fonte</label>
                            <p id="prec-fonte-view" style="margin-top: 5px; color: #666; font-size: 0.9em;"></p>
                        </div>
                    </div>
                    <div style="margin-top: 15px;">
                        <label style="font-weight: 600; color: #666; font-size: 0.85em;">Subtemas</label>
                        <div id="prec-subtemas-view" style="margin-top: 8px; display: flex; flex-wrap: wrap; gap: 8px;"></div>
                    </div>
                    <div style="margin-top: 15px;">
                        <label style="font-weight: 600; color: #666; font-size: 0.85em;">Óbices Aplicados</label>
                        <div id="prec-obices-view" style="margin-top: 8px; display: flex; flex-wrap: wrap; gap: 8px;"></div>
                    </div>
                    <div style="margin-top: 15px;">
                        <label style="font-weight: 600; color: #666; font-size: 0.85em;">Palavras-chave</label>
                        <div id="prec-palavras-view" style="margin-top: 8px; display: flex; flex-wrap: wrap; gap: 8px;"></div>
                    </div>
                    <div style="margin-top: 15px;" id="div-observacao-ia">
                        <label style="font-weight: 600; color: #666; font-size: 0.85em;">Observação da IA</label>
                        <p id="prec-observacao-view" style="margin-top: 5px; color: #555; font-style: italic;"></p>
                    </div>
                </div>

                <!-- Classificação (Modo Edição) -->
                <div class="modal-section" id="section-classificacao-edit" style="display: none;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h3 style="color: #805ad5; margin: 0;">Editar Classificação</h3>
                        <div style="display: flex; gap: 10px;">
                            <button onclick="reclassificarComIA()" id="btn-reclassificar-ia" style="padding: 8px 16px; background: #4299e1; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 0.9em;">
                                🤖 Reclassificar com IA
                            </button>
                            <button onclick="cancelarEdicaoClassificacao()" style="padding: 8px 16px; background: #e2e8f0; color: #333; border: none; border-radius: 6px; cursor: pointer; font-size: 0.9em;">
                                Cancelar
                            </button>
                        </div>
                    </div>
                    <div style="display: grid; gap: 15px;">
                        <div>
                            <label style="font-weight: 600; color: #666; font-size: 0.85em; display: block; margin-bottom: 5px;">Tema Principal</label>
                            <input type="text" id="prec-tema-edit" style="width: 100%; padding: 10px; border: 2px solid #e2e8f0; border-radius: 6px; font-size: 0.95em;">
                        </div>
                        <div>
                            <label style="font-weight: 600; color: #666; font-size: 0.85em; display: block; margin-bottom: 5px;">Área do Direito</label>
                            <select id="prec-area-edit" style="width: 100%; padding: 10px; border: 2px solid #e2e8f0; border-radius: 6px; font-size: 0.95em;">
                                <option value="">Selecione...</option>
                                <option value="Processual Civil">Processual Civil</option>
                                <option value="Civil">Civil</option>
                                <option value="Consumidor">Consumidor</option>
                                <option value="Bancário">Bancário</option>
                                <option value="Tributário">Tributário</option>
                                <option value="Administrativo">Administrativo</option>
                                <option value="Trabalhista">Trabalhista</option>
                                <option value="Penal">Penal</option>
                                <option value="Empresarial">Empresarial</option>
                            </select>
                        </div>
                        <div>
                            <label style="font-weight: 600; color: #666; font-size: 0.85em; display: block; margin-bottom: 5px;">Subtemas (separados por vírgula)</label>
                            <input type="text" id="prec-subtemas-edit" placeholder="Ex: Coisa julgada, Litispendência" style="width: 100%; padding: 10px; border: 2px solid #e2e8f0; border-radius: 6px; font-size: 0.95em;">
                        </div>
                        <div>
                            <label style="font-weight: 600; color: #666; font-size: 0.85em; display: block; margin-bottom: 5px;">Palavras-chave (separadas por vírgula)</label>
                            <input type="text" id="prec-palavras-edit" placeholder="Ex: recurso especial, admissibilidade" style="width: 100%; padding: 10px; border: 2px solid #e2e8f0; border-radius: 6px; font-size: 0.95em;">
                        </div>
                        <div>
                            <label style="font-weight: 600; color: #666; font-size: 0.85em; display: block; margin-bottom: 5px;">Anotações Pessoais</label>
                            <textarea id="prec-anotacoes-edit" rows="3" placeholder="Suas anotações sobre este precedente..." style="width: 100%; padding: 10px; border: 2px solid #e2e8f0; border-radius: 6px; font-size: 0.95em; resize: vertical;"></textarea>
                        </div>
                    </div>
                    <div style="margin-top: 20px; display: flex; gap: 10px; justify-content: flex-end;">
                        <button onclick="salvarClassificacao()" style="padding: 12px 24px; background: #48bb78; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 1em; font-weight: 500;">
                            💾 Salvar Alterações
                        </button>
                    </div>
                </div>

                <!-- Anotações Pessoais (Modo Visualização) -->
                <div class="modal-section" id="section-anotacoes-view">
                    <h3 style="color: #805ad5; margin-bottom: 10px;">Anotações Pessoais</h3>
                    <div id="prec-anotacoes-view" style="background: #f0f4f8; padding: 15px; border-radius: 8px; min-height: 50px; line-height: 1.6; color: #333; font-style: italic;"></div>
                </div>

                <!-- Ações -->
                <div style="margin-top: 20px; display: flex; gap: 10px; justify-content: space-between; padding-top: 20px; border-top: 2px solid #e2e8f0;">
                    <button onclick="excluirPrecedente()" style="padding: 10px 20px; background: #e53e3e; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 0.95em;">
                        🗑️ Excluir Precedente
                    </button>
                    <button onclick="fecharModalPrecedente()" style="padding: 10px 24px; background: #e2e8f0; color: #333; border: none; border-radius: 6px; cursor: pointer; font-size: 0.95em;">
                        Fechar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Variáveis globais
        let minutaAtual = null;
        let embeddingsAtivos = false;
        let precedenteAtual = null;

        // Contexto da busca/análise atual para destacar termos no modal
        let contextoAtual = {
            termos: [],
            tipo: null,  // 'busca' | 'paradigma'
            resultados: [],
            obices_busca: [],
            categorias_busca: []
        };

        // Tabs principais
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                document.querySelectorAll('.search-panel').forEach(p => p.style.display = 'none');
                document.getElementById('search-' + btn.dataset.tab).style.display = 'block';
            });
        });

        // Tabs do modal
        document.querySelectorAll('.content-tab').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.content-tab').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                document.querySelectorAll('.content-panel').forEach(p => p.classList.remove('active'));
                document.getElementById('panel-' + btn.dataset.panel).classList.add('active');
            });
        });

        // Carregar estatisticas
        async function carregarStats() {
            try {
                const res = await fetch('/api/stats');
                const data = await res.json();
                document.getElementById('stat-minutas').textContent = data.total_minutas;
                document.getElementById('stat-precedentes').textContent = data.total_precedentes;
                document.getElementById('stat-sumulas').textContent = data.sumulas_top.length;

                const sumulasList = document.getElementById('sumulas-top');
                sumulasList.innerHTML = data.sumulas_top.slice(0, 8).map(([sumula, count]) =>
                    `<li onclick="buscarSumulaDireto('${sumula.match(/\\d+/)?.[0] || ''}')">
                        <span>${sumula}</span><span>${count}</span>
                    </li>`
                ).join('');
            } catch (e) { console.error('Erro:', e); }
        }

        // Verificar status de embeddings
        async function verificarEmbeddings() {
            try {
                const res = await fetch('/api/buscar', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({consulta: 'teste', n_resultados: 1})
                });
                const data = await res.json();
                embeddingsAtivos = data.embeddings_ativos;
                const status = document.getElementById('embeddings-status');
                if (embeddingsAtivos) {
                    status.textContent = 'Semantico ativo';
                    status.className = 'embeddings-status active';
                } else {
                    status.textContent = 'Apenas palavras-chave';
                    status.className = 'embeddings-status inactive';
                }
            } catch (e) {
                console.error('Erro:', e);
            }
        }

        // Carregar categorias
        async function carregarCategorias() {
            try {
                const res = await fetch('/api/categorias');
                const data = await res.json();
                document.getElementById('stat-categorias').textContent = data.categorias.length;

                const grid = document.getElementById('categorias-grid');
                if (data.categorias.length === 0) {
                    grid.innerHTML = '<p style="grid-column: 1/-1; text-align:center; color:#666;">Nenhuma categoria. Clique em "Reindexar Tudo" na barra lateral.</p>';
                    return;
                }

                grid.innerHTML = data.categorias.map(cat =>
                    `<div class="categoria-card" onclick="buscarCategoria('${cat.categoria}')">
                        <h4>${cat.categoria}</h4>
                        <div class="count">${cat.quantidade}</div>
                    </div>`
                ).join('');
            } catch (e) {
                console.error('Erro:', e);
                document.getElementById('categorias-grid').innerHTML = '<p>Erro ao carregar</p>';
            }
        }

        // Carregar obices
        async function carregarObices() {
            try {
                const res = await fetch('/api/obices');
                const data = await res.json();

                const list = document.getElementById('obices-top');
                if (data.obices.length === 0) {
                    list.innerHTML = '<li><span>Nenhum obice</span></li>';
                    return;
                }

                list.innerHTML = data.obices.slice(0, 8).map(o =>
                    `<li onclick="buscarObice('${o.obice}')">
                        <span>${o.obice.length > 20 ? o.obice.substring(0,20)+'...' : o.obice}</span>
                        <span>${o.quantidade}</span>
                    </li>`
                ).join('');
            } catch (e) { console.error('Erro:', e); }
        }

        // Carregar precedentes top
        async function carregarPrecedentesTop() {
            try {
                const res = await fetch('/api/precedentes/top');
                const data = await res.json();

                const list = document.getElementById('precedentes-top');
                list.innerHTML = data.precedentes.slice(0, 8).map(p =>
                    `<li onclick="buscarPrecedenteDireto('${p.precedente.match(/\d+/)?.[0] || ''}')">
                        <span>${p.precedente.length > 22 ? p.precedente.substring(0,22)+'...' : p.precedente}</span>
                        <span>${p.citacoes}</span>
                    </li>`
                ).join('');
            } catch (e) { console.error('Erro:', e); }
        }

        // Buscar por categoria
        async function buscarCategoria(nome) {
            document.getElementById('resultados').innerHTML = '<div class="loading">Buscando</div>';

            // Marcar categoria selecionada
            document.querySelectorAll('.categoria-card').forEach(c => c.classList.remove('selected'));
            event?.target?.closest('.categoria-card')?.classList.add('selected');

            try {
                const res = await fetch(`/api/buscar/categoria/${encodeURIComponent(nome)}`);
                const data = await res.json();
                exibirResultados(data.resultados, `Categoria: ${nome}`);
            } catch (e) {
                document.getElementById('resultados').innerHTML = '<div class="empty-state"><p>Erro na busca</p></div>';
            }
        }

        // Buscar por obice
        async function buscarObice(nome) {
            document.getElementById('resultados').innerHTML = '<div class="loading">Buscando</div>';

            try {
                const res = await fetch(`/api/buscar/obice/${encodeURIComponent(nome)}`);
                const data = await res.json();
                exibirResultados(data.resultados, `Obice: ${nome}`);
            } catch (e) {
                document.getElementById('resultados').innerHTML = '<div class="empty-state"><p>Erro na busca</p></div>';
            }
        }

        // Buscar por texto
        async function buscarTexto() {
            const consulta = document.getElementById('input-texto').value.trim();
            if (!consulta) return;

            const modo = document.getElementById('modo-busca').value;
            document.getElementById('resultados').innerHTML = '<div class="loading">Buscando</div>';

            try {
                const res = await fetch('/api/buscar', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({consulta, n_resultados: 20, modo})
                });
                const data = await res.json();

                // Salvar contexto da busca para usar no modal
                contextoAtual = {
                    termos: consulta.split(/\s+/).filter(t => t.length > 2),
                    tipo: 'busca',
                    resultados: data.resultados || [],
                    obices_busca: [],
                    categorias_busca: []
                };

                const modoLabel = modo === 'semantico' ? ' (semantico)' : modo === 'palavras' ? ' (palavras)' : ' (hibrido)';
                exibirResultados(data.resultados, `Busca: "${consulta}"${modoLabel}`);
            } catch (e) {
                document.getElementById('resultados').innerHTML = '<div class="empty-state"><p>Erro</p></div>';
            }
        }

        // Buscar por sumula
        async function buscarSumula() {
            const numero = document.getElementById('input-sumula').value.trim();
            if (!numero) return;
            buscarSumulaDireto(numero);
        }

        async function buscarSumulaDireto(numero) {
            document.getElementById('resultados').innerHTML = '<div class="loading">Buscando</div>';

            try {
                const res = await fetch(`/api/buscar/sumula/${numero}`);
                const data = await res.json();
                exibirResultados(data.resultados, `Sumula ${numero}/STJ`);
            } catch (e) {
                document.getElementById('resultados').innerHTML = '<div class="empty-state"><p>Erro</p></div>';
            }
        }

        // Buscar por tema
        async function buscarTema() {
            const numero = document.getElementById('input-tema').value.trim();
            if (!numero) return;

            document.getElementById('resultados').innerHTML = '<div class="loading">Buscando</div>';

            try {
                const res = await fetch(`/api/buscar/tema/${numero}`);
                const data = await res.json();
                exibirResultados(data.resultados, `Tema ${numero}/STJ`);
            } catch (e) {
                document.getElementById('resultados').innerHTML = '<div class="empty-state"><p>Erro</p></div>';
            }
        }

        // Buscar precedente
        async function buscarPrecedente() {
            const numero = document.getElementById('input-precedente').value.trim();
            if (!numero) return;
            buscarPrecedenteDireto(numero);
        }

        async function buscarPrecedenteDireto(numero) {
            document.getElementById('resultados').innerHTML = '<div class="loading">Buscando</div>';

            try {
                const res = await fetch(`/api/buscar/precedente/${numero}`);
                const data = await res.json();

                if (data.encontrado) {
                    document.getElementById('resultados').innerHTML = `
                        <div class="results-header">
                            <h2>Precedente Encontrado</h2>
                        </div>
                        <div class="precedente-detail">
                            <h4>${data.tipo} n. ${data.numero}/${data.uf}</h4>
                            <p>Citado em <strong>${data.qtd_citacoes}</strong> minuta(s):</p>
                            <ul>${data.minutas_citantes.map(m => `<li>${m}</li>`).join('')}</ul>
                        </div>
                    `;
                } else {
                    document.getElementById('resultados').innerHTML = '<div class="empty-state"><p>Precedente nao encontrado</p></div>';
                }
            } catch (e) {
                document.getElementById('resultados').innerHTML = '<div class="empty-state"><p>Erro</p></div>';
            }
        }

        // Mostrar todas as minutas
        async function mostrarTodasMinutas() {
            document.getElementById('resultados').innerHTML = '<div class="loading">Carregando</div>';

            try {
                const res = await fetch('/api/minutas');
                const data = await res.json();
                exibirResultados(data.minutas, 'Todas as Minutas');
            } catch (e) {
                document.getElementById('resultados').innerHTML = '<div class="empty-state"><p>Erro</p></div>';
            }
        }

        // Exibir resultados
        function exibirResultados(resultados, titulo) {
            if (!resultados || resultados.length === 0) {
                document.getElementById('resultados').innerHTML = '<div class="empty-state"><p>Nenhum resultado</p></div>';
                return;
            }

            const html = `
                <div class="results-header">
                    <h2>${titulo}</h2>
                    <span class="results-count">${resultados.length} resultado(s)</span>
                </div>
                ${resultados.map(r => {
                    const categorias = r.categorias || [];
                    const obices = r.obices || [];
                    const catPrincipal = categorias[0]?.categoria || '';
                    const docId = r.id || r.arquivo.replace('.docx', '').replace(/ /g, '_');

                    return `
                    <div class="result-card clickable" onclick="abrirMinuta('${docId}')">
                        <div class="result-header">
                            <span class="result-title">${r.arquivo}</span>
                            <span class="result-type">${r.tipo}</span>
                        </div>
                        <div class="result-meta">
                            <span>Processo: ${r.processo}</span>
                            ${catPrincipal ? `<span>Categoria: ${catPrincipal}</span>` : ''}
                            ${r.score_semantico ? `<span>Similaridade: ${Math.round(r.score_semantico * 100)}%</span>` : ''}
                        </div>
                        <div class="tags">
                            ${(r.sumulas || []).map(s => `<span class="tag">${s}</span>`).join('')}
                            ${(r.temas || []).map(t => `<span class="tag tema">${t}</span>`).join('')}
                            ${obices.slice(0,3).map(o => `<span class="tag obice">${o}</span>`).join('')}
                        </div>
                        ${r.trecho ? `<div class="result-trecho">${r.trecho}</div>` : ''}
                    </div>
                `}).join('')}
            `;

            document.getElementById('resultados').innerHTML = html;
        }

        // ============================================================
        // FUNÇÕES DO MODAL
        // ============================================================

        async function abrirMinuta(docId, contextoExtra = null) {
            document.getElementById('modal-minuta').classList.add('active');
            document.getElementById('modal-titulo').textContent = 'Carregando...';
            document.getElementById('modal-conteudo').textContent = 'Carregando conteudo...';

            // Resetar seções de relevância
            document.getElementById('modal-relevancia').style.display = 'none';
            document.getElementById('trechos-relevantes').style.display = 'none';

            try {
                // Preparar contexto para a API
                let requestOptions = { method: 'GET' };
                const temContexto = contextoAtual.termos.length > 0 || contextoExtra;

                if (temContexto) {
                    // Buscar score específico desta minuta nos resultados
                    const resultadoMinuta = contextoAtual.resultados?.find(r => r.id === docId);
                    const score = contextoExtra?.score ||
                                  resultadoMinuta?.score_semantico ||
                                  resultadoMinuta?.relevancia?.score_total;

                    const contextoEnvio = {
                        termos: contextoExtra?.termos || contextoAtual.termos,
                        tipo: contextoExtra?.tipo || contextoAtual.tipo,
                        score: score,
                        obices_busca: contextoExtra?.obices_busca || contextoAtual.obices_busca,
                        categorias_busca: contextoExtra?.categorias_busca || contextoAtual.categorias_busca
                    };

                    requestOptions = {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(contextoEnvio)
                    };
                }

                const res = await fetch(`/api/minuta/${encodeURIComponent(docId)}`, requestOptions);
                const data = await res.json();

                if (data.erro) {
                    alert('Erro: ' + data.erro);
                    fecharModal();
                    return;
                }

                minutaAtual = data;

                // Preencher modal
                document.getElementById('modal-titulo').textContent = data.arquivo;

                // Metadados
                const categorias = data.categorias || [];
                const catNomes = categorias.map(c => c.categoria).join(', ') || '-';

                document.getElementById('modal-meta').innerHTML = `
                    <div class="modal-meta-item">
                        <label>Processo</label>
                        <span>${data.processo}</span>
                    </div>
                    <div class="modal-meta-item">
                        <label>Tipo</label>
                        <span>${data.tipo}</span>
                    </div>
                    <div class="modal-meta-item">
                        <label>Categorias</label>
                        <span>${catNomes}</span>
                    </div>
                    <div class="modal-meta-item">
                        <label>Sumulas</label>
                        <span>${(data.sumulas || []).join(', ') || '-'}</span>
                    </div>
                `;

                // Exibir seção de relevância se houver motivos
                if (data.relevancia && data.relevancia.motivos && data.relevancia.motivos.length > 0) {
                    const motivosHtml = data.relevancia.motivos.map(m => `<li>${m}</li>`).join('');
                    document.getElementById('relevancia-motivos').innerHTML = motivosHtml;
                    document.getElementById('modal-relevancia').style.display = 'block';
                }

                // Exibir trechos relevantes se houver
                if (data.trechos_relevantes && data.trechos_relevantes.length > 0) {
                    const trechosHtml = data.trechos_relevantes.map(t => `
                        <div class="trecho-item">
                            <span class="trecho-secao">${t.secao}</span>
                            <div class="trecho-texto">${t.texto_destacado || t.texto}</div>
                        </div>
                    `).join('');
                    document.getElementById('trechos-lista').innerHTML = trechosHtml;
                    document.getElementById('trechos-relevantes').style.display = 'block';
                }

                // Conteúdo completo (com ou sem destaques)
                if (data.conteudo_destacado) {
                    document.getElementById('modal-conteudo').innerHTML = data.conteudo_destacado;
                } else {
                    document.getElementById('modal-conteudo').textContent = data.conteudo_completo;
                }

                // Estrutura (com ou sem destaques)
                if (data.estrutura_destacada) {
                    document.getElementById('modal-ementa').innerHTML = data.estrutura_destacada.ementa || 'Ementa nao encontrada';
                    document.getElementById('modal-relatorio').innerHTML = data.estrutura_destacada.relatorio || 'Relatorio nao encontrado';
                    document.getElementById('modal-voto').innerHTML = data.estrutura_destacada.voto || 'Voto nao encontrado';
                } else {
                    document.getElementById('modal-ementa').textContent = data.estrutura?.ementa || 'Ementa nao encontrada';
                    document.getElementById('modal-relatorio').textContent = data.estrutura?.relatorio || 'Relatorio nao encontrado';
                    document.getElementById('modal-voto').textContent = data.estrutura?.voto || 'Voto nao encontrado';
                }

                // Precedentes
                const precsHtml = (data.precedentes || []).map(p =>
                    `<span class="tag">${p.tipo} ${p.numero}/${p.uf}</span>`
                ).join('');
                document.getElementById('modal-precedentes').innerHTML = precsHtml || '<span style="color:#666">Nenhum precedente encontrado</span>';

                // Botão abrir arquivo
                document.getElementById('btn-abrir-arquivo').onclick = () => abrirArquivo(docId);

                // Carregar similares
                carregarSimilares(docId);

            } catch (e) {
                console.error('Erro:', e);
                alert('Erro ao carregar minuta');
                fecharModal();
            }
        }

        async function carregarSimilares(docId) {
            document.getElementById('modal-similares').innerHTML = '<li>Buscando minutas similares...</li>';

            try {
                const res = await fetch(`/api/minuta/similar/${encodeURIComponent(docId)}`);
                const data = await res.json();

                if (data.similares && data.similares.length > 0) {
                    document.getElementById('modal-similares').innerHTML = data.similares.map(s => `
                        <li onclick="fecharModal(); abrirMinuta('${s.id}')">
                            ${s.arquivo}
                            <span class="score">${Math.round(s.score * 100)}%</span>
                        </li>
                    `).join('');
                } else {
                    document.getElementById('modal-similares').innerHTML = '<li style="cursor:default">Nenhuma minuta similar encontrada</li>';
                }
            } catch (e) {
                document.getElementById('modal-similares').innerHTML = '<li style="cursor:default">Erro ao buscar similares</li>';
            }
        }

        async function abrirArquivo(docId) {
            try {
                const res = await fetch(`/api/minuta/${encodeURIComponent(docId)}/abrir`);
                const data = await res.json();

                if (data.sucesso) {
                    // Copiar caminho para clipboard e mostrar
                    await navigator.clipboard.writeText(data.caminho);
                    alert(`Caminho copiado para a area de transferencia:\n\n${data.caminho}\n\nCole no Explorador de Arquivos para abrir.`);
                } else {
                    alert('Erro: ' + data.erro);
                }
            } catch (e) {
                alert('Erro ao obter caminho do arquivo');
            }
        }

        function fecharModal(event) {
            if (event && event.target !== event.currentTarget) return;
            document.getElementById('modal-minuta').classList.remove('active');
            minutaAtual = null;

            // Resetar para aba "Completo"
            document.querySelectorAll('.content-tab').forEach(t => t.classList.remove('active'));
            document.querySelector('.content-tab[data-panel="completo"]').classList.add('active');
            document.querySelectorAll('.content-panel').forEach(p => p.classList.remove('active'));
            document.getElementById('panel-completo').classList.add('active');
        }

        function copiarConteudo() {
            if (minutaAtual) {
                navigator.clipboard.writeText(minutaAtual.conteudo_completo);
                alert('Conteudo copiado!');
            }
        }

        function copiarEmenta() {
            if (minutaAtual && minutaAtual.estrutura?.ementa) {
                navigator.clipboard.writeText(minutaAtual.estrutura.ementa);
                alert('Ementa copiada!');
            } else {
                alert('Ementa nao encontrada');
            }
        }

        // Fechar modal com ESC
        document.addEventListener('keydown', e => {
            if (e.key === 'Escape') fecharModal();
        });

        // Indexar
        async function indexar(reindexar = false) {
            const btn = document.getElementById(reindexar ? 'btn-reindexar' : 'btn-indexar');
            const textoOriginal = btn.textContent;
            btn.disabled = true;
            btn.textContent = 'Indexando...';

            try {
                const res = await fetch('/api/indexar', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({reindexar})
                });
                const data = await res.json();

                if (data.sucesso) {
                    alert(`Indexacao concluida!\n\nNovas: ${data.novas_minutas}\nErros: ${data.erros}\nTotal: ${data.total_minutas}\nPrecedentes: ${data.total_precedentes}`);
                    carregarStats();
                    carregarCategorias();
                    carregarObices();
                    carregarPrecedentesTop();
                } else {
                    alert('Erro: ' + data.erro);
                }
            } catch (e) {
                alert('Erro: ' + e.message);
            }

            btn.disabled = false;
            btn.textContent = textoOriginal;
        }

        // Enter para buscar
        document.getElementById('input-texto').addEventListener('keypress', e => { if (e.key === 'Enter') buscarTexto(); });
        document.getElementById('input-sumula').addEventListener('keypress', e => { if (e.key === 'Enter') buscarSumula(); });
        document.getElementById('input-tema').addEventListener('keypress', e => { if (e.key === 'Enter') buscarTema(); });
        document.getElementById('input-precedente').addEventListener('keypress', e => { if (e.key === 'Enter') buscarPrecedente(); });
        document.getElementById('filtro-texto').addEventListener('keypress', e => { if (e.key === 'Enter') buscarCombinado(); });

        // ============================================================
        // BUSCA COMBINADA
        // ============================================================

        // Carregar opções dos filtros
        async function carregarFiltrosCombinados() {
            // Carregar temas (categorias de mérito)
            try {
                const res = await fetch('/api/categorias');
                const data = await res.json();
                const select = document.getElementById('filtro-tema');

                data.categorias.forEach(cat => {
                    const opt = document.createElement('option');
                    opt.value = cat.categoria;
                    opt.textContent = `${cat.categoria} (${cat.quantidade})`;
                    select.appendChild(opt);
                });
            } catch (e) { console.error('Erro carregando temas:', e); }

            // Carregar óbices
            try {
                const res = await fetch('/api/obices/categorias');
                const data = await res.json();
                const select = document.getElementById('filtro-obice');

                // Agrupar por categoria
                for (const [cat, obices] of Object.entries(data.categorias || {})) {
                    const optgroup = document.createElement('optgroup');
                    optgroup.label = cat;

                    obices.forEach(o => {
                        const opt = document.createElement('option');
                        opt.value = o.obice;
                        opt.textContent = `${o.obice} (${o.quantidade})`;
                        optgroup.appendChild(opt);
                    });

                    select.appendChild(optgroup);
                }
            } catch (e) { console.error('Erro carregando óbices:', e); }
        }

        // Busca combinada
        async function buscarCombinado() {
            const tema = document.getElementById('filtro-tema').value;
            const obiceCat = document.getElementById('filtro-obice-cat').value;
            const obice = document.getElementById('filtro-obice').value;
            const resultado = document.getElementById('filtro-resultado').value;
            const texto = document.getElementById('filtro-texto').value;

            // Verificar se pelo menos um filtro foi selecionado
            if (!tema && !obiceCat && !obice && !resultado && !texto) {
                alert('Selecione pelo menos um filtro');
                return;
            }

            document.getElementById('resultados').innerHTML = '<div class="loading">Buscando</div>';

            // Mostrar filtros ativos
            const filtrosAtivos = [];
            if (tema) filtrosAtivos.push(`Tema: ${tema}`);
            if (obiceCat) filtrosAtivos.push(`Cat. Óbice: ${obiceCat}`);
            if (obice) filtrosAtivos.push(`Óbice: ${obice}`);
            if (resultado) filtrosAtivos.push(`Resultado: ${resultado}`);
            if (texto) filtrosAtivos.push(`Texto: "${texto}"`);

            const filtrosDiv = document.getElementById('filtros-ativos');
            if (filtrosAtivos.length > 0) {
                filtrosDiv.style.display = 'block';
                document.getElementById('filtros-ativos-lista').innerHTML =
                    filtrosAtivos.map(f => `<span class="tag-filtro">${f}</span>`).join('');
            } else {
                filtrosDiv.style.display = 'none';
            }

            try {
                const res = await fetch('/api/buscar/combinado', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        tema,
                        obice_categoria: obiceCat,
                        obice,
                        resultado,
                        texto
                    })
                });
                const data = await res.json();

                // Salvar contexto da busca combinada para usar no modal
                const termosTexto = texto ? texto.split(/\s+/).filter(t => t.length > 2) : [];
                contextoAtual = {
                    termos: termosTexto,
                    tipo: 'busca',
                    resultados: data.resultados || [],
                    obices_busca: obice ? [obice] : [],
                    categorias_busca: tema ? [tema] : []
                };

                exibirResultadosCombinados(data.resultados, filtrosAtivos.join(' + '));
            } catch (e) {
                console.error('Erro:', e);
                document.getElementById('resultados').innerHTML = '<div class="empty-state"><p>Erro na busca</p></div>';
            }
        }

        // Variável para controlar visualização
        let visualizacaoExpandida = true;

        // Exibir resultados com informações detalhadas de óbice e resultado
        function exibirResultadosCombinados(resultados, titulo) {
            if (!resultados || resultados.length === 0) {
                document.getElementById('resultados').innerHTML = '<div class="empty-state"><p>Nenhum resultado encontrado</p></div>';
                return;
            }

            const html = `
                <div class="results-header">
                    <h2>Busca Combinada</h2>
                    <span class="results-count">${resultados.length} resultado(s)</span>
                </div>

                <div class="view-toggle">
                    <span class="toggle-label">Compacto</span>
                    <label class="toggle-switch">
                        <input type="checkbox" id="toggle-view" ${visualizacaoExpandida ? 'checked' : ''} onchange="toggleVisualizacao()">
                        <span class="toggle-slider"></span>
                    </label>
                    <span class="toggle-label">Expandido</span>
                </div>

                <div id="resultados-lista">
                    ${resultados.map(r => gerarCardExpandido(r)).join('')}
                </div>
            `;

            document.getElementById('resultados').innerHTML = html;
        }

        // Gerar card expandido para cada resultado
        function gerarCardExpandido(r) {
            const categorias = r.categorias || [];
            const obices = r.obices || [];
            const resultado = r.resultado || {};
            const catPrincipal = categorias[0]?.categoria || '';
            const docId = r.id || r.arquivo.replace('.docx', '').replace(/ /g, '_');

            // Badge de resultado
            let resultadoBadgeClass = '';
            const resTipo = (resultado.tipo || '').toLowerCase();
            if (resTipo.includes('não conhecido') || resTipo.includes('nao conhecido')) resultadoBadgeClass = 'nao-conhecido';
            else if (resTipo.includes('desprovido')) resultadoBadgeClass = 'desprovido';
            else if (resTipo.includes('parcial')) resultadoBadgeClass = 'parcial';
            else if (resTipo.includes('provido')) resultadoBadgeClass = 'provido';

            // Óbices em formato compacto para o header
            const obicesCompacto = obices.slice(0, 2).map(o => {
                const nome = typeof o === 'object' ? o.obice : o;
                return `<span class="tag obice">${nome}</span>`;
            }).join('');

            // Óbices detalhados para o body
            const obicesDetalhado = obices.map(o => {
                if (typeof o === 'object') {
                    return `<div class="obice-detalhe">
                        <span class="obice-nome">${o.obice}</span>
                        <span class="obice-cat"> - ${o.descricao || o.categoria}</span>
                    </div>`;
                }
                return `<span class="tag obice">${o}</span>`;
            }).join('');

            // Verificar se tem conteúdo para mostrar
            const temEmenta = r.ementa && r.ementa.trim().length > 0;
            const temTrecho = r.trecho && r.trecho.trim().length > 0;
            const temDispositivo = r.dispositivo && r.dispositivo.trim().length > 0;

            return `
            <div class="result-card-expandido ${visualizacaoExpandida ? '' : 'result-card-compacto'}">
                <div class="result-card-header" onclick="abrirMinuta('${docId}')">
                    <div class="result-card-info">
                        <h4>${r.arquivo}</h4>
                        <div class="meta">
                            Processo: ${r.processo}
                            ${catPrincipal ? ` | Tema: ${catPrincipal}` : ''}
                        </div>
                    </div>
                    <div class="result-card-badges">
                        ${obicesCompacto}
                        <span class="resultado-badge ${resultadoBadgeClass}">${resultado.tipo || 'Indefinido'}</span>
                    </div>
                </div>

                <div class="result-card-body">
                    ${temEmenta ? `
                    <div class="result-section">
                        <div class="result-section-title">Ementa</div>
                        <div class="result-section-content ementa">${r.ementa}</div>
                    </div>
                    ` : ''}

                    ${obices.length > 0 ? `
                    <div class="result-section">
                        <div class="result-section-title">Obices Aplicados</div>
                        <div class="result-obices-row">${obicesDetalhado}</div>
                    </div>
                    ` : ''}

                    ${temTrecho ? `
                    <div class="result-section">
                        <div class="result-section-title">Trecho Relevante</div>
                        <div class="result-section-content trecho">${r.trecho}</div>
                    </div>
                    ` : ''}

                    ${temDispositivo ? `
                    <div class="result-section">
                        <div class="result-section-title">Dispositivo</div>
                        <div class="result-section-content dispositivo">${r.dispositivo}</div>
                    </div>
                    ` : ''}
                </div>

                <div class="result-card-footer">
                    <div class="tags">
                        ${(r.sumulas || []).map(s => `<span class="tag">${s}</span>`).join('')}
                        ${(r.temas || []).map(t => `<span class="tag tema">${t}</span>`).join('')}
                    </div>
                    <button class="btn-ver-completo" onclick="event.stopPropagation(); abrirMinuta('${docId}')">
                        Ver Completo
                    </button>
                </div>
            </div>
            `;
        }

        // Toggle entre visualização compacta e expandida
        function toggleVisualizacao() {
            visualizacaoExpandida = document.getElementById('toggle-view').checked;
            document.querySelectorAll('.result-card-expandido').forEach(card => {
                if (visualizacaoExpandida) {
                    card.classList.remove('result-card-compacto');
                } else {
                    card.classList.add('result-card-compacto');
                }
            });
        }

        // Limpar filtros
        function limparFiltros() {
            document.getElementById('filtro-tema').value = '';
            document.getElementById('filtro-obice-cat').value = '';
            document.getElementById('filtro-obice').value = '';
            document.getElementById('filtro-resultado').value = '';
            document.getElementById('filtro-texto').value = '';
            document.getElementById('filtros-ativos').style.display = 'none';
            document.getElementById('resultados').innerHTML = '<div class="empty-state"><p>Selecione filtros e clique em Buscar</p></div>';
        }

        // Inicializar
        carregarStats();
        carregarCategorias();
        carregarObices();
        carregarPrecedentesTop();
        verificarEmbeddings();
        carregarFiltrosCombinados();

        // ============================================================
        // SUGESTOR DE PARADIGMAS
        // ============================================================

        let textoRecursoAtual = '';
        let dadosComparacaoAtual = null;
        let loadingInterval = null;
        let loadingStartTime = null;
        let questoesAtuais = [];  // Armazena questões para edição
        let modoEdicaoQuestoes = false;
        let dadosAnaliseAtual = null;  // Armazena dados completos da análise

        // Gerar HTML do indicador de carregamento avancado
        function gerarLoadingAvancado() {
            return `
                <div class="loading-avancado">
                    <div class="loading-header">
                        <div class="loading-spinner"></div>
                        <span class="loading-titulo">Analisando Recurso Especial</span>
                    </div>
                    <div class="loading-etapas">
                        <div class="loading-etapa ativa" id="etapa-1">
                            <span class="etapa-icone ativa">1</span>
                            <span class="etapa-texto ativa">Extraindo texto e identificando estrutura...</span>
                        </div>
                        <div class="loading-etapa pendente" id="etapa-2">
                            <span class="etapa-icone pendente">2</span>
                            <span class="etapa-texto pendente">Analisando com IA Gemini...</span>
                        </div>
                        <div class="loading-etapa pendente" id="etapa-3">
                            <span class="etapa-icone pendente">3</span>
                            <span class="etapa-texto pendente">Buscando paradigmas similares na base...</span>
                        </div>
                        <div class="loading-etapa pendente" id="etapa-4">
                            <span class="etapa-icone pendente">4</span>
                            <span class="etapa-texto pendente">Consultando historico da planilha...</span>
                        </div>
                        <div class="loading-etapa pendente" id="etapa-5">
                            <span class="etapa-icone pendente">5</span>
                            <span class="etapa-texto pendente">Gerando sugestoes de busca no STJ...</span>
                        </div>
                    </div>
                    <div class="loading-tempo" id="loading-tempo">Tempo decorrido: 0s</div>
                    <div class="loading-dica">A analise com IA pode levar de 5 a 15 segundos</div>
                </div>
            `;
        }

        // Atualizar etapa do loading
        function atualizarEtapaLoading(numeroEtapa) {
            for (let i = 1; i <= 5; i++) {
                const etapa = document.getElementById(`etapa-${i}`);
                if (!etapa) continue;

                const icone = etapa.querySelector('.etapa-icone');
                const texto = etapa.querySelector('.etapa-texto');

                if (i < numeroEtapa) {
                    // Concluida
                    etapa.className = 'loading-etapa concluida';
                    icone.className = 'etapa-icone concluida';
                    icone.innerHTML = '&#10003;';
                    texto.className = 'etapa-texto concluida';
                } else if (i === numeroEtapa) {
                    // Ativa
                    etapa.className = 'loading-etapa ativa';
                    icone.className = 'etapa-icone ativa';
                    icone.textContent = i;
                    texto.className = 'etapa-texto ativa';
                } else {
                    // Pendente
                    etapa.className = 'loading-etapa pendente';
                    icone.className = 'etapa-icone pendente';
                    icone.textContent = i;
                    texto.className = 'etapa-texto pendente';
                }
            }
        }

        // Iniciar contador de tempo
        function iniciarContadorTempo() {
            loadingStartTime = Date.now();
            loadingInterval = setInterval(() => {
                const tempoEl = document.getElementById('loading-tempo');
                if (tempoEl) {
                    const segundos = Math.floor((Date.now() - loadingStartTime) / 1000);
                    tempoEl.textContent = `Tempo decorrido: ${segundos}s`;
                }
            }, 1000);
        }

        // Parar contador de tempo
        function pararContadorTempo() {
            if (loadingInterval) {
                clearInterval(loadingInterval);
                loadingInterval = null;
            }
        }

        // === Edição de Questões ===
        function toggleEdicaoQuestoes() {
            modoEdicaoQuestoes = !modoEdicaoQuestoes;
            const btn = document.getElementById('btn-toggle-edicao');
            if (btn) {
                btn.classList.toggle('ativo', modoEdicaoQuestoes);
                btn.innerHTML = modoEdicaoQuestoes
                    ? '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M5 13l4 4L19 7"></path></svg> Concluir'
                    : '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg> Editar';
            }
            renderizarQuestoes();
        }

        function renderizarQuestoes() {
            const container = document.getElementById('questoes-container');
            if (!container) return;

            if (modoEdicaoQuestoes) {
                // Modo edição
                container.innerHTML = `
                    <div class="questoes-editaveis">
                        ${questoesAtuais.map((q, idx) => `
                            <div class="questao-editavel" data-idx="${idx}">
                                <span class="questao-num">Q${idx + 1}</span>
                                <div class="questao-content">
                                    <input type="text" value="${escapeHtml(q.titulo)}"
                                           onchange="atualizarQuestao(${idx}, this.value)"
                                           placeholder="Descreva a questão jurídica">
                                    ${q.obice_descricao ? `<div class="questao-obice">${escapeHtml(q.obice_descricao)}</div>` : ''}
                                </div>
                                <button class="btn-remover" onclick="removerQuestao(${idx})" title="Remover questão">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <line x1="18" y1="6" x2="6" y2="18"></line>
                                        <line x1="6" y1="6" x2="18" y2="18"></line>
                                    </svg>
                                </button>
                            </div>
                        `).join('')}
                        <button class="btn-adicionar-questao" onclick="adicionarQuestao()">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <line x1="12" y1="5" x2="12" y2="19"></line>
                                <line x1="5" y1="12" x2="19" y2="12"></line>
                            </svg>
                            Adicionar Questao
                        </button>
                        <div class="questoes-acoes">
                            <button class="btn-rebuscar" onclick="rebuscarComQuestoesEditadas()">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polyline points="23 4 23 10 17 10"></polyline>
                                    <path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"></path>
                                </svg>
                                Rebuscar Paradigmas
                            </button>
                        </div>
                    </div>
                `;
            } else {
                // Modo visualização
                container.innerHTML = questoesAtuais.length > 0
                    ? questoesAtuais.map((q, idx) => `
                        <div class="questao-badge">
                            <span class="questao-num">Q${idx + 1}</span>
                            <span class="questao-titulo">${escapeHtml(q.titulo)}</span>
                            ${q.obice_descricao ? `<span class="questao-desc">${escapeHtml(q.obice_descricao)}</span>` : ''}
                            ${gerarBadgeConfianca(q.confianca)}
                        </div>
                    `).join('')
                    : '<span style="color:#888">Nenhuma questao identificada</span>';
            }
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function gerarBadgeConfianca(confianca) {
            if (confianca === undefined || confianca === null) return '';

            const percent = Math.round(confianca * 100);
            let classe, texto;

            if (confianca >= 0.7) {
                classe = 'alta';
                texto = 'Alta';
            } else if (confianca >= 0.5) {
                classe = 'media';
                texto = 'Media';
            } else {
                classe = 'baixa';
                texto = 'Baixa';
            }

            return `
                <span class="confianca-badge confianca-${classe}" title="Confianca da IA: ${percent}%">
                    <span class="confianca-bar">
                        <span class="confianca-bar-fill ${classe}" style="width: ${percent}%"></span>
                    </span>
                    ${percent}%
                </span>
            `;
        }

        function atualizarQuestao(idx, novoTitulo) {
            if (idx >= 0 && idx < questoesAtuais.length) {
                questoesAtuais[idx].titulo = novoTitulo;
                questoesAtuais[idx].editada = true;
            }
        }

        function removerQuestao(idx) {
            if (idx >= 0 && idx < questoesAtuais.length) {
                questoesAtuais.splice(idx, 1);
                renderizarQuestoes();
            }
        }

        function adicionarQuestao() {
            questoesAtuais.push({
                titulo: '',
                obice: null,
                obice_descricao: '',
                editada: true
            });
            renderizarQuestoes();
            // Focar no novo input
            setTimeout(() => {
                const inputs = document.querySelectorAll('.questao-editavel input');
                if (inputs.length > 0) {
                    inputs[inputs.length - 1].focus();
                }
            }, 100);
        }

        async function rebuscarComQuestoesEditadas() {
            // Validar que há questões
            const questoesValidas = questoesAtuais.filter(q => q.titulo && q.titulo.trim().length > 0);
            if (questoesValidas.length === 0) {
                alert('Adicione pelo menos uma questao juridica.');
                return;
            }

            const btn = document.querySelector('.btn-rebuscar');
            const resultado = document.getElementById('resultado-paradigmas');

            btn.disabled = true;
            btn.innerHTML = '<span class="loading-spinner" style="width:14px;height:14px;border-width:2px;display:inline-block;vertical-align:middle;margin-right:8px;"></span> Rebuscando...';

            try {
                // Buscar paradigmas com questões editadas
                const res = await fetch('/api/rebuscar-paradigmas', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        texto: textoRecursoAtual,
                        questoes: questoesValidas,
                        analise_original: dadosAnaliseAtual ? dadosAnaliseAtual.analise : null
                    })
                });

                const data = await res.json();

                // Atualizar dados e reexibir
                data.questoes_identificadas = questoesValidas;
                data.fonte_questoes = 'manual';

                // Manter outros dados da análise original
                if (dadosAnaliseAtual) {
                    data.analise = dadosAnaliseAtual.analise;
                    data.sugestoes_historico = dadosAnaliseAtual.sugestoes_historico || [];
                    data.teses_similares = dadosAnaliseAtual.teses_similares || [];
                }

                // Sair do modo edição
                modoEdicaoQuestoes = false;

                exibirResultadoParadigmas(data);

            } catch (e) {
                console.error('Erro ao rebuscar:', e);
                alert('Erro ao rebuscar paradigmas. Tente novamente.');
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="23 4 23 10 17 10"></polyline><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"></path></svg> Rebuscar Paradigmas';
            }
        }

        async function analisarRecurso() {
            const texto = document.getElementById('texto-recurso').value.trim();

            if (!texto || texto.length < 100) {
                alert('Por favor, cole o texto do Recurso Especial. O texto deve ter pelo menos 100 caracteres.');
                return;
            }

            textoRecursoAtual = texto;

            const btn = document.getElementById('btn-analisar');
            const status = document.getElementById('status-analise');
            const resultado = document.getElementById('resultado-paradigmas');

            btn.disabled = true;
            btn.innerHTML = '<span class="loading-spinner" style="width:16px;height:16px;border-width:2px;display:inline-block;vertical-align:middle;margin-right:8px;"></span> Analisando...';
            status.textContent = '';
            resultado.innerHTML = gerarLoadingAvancado();
            iniciarContadorTempo();

            // Simular progresso das etapas (estimativa baseada em tempos medios)
            setTimeout(() => atualizarEtapaLoading(2), 1500);   // 1.5s - Comecar IA
            setTimeout(() => atualizarEtapaLoading(3), 6000);   // 6s - Buscar paradigmas
            setTimeout(() => atualizarEtapaLoading(4), 8000);   // 8s - Historico
            setTimeout(() => atualizarEtapaLoading(5), 10000);  // 10s - STJ

            try {
                const res = await fetch('/api/sugerir-paradigmas', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({texto, n_sugestoes: 10})
                });

                const data = await res.json();
                pararContadorTempo();

                if (data.erro) {
                    resultado.innerHTML = `<div class="empty-state"><p>Erro: ${data.erro}</p></div>`;
                    status.textContent = '';
                    return;
                }

                // Salvar contexto do Sugestor para usar no modal
                const analise = data.analise || {};
                const questoes = data.questoes_identificadas || [];

                // Extrair termos relevantes das questões e análise
                const termosParadigma = [];
                questoes.forEach(q => {
                    if (q.palavras_chave) termosParadigma.push(...q.palavras_chave);
                    if (q.titulo) {
                        // Extrair palavras significativas do título
                        const palavrasTitulo = q.titulo.split(/\s+/).filter(p => p.length > 4);
                        termosParadigma.push(...palavrasTitulo.slice(0, 5));
                    }
                });
                if (analise.palavras_chave) termosParadigma.push(...analise.palavras_chave);

                // Extrair óbices e categorias
                const obicesAnalise = (analise.obices_sugeridos || []).map(o => o.obice);
                const categoriasAnalise = (analise.categorias || []).map(c => c.categoria);

                // Construir lista de todos os paradigmas para referência
                const todosParadigmas = [];
                (data.paradigmas_por_questao || []).forEach(pq => {
                    (pq.paradigmas || []).forEach(p => {
                        todosParadigmas.push({
                            id: p.id,
                            score_semantico: p.relevancia?.score_total,
                            relevancia: p.relevancia
                        });
                    });
                });

                contextoAtual = {
                    termos: [...new Set(termosParadigma)].slice(0, 15), // Máximo 15 termos únicos
                    tipo: 'paradigma',
                    resultados: todosParadigmas,
                    obices_busca: obicesAnalise,
                    categorias_busca: categoriasAnalise
                };

                // Gerar estratégias de busca para o STJ (por questão)
                try {
                    const resBuscaSTJ = await fetch('/api/gerar-busca-stj', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({
                            texto: texto,
                            metadados: {
                                questoes: questoes,  // Passar questões identificadas
                                sumulas: analise.sumulas || [],
                                categorias: analise.categorias || [],
                                obices: analise.obices_sugeridos || []
                            }
                        })
                    });
                    const dataBuscaSTJ = await resBuscaSTJ.json();
                    data.estrategias_stj = dataBuscaSTJ;
                } catch (errSTJ) {
                    console.warn('Erro ao gerar estratégias STJ:', errSTJ);
                    data.estrategias_stj = { por_questao: [], total_questoes: 0, total_estrategias: 0 };
                }

                exibirResultadoParadigmas(data);
                status.textContent = `Analisadas ${data.total_analisados} minutas. Busca semantica: ${data.embeddings_ativos ? 'Ativa' : 'Inativa'}`;

            } catch (e) {
                console.error('Erro:', e);
                resultado.innerHTML = '<div class="empty-state"><p>Erro ao analisar. Tente novamente.</p></div>';
                status.textContent = 'Erro na analise';
            } finally {
                pararContadorTempo();
                btn.disabled = false;
                btn.innerHTML = 'Analisar e Sugerir Paradigmas';
            }
        }

        function exibirResultadoParadigmas(data) {
            const analise = data.analise;
            const questoes = data.questoes_identificadas || [];
            const paradigmasPorQuestao = data.paradigmas_por_questao || [];
            const paradigmasCompletos = data.paradigmas_completos || [];
            const fonteQuestoes = data.fonte_questoes || 'fallback';
            const iaDisponivel = data.ia_disponivel || false;
            const estrategiasSTJ = data.estrategias_stj || { estrategias: [], total: 0 };
            const sugestoesHistorico = data.sugestoes_historico || [];
            const tesesSimilares = data.teses_similares || [];

            // Armazenar dados para edição
            questoesAtuais = JSON.parse(JSON.stringify(questoes));  // Deep copy
            dadosAnaliseAtual = data;
            modoEdicaoQuestoes = false;  // Reset modo edição

            // Badge indicando fonte da analise
            let fonteBadge = '';
            if (fonteQuestoes === 'gemini') {
                fonteBadge = '<span style="background:#10b981; color:white; padding:2px 8px; border-radius:4px; font-size:0.75em; margin-left:10px;">IA Gemini</span>';
            } else if (fonteQuestoes === 'manual') {
                fonteBadge = '<span style="background:#3b82f6; color:white; padding:2px 8px; border-radius:4px; font-size:0.75em; margin-left:10px;">Editado Manualmente</span>';
            } else {
                fonteBadge = '<span style="background:#f59e0b; color:white; padding:2px 8px; border-radius:4px; font-size:0.75em; margin-left:10px;" title="IA indisponivel, usando templates">Modo Local</span>';
            }

            let html = `
                <!-- Analise do Documento -->
                <div class="analise-resultado">
                    <div class="analise-header">
                        <h3>Analise do Recurso Especial ${fonteBadge}</h3>
                        <span style="color:#666; font-size:0.9em;">${questoes.length} questao(oes) identificada(s)</span>
                    </div>

                    <div class="analise-grid">
                        <!-- Questoes identificadas com botão de edição -->
                        <div class="analise-section questoes" style="grid-column: 1 / -1;">
                            <div class="questoes-header">
                                <h4>Questoes Juridicas Distintas</h4>
                                <button class="btn-toggle-edicao" id="btn-toggle-edicao" onclick="toggleEdicaoQuestoes()">
                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                                        <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                                    </svg>
                                    Editar
                                </button>
                            </div>
                            <div class="questoes-identificadas" id="questoes-container">
                                ${questoes.length > 0
                                    ? questoes.map((q, idx) => `
                                        <div class="questao-badge">
                                            <span class="questao-num">Q${idx + 1}</span>
                                            <span class="questao-titulo">${q.titulo}</span>
                                            ${q.obice_descricao ? `<span class="questao-desc">${q.obice_descricao}</span>` : ''}
                                            ${gerarBadgeConfianca(q.confianca)}
                                        </div>
                                    `).join('')
                                    : '<span style="color:#888">Nenhuma questao identificada</span>'
                                }
                            </div>
                        </div>

                        <!-- Temas identificados -->
                        <div class="analise-section temas">
                            <h4>Temas</h4>
                            <div class="analise-items">
                                ${analise.categorias.length > 0
                                    ? analise.categorias.map(c => `
                                        <span class="analise-item tema">${c.categoria}</span>
                                    `).join('')
                                    : '<span style="color:#888">-</span>'
                                }
                            </div>
                        </div>

                        <!-- Materias -->
                        <div class="analise-section obices">
                            <h4>Materias Debatidas</h4>
                            <div class="analise-items">
                                ${analise.questoes_juridicas.length > 0
                                    ? analise.questoes_juridicas.map(q => `
                                        <span class="analise-item questao">${q}</span>
                                    `).join('')
                                    : '<span style="color:#888">-</span>'
                                }
                            </div>
                        </div>
                    </div>
                </div>

                <!-- NOVO: Sugestoes do Historico (Fase 4) -->
                ${(sugestoesHistorico.length > 0 || tesesSimilares.length > 0) ? `
                <div class="historico-sugestoes-painel">
                    <div class="historico-header" onclick="togglePainelHistorico()">
                        <h3>
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: middle; margin-right: 8px;">
                                <path d="M12 8v4l3 3"></path>
                                <circle cx="12" cy="12" r="10"></circle>
                            </svg>
                            Em Casos Similares Voce Usou...
                        </h3>
                        <div class="historico-meta">
                            <span class="historico-badge">${tesesSimilares.length} caso(s) similar(es) encontrado(s)</span>
                            <span class="toggle-icon" id="icon-historico-painel">▼</span>
                        </div>
                    </div>
                    <p class="historico-desc">Baseado no seu historico de minutas registradas na planilha</p>

                    <div class="historico-lista" id="historico-lista">
                        ${tesesSimilares.map((tese, idx) => `
                            <div class="historico-card ${idx === 0 ? 'historico-destaque' : ''}">
                                <div class="historico-card-header">
                                    <span class="historico-score" title="Score de similaridade: ${(tese.score_total * 100).toFixed(0)}%">
                                        ${(tese.score_total * 100).toFixed(0)}% similar
                                    </span>
                                    <span class="historico-arquivo">${tese.arquivo}</span>
                                </div>
                                <div class="historico-tese">
                                    <strong>Tese:</strong> ${escapeHtml(tese.tese_resumo)}
                                </div>
                                ${tese.obices_planilha && tese.obices_planilha.length > 0 ? `
                                    <div class="historico-obices">
                                        <strong>Obices aplicados:</strong>
                                        ${tese.obices_planilha.map(o => `<span class="obice-tag">${escapeHtml(o)}</span>`).join('')}
                                    </div>
                                ` : ''}
                                ${tese.documento_base ? `
                                    <div class="historico-docbase">
                                        <strong>Documento-base usado:</strong> ${escapeHtml(tese.documento_base)}
                                    </div>
                                ` : ''}
                                ${tese.dispositivo ? `
                                    <div class="historico-dispositivo">
                                        <strong>Resultado:</strong> ${escapeHtml(tese.dispositivo)}
                                    </div>
                                ` : ''}
                                ${tese.termos_match && tese.termos_match.length > 0 ? `
                                    <div class="historico-termos">
                                        <strong>Termos em comum:</strong>
                                        ${tese.termos_match.map(t => `<span class="termo-tag">${escapeHtml(t)}</span>`).join('')}
                                    </div>
                                ` : ''}
                                <div class="historico-acoes">
                                    <button class="btn-historico" onclick="abrirMinuta('${tese.id}')">
                                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                                            <circle cx="12" cy="12" r="3"></circle>
                                        </svg>
                                        Ver Minuta
                                    </button>
                                    <button class="btn-historico btn-copiar-tese" onclick="copiarTexto('${escapeHtml(tese.tese_resumo).replace(/'/g, "\\'")}')">
                                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                                            <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                                        </svg>
                                        Copiar Tese
                                    </button>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
                ` : ''}

                <!-- Painel de Busca no STJ - Organizado por Questão -->
                ${(estrategiasSTJ.por_questao && estrategiasSTJ.por_questao.length > 0) ? `
                <div class="stj-busca-painel">
                    <div class="stj-busca-header" onclick="togglePainelSTJ()">
                        <h3>
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: middle; margin-right: 8px;">
                                <circle cx="11" cy="11" r="8"></circle>
                                <path d="m21 21-4.35-4.35"></path>
                            </svg>
                            Pesquisar no Site do STJ
                        </h3>
                        <div class="stj-busca-meta">
                            <span class="stj-badge">${estrategiasSTJ.total_estrategias} sugestao(oes) em ${estrategiasSTJ.total_questoes} questao(oes)</span>
                            <span class="toggle-icon" id="icon-stj-painel">▼</span>
                        </div>
                    </div>
                    <p class="stj-busca-desc">Clique em "Pesquisar no STJ" para abrir a busca diretamente no site oficial</p>

                    <div class="stj-estrategias" id="stj-estrategias-lista">
                        ${estrategiasSTJ.por_questao.map((pq, qIdx) => `
                            <div class="stj-questao-section">
                                <div class="stj-questao-header" onclick="toggleQuestaoSTJ('stj-q-${qIdx}')">
                                    <div class="stj-questao-info">
                                        <span class="stj-questao-num">Q${qIdx + 1}</span>
                                        <span class="stj-questao-titulo">${escapeHtml(pq.questao.titulo)}</span>
                                    </div>
                                    <div class="stj-questao-meta">
                                        <span class="stj-questao-count">${pq.estrategias.length} sugestao(oes)</span>
                                        <span class="toggle-icon" id="icon-stj-q-${qIdx}">▼</span>
                                    </div>
                                </div>
                                <div class="stj-questao-estrategias" id="stj-q-${qIdx}">
                                    ${pq.estrategias.map((est, eIdx) => {
                                        const uniqueId = 'q' + qIdx + 'e' + eIdx;
                                        // Registrar string no objeto global para evitar problemas com caracteres especiais
                                        window.stjStrings = window.stjStrings || {};
                                        window.stjStrings[uniqueId] = est.string_busca;
                                        return `
                                        <div class="stj-estrategia-card stj-tipo-${est.tipo}">
                                            <div class="stj-estrategia-header">
                                                <span class="stj-tipo-badge stj-tipo-${est.tipo}">${getTipoLabel(est.tipo)}</span>
                                                <span class="stj-estrategia-titulo">${est.titulo}</span>
                                            </div>
                                            <p class="stj-estrategia-desc">${est.descricao}</p>
                                            <div class="stj-string-busca">
                                                <code id="stj-string-${uniqueId}">${escapeHtml(est.string_busca)}</code>
                                            </div>
                                            <div class="stj-acoes">
                                                <button class="stj-btn stj-btn-copiar" onclick="copiarStringSTJ('${uniqueId}', window.stjStrings['${uniqueId}'])">
                                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                        <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                                                        <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                                                    </svg>
                                                    Copiar
                                                </button>
                                                <button class="stj-btn stj-btn-pesquisar" onclick="abrirPesquisaSTJ('${uniqueId}')">
                                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                        <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path>
                                                        <polyline points="15 3 21 3 21 9"></polyline>
                                                        <line x1="10" y1="14" x2="21" y2="3"></line>
                                                    </svg>
                                                    Pesquisar no STJ
                                                </button>
                                            </div>
                                        </div>
                                    `}).join('')}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
                ` : ''}

                <!-- Paradigmas Completos (se houver) -->
                ${paradigmasCompletos.length > 0 ? `
                <div class="paradigmas-lista paradigmas-completos">
                    <div class="paradigmas-header" style="background: linear-gradient(to right, #fef3c7, #fcd34d); padding: 15px; border-radius: 10px; margin-bottom: 15px;">
                        <h3 style="color: #92400e; margin: 0; display: flex; align-items: center; gap: 10px;">
                            <span style="font-size: 1.3em;">★</span> Paradigmas Completos
                        </h3>
                        <span style="color:#92400e; font-size:0.85em;">Abordam multiplas questoes do recurso</span>
                    </div>

                    ${paradigmasCompletos.map((p, idx) => gerarCardParadigmaCompleto(p, idx + 1)).join('')}
                </div>
                ` : ''}

                <!-- Paradigmas por Questao -->
                <div class="paradigmas-por-questao">
                    ${paradigmasPorQuestao.map((pq, idx) => `
                        <div class="questao-section">
                            <div class="questao-header" onclick="toggleQuestao('questao-${idx}')">
                                <div class="questao-titulo-header">
                                    <span class="questao-numero">Questao ${idx + 1}</span>
                                    <h4>${pq.questao.titulo}</h4>
                                    ${pq.questao.obice_descricao ? `<span class="questao-subtitulo">${pq.questao.obice_descricao}</span>` : ''}
                                </div>
                                <div class="questao-meta">
                                    <span class="paradigmas-count">${pq.paradigmas.length} paradigma(s)</span>
                                    <span class="toggle-icon" id="icon-questao-${idx}">▼</span>
                                </div>
                            </div>
                            <div class="questao-paradigmas" id="questao-${idx}">
                                ${pq.paradigmas.length > 0
                                    ? pq.paradigmas.map((p, pidx) => gerarCardParadigmaSimples(p, pidx + 1, pq.questao)).join('')
                                    : '<div class="empty-state" style="padding: 20px;"><p>Nenhum paradigma encontrado para esta questao. Considere indexar mais minutas com este obice.</p></div>'
                                }
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;

            document.getElementById('resultado-paradigmas').innerHTML = html;
        }

        // === Funções para integração com busca STJ ===

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function getTipoLabel(tipo) {
            const labels = {
                'sumula': 'Sumula',
                'legislacao': 'Legislacao',
                'obice': 'Obice',
                'tema': 'Tema',
                'tese': 'Tese',
                'especifica': 'Especifica',
                'moderada': 'Moderada',
                'ampla': 'Ampla',
                'variacao': 'Variacao'
            };
            return labels[tipo] || tipo;
        }

        // === Funcoes para Painel de Historico (Fase 4) ===

        function togglePainelHistorico() {
            const el = document.getElementById('historico-lista');
            const icon = document.getElementById('icon-historico-painel');
            if (el.style.display === 'none') {
                el.style.display = 'flex';
                icon.textContent = '▼';
            } else {
                el.style.display = 'none';
                icon.textContent = '▶';
            }
        }

        function copiarTexto(texto) {
            // Decodificar entidades HTML
            const div = document.createElement('div');
            div.innerHTML = texto;
            const textoLimpo = div.textContent || div.innerText || texto;

            navigator.clipboard.writeText(textoLimpo).then(() => {
                // Feedback visual
                const btn = event.target.closest('button');
                const textoOriginal = btn.innerHTML;
                btn.innerHTML = '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"></polyline></svg> Copiado!';
                setTimeout(() => {
                    btn.innerHTML = textoOriginal;
                }, 2000);
            }).catch(err => {
                console.error('Erro ao copiar:', err);
                alert('Erro ao copiar. Use Ctrl+C manualmente.');
            });
        }

        // === Funcoes para Painel de Busca STJ ===

        function togglePainelSTJ() {
            const el = document.getElementById('stj-estrategias-lista');
            const icon = document.getElementById('icon-stj-painel');
            if (el.style.display === 'none') {
                el.style.display = 'block';
                icon.textContent = '▼';
            } else {
                el.style.display = 'none';
                icon.textContent = '▶';
            }
        }

        function toggleQuestaoSTJ(id) {
            const el = document.getElementById(id);
            const icon = document.getElementById('icon-' + id);
            if (el.style.display === 'none') {
                el.style.display = 'block';
                icon.textContent = '▼';
            } else {
                el.style.display = 'none';
                icon.textContent = '▶';
            }
        }

        function copiarStringSTJ(idx, stringBusca) {
            // Decodificar a string
            const texto = stringBusca.replace(/\\'/g, "'");
            navigator.clipboard.writeText(texto).then(() => {
                // Feedback visual
                const btn = event.target.closest('button');
                const textoOriginal = btn.innerHTML;
                btn.innerHTML = '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"></polyline></svg> Copiado!';
                btn.style.background = '#10b981';
                setTimeout(() => {
                    btn.innerHTML = textoOriginal;
                    btn.style.background = '';
                }, 2000);
            }).catch(err => {
                console.error('Erro ao copiar:', err);
                alert('Erro ao copiar. Use Ctrl+C manualmente.');
            });
        }

        // Armazenar strings de busca STJ em objeto global para evitar problemas com caracteres especiais
        window.stjStrings = {};

        function abrirPesquisaSTJ(stringId) {
            // Buscar string do objeto global ou usar stringId como string direta
            const stringBusca = window.stjStrings[stringId] || decodeURIComponent(stringId);
            const url = 'https://scon.stj.jus.br/SCON/pesquisar.jsp?livre=' + encodeURIComponent(stringBusca);
            console.log('Abrindo STJ com URL:', url);
            window.open(url, '_blank');
        }

        function registrarStringSTJ(id, string) {
            window.stjStrings[id] = string;
        }

        // === Fim funções STJ ===

        function toggleQuestao(id) {
            const el = document.getElementById(id);
            const icon = document.getElementById('icon-' + id);
            if (el.style.display === 'none') {
                el.style.display = 'block';
                icon.textContent = '▼';
            } else {
                el.style.display = 'none';
                icon.textContent = '▶';
            }
        }

        function gerarCardParadigmaCompleto(p, posicao) {
            const relevancia = p.relevancia;
            const aderencia = relevancia.aderencia_percentual;
            const questoesAtendidas = p.questoes_atendidas || 0;
            const totalQuestoes = p.total_questoes || 1;

            const resultado = p.resultado || {};
            let resultadoBadgeClass = '';
            const resTipo = (resultado.tipo || '').toLowerCase();
            if (resTipo.includes('nao conhecido') || resTipo.includes('não conhecido')) resultadoBadgeClass = 'nao-conhecido';
            else if (resTipo.includes('desprovido')) resultadoBadgeClass = 'desprovido';
            else if (resTipo.includes('parcial')) resultadoBadgeClass = 'parcial';
            else if (resTipo.includes('provido')) resultadoBadgeClass = 'provido';

            const obices = p.obices || [];
            const obicesNomes = obices.map(o => typeof o === 'object' ? o.obice : o).slice(0, 4);

            return `
            <div class="paradigma-card paradigma-completo" style="border: 2px solid #fcd34d; background: linear-gradient(to bottom, #fffbeb, white);">
                <div class="paradigma-header">
                    <div class="paradigma-info">
                        <h4 style="color: #92400e;">★ ${p.arquivo}</h4>
                        <div class="meta">
                            Processo: ${p.processo}
                            ${resultado.tipo ? ` | <span class="resultado-badge ${resultadoBadgeClass}">${resultado.tipo}</span>` : ''}
                        </div>
                    </div>
                    <div class="paradigma-aderencia aderencia-alta">
                        <div class="aderencia-valor">${questoesAtendidas}/${totalQuestoes}</div>
                        <div class="aderencia-label">Questoes</div>
                        ${relevancia?.auditoria_texto
                            ? `<div class="auditoria-texto">Auditoria IA: ${relevancia.auditoria_texto}</div>`
                            : ''}
                    </div>
                </div>

                <div class="paradigma-motivos" style="background: #fef3c7;">
                    <h5 style="color: #92400e;">Cobre ${questoesAtendidas} questoes do recurso:</h5>
                    ${obicesNomes.map(o => `<span class="motivo-item">${o}</span>`).join('')}
                </div>

                <div class="paradigma-body">
                    ${p.ementa
                        ? `<div class="paradigma-ementa">${p.ementa}</div>`
                        : '<div class="paradigma-ementa" style="color:#888;">Ementa nao disponivel</div>'
                    }
                </div>

                <div class="paradigma-footer">
                    <div class="paradigma-tags">
                        ${(p.sumulas || []).slice(0, 3).map(s => `<span class="tag">${s}</span>`).join('')}
                    </div>
                    <div class="paradigma-acoes">
                        <button class="btn-paradigma comparar" onclick="abrirComparacao('${p.id}')">Comparar</button>
                        <button class="btn-paradigma primary" onclick="abrirMinuta('${p.id}')">Ver Completo</button>
                    </div>
                </div>
            </div>
            `;
        }

        function gerarCardParadigmaSimples(p, posicao, questao) {
            const relevancia = p.relevancia;
            const aderencia = relevancia.aderencia_percentual;

            let aderenciaClass = 'aderencia-baixa';
            if (aderencia >= 60) aderenciaClass = 'aderencia-alta';
            else if (aderencia >= 40) aderenciaClass = 'aderencia-media';

            const resultado = p.resultado || {};
            let resultadoBadgeClass = '';
            const resTipo = (resultado.tipo || '').toLowerCase();
            if (resTipo.includes('nao conhecido') || resTipo.includes('não conhecido')) resultadoBadgeClass = 'nao-conhecido';
            else if (resTipo.includes('desprovido')) resultadoBadgeClass = 'desprovido';
            else if (resTipo.includes('parcial')) resultadoBadgeClass = 'parcial';
            else if (resTipo.includes('provido')) resultadoBadgeClass = 'provido';

            return `
            <div class="paradigma-card paradigma-simples">
                <div class="paradigma-header">
                    <div class="paradigma-info">
                        <h4>#${posicao} - ${p.arquivo}</h4>
                        <div class="meta">
                            Processo: ${p.processo}
                            ${resultado.tipo ? ` | <span class="resultado-badge ${resultadoBadgeClass}">${resultado.tipo}</span>` : ''}
                        </div>
                    </div>
                    <div class="paradigma-aderencia ${aderenciaClass}">
                        <div class="aderencia-valor">${aderencia}%</div>
                        <div class="aderencia-label">Aderencia</div>
                        <div class="aderencia-bar">
                            <div class="aderencia-bar-fill" style="width: ${aderencia}%"></div>
                        </div>
                    ${relevancia?.auditoria_texto
                        ? `<div class="auditoria-texto">Auditoria IA: ${relevancia.auditoria_texto}</div>`
                        : ''}
                    </div>
                </div>

                <div class="paradigma-motivos">
                    <h5>Por que foi recomendado para esta questao?</h5>
                    ${relevancia.motivos.map(m => `<span class="motivo-item">${m}</span>`).join('')}
                </div>

                <div class="paradigma-body">
                    ${p.ementa
                        ? `<div class="paradigma-ementa">${p.ementa}</div>`
                        : '<div class="paradigma-ementa" style="color:#888;">Ementa nao disponivel</div>'
                    }
                </div>

                <div class="paradigma-footer">
                    <div class="paradigma-tags">
                        ${(p.sumulas || []).slice(0, 2).map(s => `<span class="tag">${s}</span>`).join('')}
                    </div>
                    <div class="paradigma-acoes">
                        <button class="btn-paradigma comparar" onclick="abrirComparacao('${p.id}')">Comparar</button>
                        <button class="btn-paradigma primary" onclick="abrirMinuta('${p.id}')">Ver</button>
                        <button class="btn-paradigma secondary" onclick="copiarEmentaParadigma('${p.id}', \`${(p.ementa || '').replace(/`/g, "'").replace(/\\/g, "\\\\")}\`)">Copiar</button>
                    </div>
                </div>
            </div>
            `;
        }

        function copiarEmentaParadigma(id, ementa) {
            if (ementa) {
                navigator.clipboard.writeText(ementa);
                alert('Ementa copiada!');
            } else {
                alert('Ementa nao disponivel');
            }
        }

        function limparAnalise() {
            document.getElementById('texto-recurso').value = '';
            document.getElementById('resultado-paradigmas').innerHTML = '';
            document.getElementById('status-analise').textContent = '';
            textoRecursoAtual = '';
        }

        // ============================================================
        // BANCO DE PRECEDENTES
        // ============================================================

        let dadosPrecedenteAtual = null;
        let classificacaoPrecedenteAtual = null;

        // Funções de tratamento de erro de API
        function mostrarErroApi(mensagem, tipoErro, permiteTrocarChave) {
            const container = document.getElementById('erro-api-prec');
            const msgEl = document.getElementById('erro-api-msg');
            const formChave = document.getElementById('form-trocar-chave');

            // Formatar mensagem baseada no tipo de erro
            let msgFormatada = mensagem;
            if (tipoErro === 'cota_excedida') {
                msgFormatada = '⚠️ Limite de cota da API excedido. ' + mensagem;
            } else if (tipoErro === 'api_invalida') {
                msgFormatada = '🔑 Chave API inválida ou expirada. ' + mensagem;
            } else if (tipoErro === 'api_nao_configurada') {
                msgFormatada = '⚙️ API não configurada. ' + mensagem;
            } else if (tipoErro === 'conexao') {
                msgFormatada = '🌐 Erro de conexão. ' + mensagem;
            }

            msgEl.textContent = msgFormatada;
            formChave.style.display = permiteTrocarChave ? 'block' : 'none';
            container.style.display = 'block';

            // Limpar input da chave
            document.getElementById('nova-api-key').value = '';
        }

        function fecharErroApi() {
            document.getElementById('erro-api-prec').style.display = 'none';
        }

        async function trocarApiKeyGemini() {
            const novaChave = document.getElementById('nova-api-key').value.trim();

            if (!novaChave) {
                alert('Digite a nova chave API.');
                return;
            }

            if (novaChave.length < 20) {
                alert('A chave API parece ser muito curta. Verifique se copiou corretamente.');
                return;
            }

            try {
                const res = await fetch('/api/gemini/atualizar-chave', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({chave: novaChave})
                });

                const data = await res.json();

                if (data.sucesso) {
                    alert('✅ Chave API atualizada com sucesso! Tente processar novamente.');
                    fecharErroApi();
                } else {
                    alert('❌ Erro ao atualizar chave: ' + (data.erro || 'Erro desconhecido'));
                }

            } catch (e) {
                console.error('Erro:', e);
                alert('Erro de conexão ao atualizar chave.');
            }
        }

        function trocarSubabaPrec(subtab) {
            // Esconder todas as sub-abas
            document.querySelectorAll('.banco-subtab').forEach(el => el.style.display = 'none');
            // Mostrar a selecionada
            document.getElementById(`subtab-${subtab}`).style.display = 'block';
            // Atualizar botões
            document.querySelectorAll('.banco-tab-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.subtab === subtab);
            });

            // Atualizar contador de precedentes
            atualizarTotalPrecedentes();

            // Carregar dados se necessário
            if (subtab === 'estatisticas') {
                carregarEstatisticasPrec();
            } else if (subtab === 'consultar') {
                carregarPrecedentesRecentes();
            }
        }

        async function processarEmenta() {
            const ementa = document.getElementById('ementa-input').value.trim();
            if (!ementa || ementa.length < 100) {
                alert('Cole uma ementa completa (minimo 100 caracteres).');
                return;
            }

            // Esconder erro anterior
            fecharErroApi();

            const btn = document.getElementById('btn-processar-ementa');
            btn.disabled = true;
            btn.innerHTML = '<span class="loading-spinner" style="width:16px;height:16px;border-width:2px;display:inline-block;vertical-align:middle;margin-right:8px;"></span> Processando...';

            try {
                // 1. Parse da ementa
                const resParse = await fetch('/api/banco-precedentes/parse', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ementa: ementa})
                });
                const dataParse = await resParse.json();

                if (!dataParse.sucesso) {
                    alert('Erro ao processar ementa: ' + (dataParse.erro || 'Erro desconhecido'));
                    return;
                }

                dadosPrecedenteAtual = dataParse.dados;

                // 2. Classificar com IA
                const resClassif = await fetch('/api/banco-precedentes/classificar', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        ementa: dadosPrecedenteAtual.ementa || ementa,
                        tese: dadosPrecedenteAtual.tese
                    })
                });
                const dataClassif = await resClassif.json();

                // Verificar se houve erro na classificação
                if (!dataClassif.sucesso) {
                    mostrarErroApi(dataClassif.erro, dataClassif.erro_tipo, dataClassif.permite_trocar_chave);
                    // Mesmo com erro na classificação, mostrar dados extraídos
                    classificacaoPrecedenteAtual = {};
                } else {
                    classificacaoPrecedenteAtual = dataClassif.classificacao || {};
                }

                // 3. Preencher preview (dados extraídos sempre aparecem)
                document.getElementById('prev-processo').textContent = dadosPrecedenteAtual.numero_processo || '-';
                document.getElementById('prev-relator').textContent = dadosPrecedenteAtual.relator || '-';
                document.getElementById('prev-orgao').textContent = dadosPrecedenteAtual.orgao_julgador || '-';
                document.getElementById('prev-data').textContent = dadosPrecedenteAtual.data_julgamento || '-';

                document.getElementById('prev-tema').value = classificacaoPrecedenteAtual.tema_principal || '';
                document.getElementById('prev-area').value = classificacaoPrecedenteAtual.area_direito || '';
                document.getElementById('prev-obices').value = (classificacaoPrecedenteAtual.obices_aplicados || []).join(', ');
                document.getElementById('prev-resultado').value = classificacaoPrecedenteAtual.resultado || '';

                // Mostrar preview
                document.getElementById('resultado-processamento').style.display = 'block';

            } catch (e) {
                console.error('Erro:', e);
                mostrarErroApi('Erro de conexão ao processar ementa: ' + e.message, 'conexao', false);
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="12" y1="18" x2="12" y2="12"></line><line x1="9" y1="15" x2="15" y2="15"></line></svg> Processar 1 Ementa';
            }
        }

        async function salvarPrecedente() {
            if (!dadosPrecedenteAtual) {
                alert('Processe uma ementa primeiro.');
                return;
            }

            // Coletar dados editados
            const obicesStr = document.getElementById('prev-obices').value;
            const obices = obicesStr ? obicesStr.split(',').map(o => o.trim()).filter(o => o) : [];

            const dadosCompletos = {
                ...dadosPrecedenteAtual,
                classificacao: {
                    ...classificacaoPrecedenteAtual,
                    tema_principal: document.getElementById('prev-tema').value,
                    area_direito: document.getElementById('prev-area').value,
                    obices_aplicados: obices,
                    resultado: document.getElementById('prev-resultado').value
                },
                anotacoes_pessoais: document.getElementById('prev-anotacoes').value
            };

            try {
                const res = await fetch('/api/banco-precedentes/salvar', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(dadosCompletos)
                });

                const data = await res.json();

                if (data.erro) {
                    mostrarToast('Erro: ' + data.erro, 'erro');
                } else {
                    mostrarToast('✓ Precedente salvo com sucesso!', 'sucesso');
                    limparFormPrec();
                    atualizarTotalPrecedentes();
                }

            } catch (e) {
                console.error('Erro:', e);
                mostrarToast('Erro ao salvar precedente', 'erro');
            }
        }

        function limparFormPrec() {
            document.getElementById('ementa-input').value = '';
            document.getElementById('resultado-processamento').style.display = 'none';
            document.getElementById('resultado-lote').style.display = 'none';
            document.getElementById('prev-anotacoes').value = '';
            fecharErroApi();
            dadosPrecedenteAtual = null;
            classificacaoPrecedenteAtual = null;
            atualizarContadorEmentas();
        }

        // Contador de ementas em tempo real
        function atualizarContadorEmentas() {
            const texto = document.getElementById('ementa-input').value.trim();
            if (!texto) {
                document.getElementById('num-ementas').textContent = '0';
                return;
            }

            // Detectar ementas por padrões comuns do STJ
            const padroes = [
                /\((?:AgInt|AREsp|REsp|AgRg|EDcl).*?\d{4,}.*?\)/gi,
                /ACÓRDÃO\s*ELETRÔNICO/gi,
                /EMENTA/gi
            ];

            let count = 0;
            for (const padrao of padroes) {
                const matches = texto.match(padrao);
                if (matches && matches.length > count) {
                    count = matches.length;
                }
            }

            // Se não encontrar padrões, contar por quebras de linha duplas (ementas geralmente separadas por \n\n)
            if (count === 0) {
                const blocos = texto.split(/\n\s*\n/).filter(b => b.trim().length > 100);
                count = blocos.length;
            }

            document.getElementById('num-ementas').textContent = count;
        }

        // Atualizar total de precedentes no header
        async function atualizarTotalPrecedentes() {
            try {
                const res = await fetch('/api/banco-precedentes/listar');
                const data = await res.json();
                const total = data.precedentes ? data.precedentes.length : 0;
                document.getElementById('total-precedentes').textContent = total;
            } catch (e) {
                console.error('Erro ao atualizar total:', e);
                document.getElementById('total-precedentes').textContent = '?';
            }
        }

        // Toast notification
        function mostrarToast(mensagem, tipo = 'sucesso') {
            // Remover toast anterior se existir
            const toastExistente = document.getElementById('toast-notification');
            if (toastExistente) {
                toastExistente.remove();
            }

            const cores = {
                sucesso: { bg: '#10b981', icon: '✓' },
                erro: { bg: '#ef4444', icon: '✗' },
                aviso: { bg: '#f59e0b', icon: '⚠' },
                info: { bg: '#3b82f6', icon: 'ℹ' }
            };

            const cor = cores[tipo] || cores.info;

            const toast = document.createElement('div');
            toast.id = 'toast-notification';
            toast.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${cor.bg};
                color: white;
                padding: 16px 24px;
                border-radius: 10px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                z-index: 10000;
                display: flex;
                align-items: center;
                gap: 12px;
                font-weight: 500;
                animation: slideInRight 0.3s ease;
                max-width: 400px;
            `;

            toast.innerHTML = `
                <span style="font-size: 1.2em;">${cor.icon}</span>
                <span>${mensagem}</span>
            `;

            document.body.appendChild(toast);

            setTimeout(() => {
                toast.style.animation = 'slideOutRight 0.3s ease';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        async function processarLote() {
            const texto = document.getElementById('ementa-input').value.trim();
            if (!texto || texto.length < 200) {
                alert('Cole pelo menos uma ementa completa.');
                return;
            }

            // Esconder erro anterior
            fecharErroApi();

            const btn = document.getElementById('btn-processar-lote');
            btn.disabled = true;
            btn.innerHTML = '<span class="loading-spinner" style="width:16px;height:16px;border-width:2px;display:inline-block;vertical-align:middle;margin-right:8px;"></span> Processando lote...';

            // Esconder resultados anteriores
            document.getElementById('resultado-processamento').style.display = 'none';
            document.getElementById('resultado-lote').style.display = 'none';

            try {
                const res = await fetch('/api/banco-precedentes/adicionar-lote', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({texto: texto})
                });

                const data = await res.json();

                // Verificar se houve erro geral
                if (data.erro && !data.detalhes) {
                    mostrarErroApi(data.erro, data.erro_tipo || 'outro', false);
                    return;
                }

                // Verificar se houve erro de API (cota, chave inválida, etc.)
                if (data.erro_ia) {
                    mostrarErroApi(data.erro_ia, data.erro_tipo, data.permite_trocar_chave);
                }

                // Mostrar resultado
                const detalhes = document.getElementById('lote-detalhes');
                const resultados = data.detalhes || [];
                const sucessos = resultados.filter(r => r.sucesso).length;
                const erros = resultados.filter(r => !r.sucesso);

                let html = `
                    <div style="margin-bottom: 15px; padding: 10px; background: ${sucessos > 0 ? '#dcfce7' : '#fee2e2'}; border-radius: 6px;">
                        <strong>${sucessos}</strong> precedente(s) salvo(s) com sucesso
                        ${erros.length > 0 ? ` | <strong>${erros.length}</strong> erro(s)` : ''}
                    </div>
                `;

                // Se houve erro de API, mostrar aviso específico
                if (data.erro_ia) {
                    html += `
                        <div style="margin-bottom: 15px; padding: 10px; background: #fef3c7; border-radius: 6px; border-left: 4px solid #f59e0b;">
                            <strong style="color: #92400e;">⚠ Processamento interrompido:</strong>
                            <span style="color: #78350f;">${data.erro_ia}</span>
                        </div>
                    `;
                }

                if (resultados.length > 0) {
                    html += '<div style="max-height: 300px; overflow-y: auto;">';
                    resultados.forEach(r => {
                        if (r.sucesso) {
                            html += `<div style="padding: 8px; margin: 4px 0; background: #f0fdf4; border-radius: 4px; font-size: 0.9em;">
                                <span style="color: #166534;">✓</span> ${r.numero || 'Sem numero'}
                            </div>`;
                        } else {
                            html += `<div style="padding: 8px; margin: 4px 0; background: #fef2f2; border-radius: 4px; font-size: 0.9em;">
                                <span style="color: #dc2626;">✗</span> ${r.numero || 'Desconhecido'}: ${r.erro || 'Erro'}
                            </div>`;
                        }
                    });
                    html += '</div>';
                }

                detalhes.innerHTML = html;
                document.getElementById('resultado-lote').style.display = 'block';

                // Mostrar toast com resultado
                if (sucessos > 0 && erros.length === 0 && !data.erro_ia) {
                    mostrarToast(`✓ ${sucessos} precedente(s) processado(s) com sucesso!`, 'sucesso');
                    document.getElementById('ementa-input').value = '';
                    atualizarContadorEmentas();
                } else if (sucessos > 0 && erros.length > 0) {
                    mostrarToast(`⚠ ${sucessos} salvos, ${erros.length} erro(s)`, 'aviso');
                } else if (sucessos === 0 && erros.length > 0) {
                    mostrarToast(`✗ Erro ao processar lote`, 'erro');
                }

                // Atualizar total de precedentes
                if (sucessos > 0) {
                    atualizarTotalPrecedentes();
                }

            } catch (e) {
                console.error('Erro:', e);
                mostrarErroApi('Erro de conexão ao processar lote: ' + e.message, 'conexao', false);
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7"></rect><rect x="14" y="3" width="7" height="7"></rect><rect x="14" y="14" width="7" height="7"></rect><rect x="3" y="14" width="7" height="7"></rect></svg> Processar em Lote';
            }
        }

        // Carregar precedentes recentes
        async function carregarPrecedentesRecentes() {
            try {
                const res = await fetch('/api/banco-precedentes/listar');
                const data = await res.json();
                const precedentes = data.precedentes || [];

                // Pegar apenas os 5 mais recentes
                const recentes = precedentes.slice(0, 5);

                const listaRecentes = document.getElementById('lista-recentes');

                if (recentes.length === 0) {
                    listaRecentes.innerHTML = `
                        <div class="empty-state" style="padding: 20px;">
                            <p style="color: #666;">Nenhum precedente cadastrado ainda</p>
                            <button class="btn-action" onclick="trocarSubabaPrec('adicionar')" style="margin-top: 10px;">
                                ➕ Adicionar Primeiro Precedente
                            </button>
                        </div>
                    `;
                    return;
                }

                let html = '';
                recentes.forEach((prec, idx) => {
                    const metadata = prec.metadata || {};
                    const numero = metadata.numero_processo || 'Sem número';
                    const tema = metadata.tema_principal || 'Sem tema';
                    const area = metadata.area_direito || '';
                    const relator = metadata.relator || '';
                    const data_julg = metadata.data_julgamento || '';

                    html += `
                        <div onclick="abrirModalPrecedente('${prec.id}')" style="
                            background: white;
                            padding: 15px;
                            border-radius: 8px;
                            border: 1px solid #e2e8f0;
                            cursor: pointer;
                            transition: all 0.2s;
                            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
                        " onmouseover="this.style.borderColor='#805ad5'; this.style.boxShadow='0 4px 12px rgba(128,90,213,0.15)';"
                           onmouseout="this.style.borderColor='#e2e8f0'; this.style.boxShadow='0 1px 3px rgba(0,0,0,0.05)';">
                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                                <div style="flex: 1;">
                                    <div style="font-weight: 600; color: #2c5282; margin-bottom: 4px;">
                                        📄 ${numero}
                                    </div>
                                    <div style="display: flex; gap: 10px; flex-wrap: wrap; font-size: 0.85em;">
                                        <span style="color: #805ad5; font-weight: 500;">🏷️ ${tema}</span>
                                        ${area ? `<span style="color: #666;">⚖️ ${area}</span>` : ''}
                                    </div>
                                </div>
                            </div>
                            ${relator ? `<div style="font-size: 0.8em; color: #666; margin-top: 4px;">👤 ${relator}</div>` : ''}
                            ${data_julg ? `<div style="font-size: 0.8em; color: #666;">📅 ${data_julg}</div>` : ''}
                        </div>
                    `;
                });

                listaRecentes.innerHTML = html;

            } catch (e) {
                console.error('Erro ao carregar recentes:', e);
                document.getElementById('lista-recentes').innerHTML = `
                    <div class="empty-state" style="padding: 20px;">
                        <p style="color: #dc2626;">Erro ao carregar precedentes recentes</p>
                    </div>
                `;
            }
        }

        // Limpar filtros
        function limparFiltros() {
            document.getElementById('filtro-tema').value = '';
            document.getElementById('filtro-area').value = '';
            document.getElementById('busca-prec-input').value = '';

            // Mostrar precedentes recentes novamente
            document.getElementById('precedentes-recentes').style.display = 'block';
            document.getElementById('lista-precedentes').innerHTML = `
                <div class="empty-state">
                    <p>Faça uma busca ou clique em "Listar Todos"</p>
                    <button class="btn-action" onclick="listarTodosPrecedentes()">📋 Listar Todos</button>
                </div>
            `;
        }

        async function buscarPrecedentesBanco() {
            const query = document.getElementById('busca-prec-input').value.trim();
            const filtroTema = document.getElementById('filtro-tema').value;
            const filtroArea = document.getElementById('filtro-area').value;

            const filtros = {};
            if (filtroTema) filtros.tema = filtroTema;
            if (filtroArea) filtros.area = filtroArea;

            // Esconder precedentes recentes quando houver busca ativa
            if (query || filtroTema || filtroArea) {
                document.getElementById('precedentes-recentes').style.display = 'none';
            } else {
                document.getElementById('precedentes-recentes').style.display = 'block';
            }

            const lista = document.getElementById('lista-precedentes');
            lista.innerHTML = '<div class="empty-state"><p>🔍 Buscando...</p></div>';

            try {
                const res = await fetch('/api/banco-precedentes/buscar', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({query, filtros, limite: 50})
                });

                const data = await res.json();
                const resultados = data.resultados || [];

                // Mostrar contagem de resultados
                if (resultados.length > 0) {
                    mostrarToast(`${resultados.length} precedente(s) encontrado(s)`, 'info');
                }

                exibirListaPrecedentes(resultados);

            } catch (e) {
                console.error('Erro:', e);
                lista.innerHTML = '<div class="empty-state"><p>❌ Erro ao buscar.</p></div>';
            }
        }

        async function listarTodosPrecedentes() {
            // Esconder precedentes recentes
            document.getElementById('precedentes-recentes').style.display = 'none';

            const lista = document.getElementById('lista-precedentes');
            lista.innerHTML = '<div class="empty-state"><p>📋 Carregando...</p></div>';

            try {
                const res = await fetch('/api/banco-precedentes/listar');
                const data = await res.json();
                const precedentes = data.precedentes || [];

                mostrarToast(`${precedentes.length} precedente(s) no banco`, 'info');
                exibirListaPrecedentes(precedentes);

            } catch (e) {
                console.error('Erro:', e);
                lista.innerHTML = '<div class="empty-state"><p>❌ Erro ao carregar.</p></div>';
            }
        }

        function exibirListaPrecedentes(precedentes) {
            const lista = document.getElementById('lista-precedentes');

            if (!precedentes || precedentes.length === 0) {
                lista.innerHTML = '<div class="empty-state"><p>Nenhum precedente encontrado.</p></div>';
                return;
            }

            lista.innerHTML = precedentes.map(p => `
                <div class="prec-card" onclick="verPrecedente('${p.id}')">
                    <div class="prec-card-header">
                        <span class="prec-card-numero">${p.numero_processo || 'Sem numero'}</span>
                        <span class="prec-card-data">${p.data_julgamento || ''}</span>
                    </div>
                    ${p.tema_principal ? `<span class="prec-card-tema">${p.tema_principal}</span>` : ''}
                    <p class="prec-card-ementa">${p.ementa || ''}</p>
                    <div class="prec-card-footer">
                        ${(p.obices_aplicados || []).map(o => `<span class="prec-card-obice">${o}</span>`).join('')}
                        ${p.similaridade ? `<span class="prec-card-similaridade">${p.similaridade}% similar</span>` : ''}
                    </div>
                </div>
            `).join('');
        }

        async function verPrecedente(id) {
            try {
                const res = await fetch(`/api/banco-precedentes/${id}`);
                const data = await res.json();

                if (data.erro) {
                    alert('Erro: ' + data.erro);
                    return;
                }

                precedenteAtual = data.precedente;
                exibirPrecedenteModal(precedenteAtual);

            } catch (e) {
                console.error('Erro:', e);
                alert('Erro ao carregar precedente: ' + e.message);
            }
        }

        function exibirPrecedenteModal(p) {
            // Preencher dados do processo
            document.getElementById('prec-titulo').textContent = p.numero_processo || 'Precedente';
            document.getElementById('prec-numero').textContent = p.numero_processo || '-';
            document.getElementById('prec-tipo').textContent = p.tipo_recurso || '-';
            document.getElementById('prec-uf').textContent = p.uf || '-';
            document.getElementById('prec-relator').textContent = p.relator || '-';
            document.getElementById('prec-orgao').textContent = p.orgao_julgador || '-';
            document.getElementById('prec-data-julg').textContent = p.data_julgamento || '-';

            // Ementa
            document.getElementById('prec-ementa').textContent = p.ementa || 'Sem ementa disponível';

            // Tese (mostrar apenas se existir)
            const sectionTese = document.getElementById('section-tese');
            if (p.tese && p.tese.trim()) {
                sectionTese.style.display = 'block';
                document.getElementById('prec-tese').textContent = p.tese;
            } else {
                sectionTese.style.display = 'none';
            }

            // Classificação - Modo Visualização
            document.getElementById('prec-tema-view').textContent = p.tema_principal || 'Não classificado';
            document.getElementById('prec-area-view').textContent = p.area_direito || 'Não classificado';
            document.getElementById('prec-resultado-view').textContent = p.resultado || 'Não especificado';

            // Fonte da classificação
            const fonteMap = {
                'gemini': '🤖 IA (Gemini)',
                'cache': '💾 Cache',
                'manual': '✏️ Manual',
                'regras': '📋 Regras'
            };
            document.getElementById('prec-fonte-view').textContent = fonteMap[p.fonte_classificacao] || p.fonte_classificacao || '-';

            // Subtemas (badges)
            const divSubtemas = document.getElementById('prec-subtemas-view');
            const subtemas = Array.isArray(p.subtemas) ? p.subtemas : (p.subtemas ? [p.subtemas] : []);
            divSubtemas.innerHTML = subtemas.length > 0
                ? subtemas.map(s => `<span style="background: #e6f2ff; color: #2c5282; padding: 6px 12px; border-radius: 6px; font-size: 0.85em;">${s}</span>`).join('')
                : '<span style="color: #999; font-style: italic;">Nenhum subtema</span>';

            // Óbices (badges)
            const divObices = document.getElementById('prec-obices-view');
            const obices = Array.isArray(p.obices_aplicados) ? p.obices_aplicados : (p.obices_aplicados ? [p.obices_aplicados] : []);
            divObices.innerHTML = obices.length > 0
                ? obices.map(o => `<span style="background: #fff3cd; color: #856404; padding: 6px 12px; border-radius: 6px; font-size: 0.85em;">${o}</span>`).join('')
                : '<span style="color: #999; font-style: italic;">Nenhum óbice</span>';

            // Palavras-chave (badges)
            const divPalavras = document.getElementById('prec-palavras-view');
            const palavras = Array.isArray(p.palavras_chave) ? p.palavras_chave : (p.palavras_chave ? [p.palavras_chave] : []);
            divPalavras.innerHTML = palavras.length > 0
                ? palavras.map(pa => `<span style="background: #e2e8f0; color: #2d3748; padding: 6px 12px; border-radius: 6px; font-size: 0.85em;">${pa}</span>`).join('')
                : '<span style="color: #999; font-style: italic;">Nenhuma palavra-chave</span>';

            // Observação da IA
            const divObsIA = document.getElementById('div-observacao-ia');
            if (p.observacao_ia && p.observacao_ia.trim()) {
                divObsIA.style.display = 'block';
                document.getElementById('prec-observacao-view').textContent = p.observacao_ia;
            } else {
                divObsIA.style.display = 'none';
            }

            // Anotações pessoais
            const anotacoes = p.anotacoes_pessoais && p.anotacoes_pessoais.trim()
                ? p.anotacoes_pessoais
                : 'Nenhuma anotação adicionada';
            document.getElementById('prec-anotacoes-view').textContent = anotacoes;
            document.getElementById('prec-anotacoes-view').style.color = p.anotacoes_pessoais ? '#333' : '#999';

            // Garantir que está no modo visualização
            document.getElementById('section-classificacao-view').style.display = 'block';
            document.getElementById('section-anotacoes-view').style.display = 'block';
            document.getElementById('section-classificacao-edit').style.display = 'none';

            // Abrir modal
            document.getElementById('modal-precedente').classList.add('active');
        }

        function fecharModalPrecedente(event) {
            if (event && event.target !== event.currentTarget) return;
            document.getElementById('modal-precedente').classList.remove('active');
            precedenteAtual = null;
        }

        function ativarEdicaoClassificacao() {
            if (!precedenteAtual) return;

            const p = precedenteAtual;

            // Preencher campos de edição
            document.getElementById('prec-tema-edit').value = p.tema_principal || '';
            document.getElementById('prec-area-edit').value = p.area_direito || '';

            // Subtemas (converter array para string)
            const subtemas = Array.isArray(p.subtemas) ? p.subtemas.join(', ') : (p.subtemas || '');
            document.getElementById('prec-subtemas-edit').value = subtemas;

            // Palavras-chave (converter array para string)
            const palavras = Array.isArray(p.palavras_chave) ? p.palavras_chave.join(', ') : (p.palavras_chave || '');
            document.getElementById('prec-palavras-edit').value = palavras;

            // Anotações
            document.getElementById('prec-anotacoes-edit').value = p.anotacoes_pessoais || '';

            // Trocar para modo edição
            document.getElementById('section-classificacao-view').style.display = 'none';
            document.getElementById('section-anotacoes-view').style.display = 'none';
            document.getElementById('section-classificacao-edit').style.display = 'block';
        }

        function cancelarEdicaoClassificacao() {
            // Voltar para modo visualização
            document.getElementById('section-classificacao-view').style.display = 'block';
            document.getElementById('section-anotacoes-view').style.display = 'block';
            document.getElementById('section-classificacao-edit').style.display = 'none';
        }

        async function salvarClassificacao() {
            if (!precedenteAtual) return;

            try {
                // Coletar dados do formulário
                const tema = document.getElementById('prec-tema-edit').value.trim();
                const area = document.getElementById('prec-area-edit').value;
                const subtemasStr = document.getElementById('prec-subtemas-edit').value.trim();
                const palavrasStr = document.getElementById('prec-palavras-edit').value.trim();
                const anotacoes = document.getElementById('prec-anotacoes-edit').value.trim();

                // Converter strings para arrays
                const subtemas = subtemasStr ? subtemasStr.split(',').map(s => s.trim()).filter(s => s) : [];
                const palavras = palavrasStr ? palavrasStr.split(',').map(p => p.trim()).filter(p => p) : [];

                // Dados para atualizar
                const dadosAtualizacao = {
                    tema_principal: tema,
                    area_direito: area,
                    subtemas: subtemas,
                    palavras_chave: palavras,
                    anotacoes_pessoais: anotacoes
                };

                // Enviar atualização
                const res = await fetch(`/api/banco-precedentes/${precedenteAtual.id}/atualizar`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(dadosAtualizacao)
                });

                const data = await res.json();

                if (data.sucesso) {
                    // Atualizar objeto local
                    precedenteAtual.tema_principal = tema;
                    precedenteAtual.area_direito = area;
                    precedenteAtual.subtemas = subtemas;
                    precedenteAtual.palavras_chave = palavras;
                    precedenteAtual.anotacoes_pessoais = anotacoes;
                    precedenteAtual.fonte_classificacao = 'manual';

                    // Reexibir no modo visualização
                    exibirPrecedenteModal(precedenteAtual);

                    // Recarregar lista se estiver visível
                    if (document.getElementById('lista-precedentes').innerHTML) {
                        listarTodosPrecedentes();
                    }

                    alert('✅ Classificação atualizada com sucesso!');
                } else {
                    alert('Erro ao salvar: ' + (data.erro || 'Erro desconhecido'));
                }

            } catch (e) {
                console.error('Erro:', e);
                alert('Erro ao salvar classificação: ' + e.message);
            }
        }

        async function reclassificarComIA() {
            if (!precedenteAtual) return;

            const btn = document.getElementById('btn-reclassificar-ia');
            const textoOriginal = btn.textContent;

            try {
                btn.disabled = true;
                btn.textContent = '🔄 Classificando...';

                const res = await fetch('/api/banco-precedentes/classificar', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        ementa: precedenteAtual.ementa,
                        tese: precedenteAtual.tese
                    })
                });

                const data = await res.json();

                if (data.sucesso) {
                    const classif = data.classificacao;

                    // Preencher campos com resultado da IA
                    document.getElementById('prec-tema-edit').value = classif.tema_principal || '';
                    document.getElementById('prec-area-edit').value = classif.area_direito || '';
                    document.getElementById('prec-subtemas-edit').value = (classif.subtemas || []).join(', ');
                    document.getElementById('prec-palavras-edit').value = (classif.palavras_chave || []).join(', ');

                    alert('✅ Classificação obtida! Revise os campos e clique em "Salvar Alterações".');
                } else {
                    // Verificar se pode trocar chave
                    if (data.permite_trocar_chave) {
                        const trocar = confirm(`Erro: ${data.erro}\n\nDeseja atualizar a chave API do Gemini?`);
                        if (trocar) {
                            abrirConfigGemini();
                        }
                    } else {
                        alert('Erro: ' + (data.erro || 'Erro ao classificar'));
                    }
                }

            } catch (e) {
                console.error('Erro:', e);
                alert('Erro ao classificar: ' + e.message);
            } finally {
                btn.disabled = false;
                btn.textContent = textoOriginal;
            }
        }

        async function excluirPrecedente() {
            if (!precedenteAtual) return;

            const confirmar = confirm(`Tem certeza que deseja excluir o precedente:\n\n${precedenteAtual.numero_processo}?\n\nEsta ação não pode ser desfeita.`);
            if (!confirmar) return;

            try {
                const res = await fetch(`/api/banco-precedentes/${precedenteAtual.id}/excluir`, {
                    method: 'POST'
                });

                const data = await res.json();

                if (data.sucesso) {
                    alert('✅ Precedente excluído com sucesso!');
                    fecharModalPrecedente();

                    // Recarregar lista
                    listarTodosPrecedentes();
                    carregarEstatisticasPrec();
                } else {
                    alert('Erro ao excluir: ' + (data.erro || 'Erro desconhecido'));
                }

            } catch (e) {
                console.error('Erro:', e);
                alert('Erro ao excluir precedente: ' + e.message);
            }
        }

        async function carregarEstatisticasPrec() {
            const container = document.getElementById('stats-precedentes');

            try {
                const res = await fetch('/api/banco-precedentes/estatisticas');
                const data = await res.json();
                const stats = data.estatisticas;

                if (!stats || stats.total === 0) {
                    container.innerHTML = '<div class="empty-state"><p>Nenhum precedente cadastrado ainda.</p></div>';
                    return;
                }

                // Ordenar estatísticas por contagem
                const ordenarObj = obj => Object.entries(obj || {}).sort((a, b) => b[1] - a[1]);

                container.innerHTML = `
                    <div class="stats-prec-card">
                        <h5>Total de Precedentes</h5>
                        <div class="stat-value">${stats.total}</div>
                    </div>

                    <div class="stats-prec-card">
                        <h5>Por Tema</h5>
                        <div class="stats-prec-lista">
                            ${ordenarObj(stats.por_tema).slice(0, 5).map(([k, v]) =>
                                `<div class="stats-prec-item"><span>${k}</span><strong>${v}</strong></div>`
                            ).join('')}
                        </div>
                    </div>

                    <div class="stats-prec-card">
                        <h5>Por Area</h5>
                        <div class="stats-prec-lista">
                            ${ordenarObj(stats.por_area).slice(0, 5).map(([k, v]) =>
                                `<div class="stats-prec-item"><span>${k}</span><strong>${v}</strong></div>`
                            ).join('')}
                        </div>
                    </div>

                    <div class="stats-prec-card">
                        <h5>Por Obice</h5>
                        <div class="stats-prec-lista">
                            ${ordenarObj(stats.por_obice).slice(0, 5).map(([k, v]) =>
                                `<div class="stats-prec-item"><span>${k}</span><strong>${v}</strong></div>`
                            ).join('')}
                        </div>
                    </div>
                `;

                // Atualizar filtros na aba de consulta
                const selectTema = document.getElementById('filtro-tema');
                const selectArea = document.getElementById('filtro-area');

                selectTema.innerHTML = '<option value="">Todos os temas</option>' +
                    Object.keys(stats.por_tema || {}).map(t => `<option value="${t}">${t}</option>`).join('');

                selectArea.innerHTML = '<option value="">Todas as areas</option>' +
                    Object.keys(stats.por_area || {}).map(a => `<option value="${a}">${a}</option>`).join('');

            } catch (e) {
                console.error('Erro:', e);
                container.innerHTML = '<div class="empty-state"><p>Erro ao carregar estatisticas.</p></div>';
            }
        }

        // ============================================================
        // CONFIGURAÇÃO DE IA - GERENCIAMENTO DE PROMPTS
        // ============================================================

        function abrirSubTabIA(subtab) {
            // Desativar todos os botões
            document.querySelectorAll('.subtab-btn').forEach(btn => {
                btn.style.background = 'white';
                btn.style.color = '#333';
                btn.style.borderColor = '#e2e8f0';
            });

            // Ativar botão atual
            document.getElementById(`subtab-ia-${subtab}`).style.background = '#4299e1';
            document.getElementById(`subtab-ia-${subtab}`).style.color = 'white';
            document.getElementById(`subtab-ia-${subtab}`).style.borderColor = '#4299e1';

            // Esconder todos os painéis
            document.querySelectorAll('.painel-subtab-ia').forEach(p => p.style.display = 'none');

            // Mostrar painel atual
            document.getElementById(`painel-ia-${subtab}`).style.display = 'block';

            // Carregar dados conforme necessário
            if (subtab === 'prompt') {
                carregarPromptAtual();
            } else if (subtab === 'config') {
                carregarConfigIA();
            } else if (subtab === 'versoes') {
                carregarVersoesPrompt();
            } else if (subtab === 'exemplos') {
                carregarExemplosAprendizado();
            }
        }

        async function carregarPromptAtual() {
            try {
                const res = await fetch('/api/prompts/atual');
                const data = await res.json();

                if (data.sucesso) {
                    document.getElementById('editor-prompt').value = data.prompt;

                    document.getElementById('info-prompt').innerHTML = `
                        <strong>Prompt ativo</strong><br>
                        • Exemplos few-shot incluídos: ${data.exemplos_fewshot}<br>
                        • Temperatura: ${data.temperatura}<br>
                        • Este prompt será usado na próxima classificação
                    `;
                } else {
                    alert('Erro ao carregar prompt: ' + (data.erro || 'Desconhecido'));
                }
            } catch (e) {
                console.error('Erro:', e);
                alert('Erro ao carregar prompt: ' + e.message);
            }
        }

        async function carregarConfigIA() {
            try {
                const res = await fetch('/api/prompts/config');
                const data = await res.json();

                if (data.sucesso) {
                    const config = data.config;
                    const stats = data.estatisticas;

                    // Preencher formulário
                    document.getElementById('config-temperatura').value = config.temperatura || 0.3;
                    document.getElementById('label-temperatura').textContent = config.temperatura || 0.3;
                    document.getElementById('config-max-exemplos').value = config.max_exemplos_fewshot || 3;
                    document.getElementById('config-usar-fewshot').checked = config.usar_fewshot !== false;
                    document.getElementById('config-aprendizado-ativo').checked = config.aprendizado_ativo !== false;

                    // Exibir estatísticas
                    const divStats = document.getElementById('estatisticas-ia');
                    divStats.innerHTML = `
                        <div style="background: #e6f2ff; padding: 15px; border-radius: 8px; text-align: center;">
                            <div style="font-size: 2em; font-weight: 600; color: #4299e1;">${stats.total_exemplos}</div>
                            <div style="font-size: 0.85em; color: #666;">Exemplos de Aprendizado</div>
                        </div>
                        <div style="background: #f0f4f8; padding: 15px; border-radius: 8px; text-align: center;">
                            <div style="font-size: 2em; font-weight: 600; color: #2c5282;">${stats.versoes_salvas}</div>
                            <div style="font-size: 0.85em; color: #666;">Versões Salvas</div>
                        </div>
                        <div style="background: ${stats.aprendizado_ativo ? '#d4edda' : '#f8d7da'}; padding: 15px; border-radius: 8px; text-align: center;">
                            <div style="font-size: 1.5em; font-weight: 600; color: ${stats.aprendizado_ativo ? '#155724' : '#721c24'};">
                                ${stats.aprendizado_ativo ? '✓ Ativo' : '✗ Desativado'}
                            </div>
                            <div style="font-size: 0.85em; color: #666;">Aprendizado Automático</div>
                        </div>
                    `;
                }
            } catch (e) {
                console.error('Erro:', e);
            }
        }

        async function salvarConfigIA() {
            try {
                const config = {
                    temperatura: parseFloat(document.getElementById('config-temperatura').value),
                    max_exemplos_fewshot: parseInt(document.getElementById('config-max-exemplos').value),
                    usar_fewshot: document.getElementById('config-usar-fewshot').checked,
                    aprendizado_ativo: document.getElementById('config-aprendizado-ativo').checked
                };

                const res = await fetch('/api/prompts/config', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(config)
                });

                const data = await res.json();

                if (data.sucesso) {
                    alert('✅ Configuração salva com sucesso!');
                    carregarConfigIA();
                } else {
                    alert('Erro ao salvar: ' + (data.erro || 'Desconhecido'));
                }
            } catch (e) {
                console.error('Erro:', e);
                alert('Erro ao salvar configuração: ' + e.message);
            }
        }

        function atualizarLabelTemperatura(valor) {
            document.getElementById('label-temperatura').textContent = valor;
        }

        async function salvarNovaVersaoPrompt() {
            const nomeVersao = prompt('Nome da versão (ex: v2.0, experimental_detalhado):');
            if (!nomeVersao) return;

            const descricao = prompt('Descrição das mudanças (opcional):') || '';

            const template = document.getElementById('editor-prompt').value;

            try {
                const res = await fetch('/api/prompts/salvar', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        nome_versao: nomeVersao,
                        template: template,
                        descricao: descricao
                    })
                });

                const data = await res.json();

                if (data.sucesso) {
                    alert(`✅ Versão "${nomeVersao}" salva com sucesso!\n\nArquivo: ${data.arquivo}`);
                    carregarVersoesPrompt();
                } else {
                    alert('Erro ao salvar: ' + (data.erro || 'Desconhecido'));
                }
            } catch (e) {
                console.error('Erro:', e);
                alert('Erro ao salvar versão: ' + e.message);
            }
        }

        function copiarPrompt() {
            const texto = document.getElementById('editor-prompt').value;
            navigator.clipboard.writeText(texto).then(() => {
                alert('✅ Prompt copiado para área de transferência!');
            });
        }

        async function carregarVersoesPrompt() {
            try {
                const res = await fetch('/api/prompts/versoes');
                const data = await res.json();

                if (data.sucesso) {
                    const lista = document.getElementById('lista-versoes');

                    if (data.versoes.length === 0) {
                        lista.innerHTML = '<div style="text-align: center; color: #999; padding: 40px;">Nenhuma versão salva ainda</div>';
                        return;
                    }

                    lista.innerHTML = data.versoes.map(v => `
                        <div style="background: ${v.ativo ? '#e6f2ff' : '#f8f9fa'}; padding: 15px; border-radius: 8px; border-left: 4px solid ${v.ativo ? '#4299e1' : '#cbd5e0'};">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div style="flex: 1;">
                                    <div style="font-weight: 600; color: #2c5282; margin-bottom: 5px;">
                                        ${v.nome} ${v.ativo ? '<span style="background: #48bb78; color: white; padding: 3px 8px; border-radius: 4px; font-size: 0.75em; margin-left: 8px;">ATIVO</span>' : ''}
                                    </div>
                                    <div style="font-size: 0.85em; color: #666; margin-bottom: 5px;">${v.descricao || 'Sem descrição'}</div>
                                    <div style="font-size: 0.75em; color: #999;">Criado em: ${new Date(v.data_criacao).toLocaleString('pt-BR')}</div>
                                </div>
                                <div style="display: flex; gap: 8px;">
                                    ${!v.ativo ? `<button onclick="ativarVersaoPrompt('${v.nome}')" style="padding: 8px 16px; background: #4299e1; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 0.9em;">Ativar</button>` : ''}
                                    <button onclick="verDetalhesVersao('${v.arquivo}')" style="padding: 8px 16px; background: #718096; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 0.9em;">Ver Detalhes</button>
                                </div>
                            </div>
                        </div>
                    `).join('');
                }
            } catch (e) {
                console.error('Erro:', e);
            }
        }

        async function ativarVersaoPrompt(nomeVersao) {
            if (!confirm(`Ativar versão "${nomeVersao}"?\n\nEsta será a versão usada nas próximas classificações.`)) return;

            try {
                const res = await fetch(`/api/prompts/ativar/${nomeVersao}`, {
                    method: 'POST'
                });

                const data = await res.json();

                if (data.sucesso) {
                    alert(`✅ Versão "${nomeVersao}" ativada com sucesso!`);
                    carregarVersoesPrompt();
                } else {
                    alert('Erro ao ativar: ' + (data.erro || 'Desconhecido'));
                }
            } catch (e) {
                console.error('Erro:', e);
                alert('Erro ao ativar versão: ' + e.message);
            }
        }

        async function verDetalhesVersao(nomeArquivo) {
            try {
                const res = await fetch(`/api/prompts/versoes/${nomeArquivo}`);
                const data = await res.json();

                if (data.sucesso) {
                    const v = data.versao;
                    alert(`Versão: ${v.nome}\n\nDescrição: ${v.descricao || 'Sem descrição'}\n\nCriado em: ${new Date(v.data_criacao).toLocaleString('pt-BR')}\n\nTemperatura: ${v.config?.temperatura || 'N/A'}\n\nArquivo: ${nomeArquivo}\n\n(Abra o arquivo para ver o template completo)`);
                }
            } catch (e) {
                console.error('Erro:', e);
            }
        }

        async function carregarExemplosAprendizado() {
            try {
                const res = await fetch('/api/prompts/exemplos');
                const data = await res.json();

                if (data.sucesso) {
                    const lista = document.getElementById('lista-exemplos');

                    if (data.total === 0) {
                        lista.innerHTML = '<div style="text-align: center; color: #999; padding: 40px;">Nenhum exemplo coletado ainda. Classifique precedentes manualmente para adicionar exemplos.</div>';
                        return;
                    }

                    lista.innerHTML = data.exemplos.map((ex, i) => `
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; border-left: 4px solid ${ex.fonte === 'manual' ? '#48bb78' : '#cbd5e0'};">
                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                                <div style="font-weight: 600; color: #2c5282;">
                                    Exemplo ${i + 1} - ${ex.classificacao.area_direito}
                                </div>
                                <span style="background: ${ex.fonte === 'manual' ? '#48bb78' : '#718096'}; color: white; padding: 3px 8px; border-radius: 4px; font-size: 0.75em;">
                                    ${ex.fonte === 'manual' ? '✏️ Manual' : '📋 Padrão'}
                                </span>
                            </div>
                            <div style="font-size: 0.85em; color: #666; margin-bottom: 10px; font-style: italic;">
                                "${ex.ementa.substring(0, 200)}..."
                            </div>
                            <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                                <span style="background: #e6f2ff; color: #2c5282; padding: 4px 10px; border-radius: 4px; font-size: 0.8em;">
                                    <strong>Tema:</strong> ${ex.classificacao.tema_principal}
                                </span>
                                ${(ex.classificacao.subtemas || []).map(s => `
                                    <span style="background: #fff3cd; color: #856404; padding: 4px 10px; border-radius: 4px; font-size: 0.8em;">${s}</span>
                                `).join('')}
                            </div>
                            ${ex.data_adicao ? `<div style="font-size: 0.75em; color: #999; margin-top: 8px;">Adicionado em: ${new Date(ex.data_adicao).toLocaleString('pt-BR')}</div>` : ''}
                        </div>
                    `).join('');
                }
            } catch (e) {
                console.error('Erro:', e);
            }
        }

        // ============================================================
        // COMPARACAO LADO A LADO
        // ============================================================

        async function abrirComparacao(minutaId) {
            if (!textoRecursoAtual) {
                alert('Primeiro analise um recurso para poder comparar.');
                return;
            }

            document.getElementById('modal-comparacao').classList.add('active');
            document.getElementById('comparacao-recurso').textContent = 'Carregando...';
            document.getElementById('comparacao-minuta').textContent = 'Carregando...';

            try {
                const res = await fetch('/api/comparar-lado-a-lado', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        texto_recurso: textoRecursoAtual,
                        minuta_id: minutaId
                    })
                });

                const data = await res.json();

                if (data.erro) {
                    alert('Erro: ' + data.erro);
                    fecharComparacao();
                    return;
                }

                dadosComparacaoAtual = data;

                // Exibir recurso
                document.getElementById('comparacao-recurso').textContent = data.recurso.texto;

                // Exibir minuta
                document.getElementById('comparacao-minuta-nome').textContent = data.minuta.arquivo;
                document.getElementById('comparacao-minuta').textContent = data.minuta.conteudo_completo;

                // Termos em comum
                if (data.termos_comuns && data.termos_comuns.length > 0) {
                    document.getElementById('termos-comuns-bar').style.display = 'block';
                    document.getElementById('termos-comuns-lista').innerHTML =
                        data.termos_comuns.map(t => `<span class="termo">${t}</span>`).join('');
                } else {
                    document.getElementById('termos-comuns-bar').style.display = 'none';
                }

                // Resetar abas
                document.querySelectorAll('.lado-tab').forEach(t => t.classList.remove('active'));
                document.querySelector('.lado-tab').classList.add('active');

            } catch (e) {
                console.error('Erro:', e);
                alert('Erro ao carregar comparacao');
                fecharComparacao();
            }
        }

        function trocarAbaComparacao(aba) {
            if (!dadosComparacaoAtual) return;

            // Atualizar visual das tabs
            document.querySelectorAll('.lado-tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');

            // Atualizar conteudo
            const estrutura = dadosComparacaoAtual.minuta.estrutura;
            let conteudo = '';

            switch(aba) {
                case 'ementa':
                    conteudo = estrutura.ementa || 'Ementa nao encontrada';
                    break;
                case 'voto':
                    conteudo = estrutura.voto || 'Voto nao encontrado';
                    break;
                default:
                    conteudo = dadosComparacaoAtual.minuta.conteudo_completo;
            }

            document.getElementById('comparacao-minuta').textContent = conteudo;
        }

        function fecharComparacao(event) {
            if (event && event.target !== event.currentTarget) return;
            document.getElementById('modal-comparacao').classList.remove('active');
            dadosComparacaoAtual = null;
        }

        // ============================================================
        // GOOGLE SHEETS - SINCRONIZACAO
        // ============================================================

        async function abrirPainelSheets() {
            document.getElementById('modal-sheets').classList.add('active');
            document.getElementById('sheets-status').innerHTML = '<p style="color: #666;">Verificando conexao...</p>';
            document.getElementById('sheets-resultado').style.display = 'none';

            try {
                const res = await fetch('/api/sheets/status');
                const data = await res.json();

                if (data.disponivel) {
                    document.getElementById('sheets-status').innerHTML = `
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <span style="color: #34a853; font-size: 1.5em;">&#10004;</span>
                            <div>
                                <strong style="color: #34a853;">Conectado</strong>
                                <p style="margin: 5px 0 0 0; color: #555;">${data.total_registros} registros em ${data.abas.length} abas</p>
                                <p style="margin: 3px 0 0 0; color: #888; font-size: 0.85em;">Abas: ${data.abas.join(', ')}</p>
                            </div>
                        </div>
                    `;
                } else {
                    document.getElementById('sheets-status').innerHTML = `
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <span style="color: #e53e3e; font-size: 1.5em;">&#10008;</span>
                            <div>
                                <strong style="color: #e53e3e;">Nao conectado</strong>
                                <p style="margin: 5px 0 0 0; color: #555;">${data.mensagem}</p>
                            </div>
                        </div>
                    `;
                }
            } catch (err) {
                document.getElementById('sheets-status').innerHTML = `
                    <div style="color: #e53e3e;">
                        <strong>Erro ao verificar conexao</strong>
                        <p>${err.message}</p>
                    </div>
                `;
            }
        }

        function fecharPainelSheets(event) {
            if (event && event.target !== event.currentTarget) return;
            document.getElementById('modal-sheets').classList.remove('active');
        }

        async function sincronizarSheets() {
            const btn = document.getElementById('btn-sincronizar');
            const resultado = document.getElementById('sheets-resultado');

            btn.disabled = true;
            btn.textContent = 'Sincronizando...';
            btn.style.background = '#888';

            resultado.style.display = 'block';
            resultado.style.background = '#fff3cd';
            resultado.innerHTML = '<p style="color: #856404;">Sincronizando dados da planilha... Isso pode levar alguns segundos.</p>';

            try {
                const res = await fetch('/api/sheets/sincronizar', { method: 'POST' });
                const data = await res.json();

                if (data.sucesso) {
                    resultado.style.background = '#d4edda';
                    resultado.innerHTML = `
                        <div style="color: #155724;">
                            <strong>&#10004; Sincronizacao concluida!</strong>
                            <ul style="margin: 10px 0 0 15px;">
                                <li>Total na planilha: ${data.estatisticas.total}</li>
                                <li>Minutas atualizadas: ${data.estatisticas.atualizados}</li>
                                <li>Nao encontradas: ${data.estatisticas.nao_encontrados}</li>
                                ${data.estatisticas.erros > 0 ? `<li style="color: #856404;">Erros: ${data.estatisticas.erros}</li>` : ''}
                            </ul>
                        </div>
                    `;
                } else {
                    resultado.style.background = '#f8d7da';
                    resultado.innerHTML = `<p style="color: #721c24;">Erro: ${data.erro}</p>`;
                }
            } catch (err) {
                resultado.style.background = '#f8d7da';
                resultado.innerHTML = `<p style="color: #721c24;">Erro: ${err.message}</p>`;
            }

            btn.disabled = false;
            btn.textContent = 'Sincronizar Agora';
            btn.style.background = '#34a853';
        }

        // Fechar comparacao com ESC
        document.addEventListener('keydown', e => {
            if (e.key === 'Escape') {
                if (document.getElementById('modal-precedente').classList.contains('active')) {
                    fecharModalPrecedente();
                } else if (document.getElementById('modal-sheets').classList.contains('active')) {
                    fecharPainelSheets();
                } else if (document.getElementById('modal-comparacao').classList.contains('active')) {
                    fecharComparacao();
                } else {
                    fecharModal();
                }
            }
        });
    </script>
</body>
</html>
